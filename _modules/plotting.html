<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>plotting &#8212; beat 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="../_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    
      <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto+Slab">
    
    
    <script type="text/javascript" src="../_static/jquery.gifplayer.js"></script>
    <link rel="stylesheet" type="text/css" href="../_static/gifplayer.css">
    <!-- Piwik -->
    <script type="text/javascript">
      var _paq = _paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//pyrocko.org/pwk/";
        _paq.push(['setTrackerUrl', u+'piwik.php']);
        _paq.push(['setSiteId', '1']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <noscript>
    <img src="https://pyrocko.org/pwk/piwik.php?idsite=1&rec=1" style="border:0" alt="" />
    </noscript>

  </head>
  <body>

    <div class="related">
      <h3>Navigation</h3>
        <ul>
          <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
          <li>
            <img src='https://pyrocko.org/_static/pyrocko.svg' class='pyrocko-button' onclick="window.location = 'https://pyrocko.org';">
          </li>
           &#187;
          <li>
              <a href="../index.html">beat 1.0 documentation</a> &#187;
          </li>
            <li><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
        </ul>
    </div>
    

  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for plotting</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pymc3</span> <span class="k">import</span> <span class="n">plots</span> <span class="k">as</span> <span class="n">pmp</span>
<span class="kn">from</span> <span class="nn">pymc3</span> <span class="k">import</span> <span class="n">quantiles</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">from</span> <span class="nn">beat</span> <span class="k">import</span> <span class="n">utility</span>
<span class="kn">from</span> <span class="nn">beat.models</span> <span class="k">import</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">load_stage</span>
<span class="kn">from</span> <span class="nn">beat.sampler.metropolis</span> <span class="k">import</span> <span class="n">get_trace_stats</span>
<span class="kn">from</span> <span class="nn">beat.heart</span> <span class="k">import</span> <span class="p">(</span><span class="n">init_seismic_targets</span><span class="p">,</span> <span class="n">init_geodetic_targets</span><span class="p">,</span>
                        <span class="n">physical_bounds</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">beat.config</span> <span class="k">import</span> <span class="n">ffi_mode_str</span><span class="p">,</span> <span class="n">geometry_mode_str</span><span class="p">,</span> <span class="n">dist_vars</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="k">import</span> <span class="n">Rectangle</span><span class="p">,</span> <span class="n">FancyArrow</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="k">import</span> <span class="n">PatchCollection</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_pdf</span> <span class="k">import</span> <span class="n">PdfPages</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">tick</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">kde</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">num</span>
<span class="kn">from</span> <span class="nn">pyrocko.guts</span> <span class="k">import</span> <span class="p">(</span><span class="n">Object</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span>
                          <span class="n">Bool</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">load</span><span class="p">,</span> <span class="n">StringChoice</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">util</span><span class="p">,</span> <span class="n">trace</span>
<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">cake_plot</span> <span class="k">as</span> <span class="n">cp</span>
<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">orthodrome</span> <span class="k">as</span> <span class="n">otd</span>

<span class="kn">from</span> <span class="nn">pyrocko.cake_plot</span> <span class="k">import</span> <span class="n">str_to_mpl_color</span> <span class="k">as</span> <span class="n">scolor</span>
<span class="kn">from</span> <span class="nn">pyrocko.cake_plot</span> <span class="k">import</span> <span class="n">light</span>
<span class="kn">from</span> <span class="nn">pyrocko.plot</span> <span class="k">import</span> <span class="n">beachball</span><span class="p">,</span> <span class="n">nice_value</span><span class="p">,</span> <span class="n">AutoScaler</span>

<span class="kn">import</span> <span class="nn">pyrocko.moment_tensor</span> <span class="k">as</span> <span class="nn">mt</span>
<span class="kn">from</span> <span class="nn">pyrocko.plot</span> <span class="k">import</span> <span class="n">mpl_papersize</span><span class="p">,</span> <span class="n">mpl_init</span><span class="p">,</span> <span class="n">mpl_graph_color</span><span class="p">,</span> <span class="n">mpl_margins</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;plotting&#39;</span><span class="p">)</span>

<span class="n">km</span> <span class="o">=</span> <span class="mf">1000.</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;PlotOptions&#39;</span><span class="p">,</span> <span class="s1">&#39;correlation_plot&#39;</span><span class="p">,</span> <span class="s1">&#39;correlation_plot_hist&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_result_point&#39;</span><span class="p">,</span> <span class="s1">&#39;seismic_fits&#39;</span><span class="p">,</span> <span class="s1">&#39;scene_fits&#39;</span><span class="p">,</span> <span class="s1">&#39;traceplot&#39;</span><span class="p">,</span>
    <span class="s1">&#39;select_transform&#39;</span><span class="p">,</span> <span class="s1">&#39;histplot_op&#39;</span><span class="p">]</span>

<span class="n">u_nm</span> <span class="o">=</span> <span class="s1">&#39;$[Nm]$&#39;</span>
<span class="n">u_km</span> <span class="o">=</span> <span class="s1">&#39;$[km]$&#39;</span>
<span class="n">u_km_s</span> <span class="o">=</span> <span class="s1">&#39;$[km/s]$&#39;</span>
<span class="n">u_deg</span> <span class="o">=</span> <span class="s1">&#39;$[^{\circ}]$&#39;</span>
<span class="n">u_deg_myr</span> <span class="o">=</span> <span class="s1">&#39;$[^{\circ} / myr]$&#39;</span>
<span class="n">u_m</span> <span class="o">=</span> <span class="s1">&#39;$[m]$&#39;</span>
<span class="n">u_v</span> <span class="o">=</span> <span class="s1">&#39;$[m^3]$&#39;</span>
<span class="n">u_s</span> <span class="o">=</span> <span class="s1">&#39;$[s]$&#39;</span>
<span class="n">u_rad</span> <span class="o">=</span> <span class="s1">&#39;$[rad]$&#39;</span>
<span class="n">u_hyp</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<span class="n">plot_units</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;east_shift&#39;</span><span class="p">:</span> <span class="n">u_km</span><span class="p">,</span>
    <span class="s1">&#39;north_shift&#39;</span><span class="p">:</span> <span class="n">u_km</span><span class="p">,</span>
    <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">u_km</span><span class="p">,</span>
    <span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="n">u_km</span><span class="p">,</span>
    <span class="s1">&#39;length&#39;</span><span class="p">:</span> <span class="n">u_km</span><span class="p">,</span>

    <span class="s1">&#39;dip&#39;</span><span class="p">:</span> <span class="n">u_deg</span><span class="p">,</span>
    <span class="s1">&#39;dip1&#39;</span><span class="p">:</span> <span class="n">u_deg</span><span class="p">,</span>
    <span class="s1">&#39;dip2&#39;</span><span class="p">:</span> <span class="n">u_deg</span><span class="p">,</span>
    <span class="s1">&#39;strike&#39;</span><span class="p">:</span> <span class="n">u_deg</span><span class="p">,</span>
    <span class="s1">&#39;strike1&#39;</span><span class="p">:</span> <span class="n">u_deg</span><span class="p">,</span>
    <span class="s1">&#39;strike2&#39;</span><span class="p">:</span> <span class="n">u_deg</span><span class="p">,</span>
    <span class="s1">&#39;rake&#39;</span><span class="p">:</span> <span class="n">u_deg</span><span class="p">,</span>
    <span class="s1">&#39;rake1&#39;</span><span class="p">:</span> <span class="n">u_deg</span><span class="p">,</span>
    <span class="s1">&#39;rake2&#39;</span><span class="p">:</span> <span class="n">u_deg</span><span class="p">,</span>
    <span class="s1">&#39;mix&#39;</span><span class="p">:</span> <span class="n">u_hyp</span><span class="p">,</span>

    <span class="s1">&#39;volume_change&#39;</span><span class="p">:</span> <span class="n">u_v</span><span class="p">,</span>
    <span class="s1">&#39;diameter&#39;</span><span class="p">:</span> <span class="n">u_km</span><span class="p">,</span>
    <span class="s1">&#39;slip&#39;</span><span class="p">:</span> <span class="n">u_m</span><span class="p">,</span>
    <span class="s1">&#39;azimuth&#39;</span><span class="p">:</span> <span class="n">u_deg</span><span class="p">,</span>
    <span class="s1">&#39;bl_azimuth&#39;</span><span class="p">:</span> <span class="n">u_deg</span><span class="p">,</span>
    <span class="s1">&#39;amplitude&#39;</span><span class="p">:</span> <span class="n">u_nm</span><span class="p">,</span>
    <span class="s1">&#39;bl_amplitude&#39;</span><span class="p">:</span> <span class="n">u_m</span><span class="p">,</span>
    <span class="s1">&#39;locking_depth&#39;</span><span class="p">:</span> <span class="n">u_km</span><span class="p">,</span>

    <span class="s1">&#39;nucleation_dip&#39;</span><span class="p">:</span> <span class="n">u_km</span><span class="p">,</span>
    <span class="s1">&#39;nucleation_strike&#39;</span><span class="p">:</span> <span class="n">u_km</span><span class="p">,</span>
    <span class="s1">&#39;nucleation_x&#39;</span><span class="p">:</span> <span class="n">u_hyp</span><span class="p">,</span>
    <span class="s1">&#39;nucleation_y&#39;</span><span class="p">:</span> <span class="n">u_hyp</span><span class="p">,</span>
    <span class="s1">&#39;time_shift&#39;</span><span class="p">:</span> <span class="n">u_s</span><span class="p">,</span>
    <span class="s1">&#39;uperp&#39;</span><span class="p">:</span> <span class="n">u_m</span><span class="p">,</span>
    <span class="s1">&#39;uparr&#39;</span><span class="p">:</span> <span class="n">u_m</span><span class="p">,</span>
    <span class="s1">&#39;durations&#39;</span><span class="p">:</span> <span class="n">u_s</span><span class="p">,</span>
    <span class="s1">&#39;velocities&#39;</span><span class="p">:</span> <span class="n">u_km_s</span><span class="p">,</span>

    <span class="s1">&#39;mnn&#39;</span><span class="p">:</span> <span class="n">u_nm</span><span class="p">,</span>
    <span class="s1">&#39;mee&#39;</span><span class="p">:</span> <span class="n">u_nm</span><span class="p">,</span>
    <span class="s1">&#39;mdd&#39;</span><span class="p">:</span> <span class="n">u_nm</span><span class="p">,</span>
    <span class="s1">&#39;mne&#39;</span><span class="p">:</span> <span class="n">u_nm</span><span class="p">,</span>
    <span class="s1">&#39;mnd&#39;</span><span class="p">:</span> <span class="n">u_nm</span><span class="p">,</span>
    <span class="s1">&#39;med&#39;</span><span class="p">:</span> <span class="n">u_nm</span><span class="p">,</span>
    <span class="s1">&#39;magnitude&#39;</span><span class="p">:</span> <span class="n">u_hyp</span><span class="p">,</span>

    <span class="s1">&#39;pole_lat&#39;</span><span class="p">:</span> <span class="n">u_deg</span><span class="p">,</span>
    <span class="s1">&#39;pole_lon&#39;</span><span class="p">:</span> <span class="n">u_deg</span><span class="p">,</span>
    <span class="s1">&#39;omega&#39;</span><span class="p">:</span> <span class="n">u_deg_myr</span><span class="p">,</span>

    <span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="n">u_rad</span><span class="p">,</span>
    <span class="s1">&#39;v&#39;</span><span class="p">:</span> <span class="n">u_rad</span><span class="p">,</span>
    <span class="s1">&#39;kappa&#39;</span><span class="p">:</span> <span class="n">u_rad</span><span class="p">,</span>
    <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">u_rad</span><span class="p">,</span>
    <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="n">u_hyp</span><span class="p">,</span>

    <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="n">u_km</span><span class="p">,</span>
    <span class="s1">&#39;delta_depth&#39;</span><span class="p">:</span> <span class="n">u_km</span><span class="p">,</span>
    <span class="s1">&#39;delta_time&#39;</span><span class="p">:</span> <span class="n">u_s</span><span class="p">,</span>
    <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">u_s</span><span class="p">,</span>
    <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">u_s</span><span class="p">,</span>
    <span class="s1">&#39;peak_ratio&#39;</span><span class="p">:</span> <span class="n">u_hyp</span><span class="p">,</span>
    <span class="s1">&#39;h_&#39;</span><span class="p">:</span> <span class="n">u_hyp</span><span class="p">,</span>
    <span class="s1">&#39;like&#39;</span><span class="p">:</span> <span class="n">u_hyp</span><span class="p">}</span>


<span class="n">plot_projections</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;latlon&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;individual&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">hypername</span><span class="p">(</span><span class="n">varname</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">plot_units</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">return</span> <span class="n">varname</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;h_&#39;</span>


<div class="viewcode-block" id="PlotOptions"><a class="viewcode-back" href="../api.html#plotting.PlotOptions">[docs]</a><span class="k">class</span> <span class="nc">PlotOptions</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="n">post_llk</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Which model to plot on the specified plot; Default: &quot;max&quot;;&#39;</span>
             <span class="s1">&#39; Options: &quot;max&quot;, &quot;min&quot;, &quot;mean&quot;, &quot;all&quot;&#39;</span><span class="p">)</span>
    <span class="n">plot_projection</span> <span class="o">=</span> <span class="n">StringChoice</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">plot_projections</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Projection to use for plotting geodetic data; options: &quot;latlon&quot;&#39;</span><span class="p">)</span>
    <span class="n">utm_zone</span> <span class="o">=</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Only relevant if plot_projection is &quot;utm&quot;&#39;</span><span class="p">)</span>
    <span class="n">load_stage</span> <span class="o">=</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Which stage to select for plotting&#39;</span><span class="p">)</span>
    <span class="n">figure_dir</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;figures&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of the output directory of plots&#39;</span><span class="p">)</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">Dict</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Reference point for example from a synthetic test.&#39;</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">outformat</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>
    <span class="n">dpi</span> <span class="o">=</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">force</span> <span class="o">=</span> <span class="n">Bool</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">varnames</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[],</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Names of variables to plot&#39;</span><span class="p">)</span>
    <span class="n">source_idxs</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Indexes to patches of slip distribution to draw marginals for&#39;</span><span class="p">)</span>
    <span class="n">nensemble</span> <span class="o">=</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of draws from the PPD to display fuzzy results.&#39;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">str_unit</span><span class="p">(</span><span class="n">quantity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return string representation of waveform unit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s1">&#39;displacement&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;$m$&#39;</span>
    <span class="k">elif</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s1">&#39;velocity&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;$m/s$&#39;</span>
    <span class="k">elif</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s1">&#39;acceleration&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;$m/s^2$&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Quantity </span><span class="si">%s</span><span class="s1"> not supported!&#39;</span> <span class="o">%</span> <span class="n">quantity</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">str_dist</span><span class="p">(</span><span class="n">dist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return string representation of distance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mf">10.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%g</span><span class="s1"> m&#39;</span> <span class="o">%</span> <span class="n">dist</span>
    <span class="k">elif</span> <span class="mf">10.</span> <span class="o">&lt;=</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">km</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.0f</span><span class="s1"> m&#39;</span> <span class="o">%</span> <span class="n">dist</span>
    <span class="k">elif</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">km</span> <span class="o">&lt;=</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mf">10.</span> <span class="o">*</span> <span class="n">km</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1"> km&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dist</span> <span class="o">/</span> <span class="n">km</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.0f</span><span class="s1"> km&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dist</span> <span class="o">/</span> <span class="n">km</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">str_duration</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert time to str representation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>

    <span class="n">t</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">60.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="n">t</span>
    <span class="k">elif</span> <span class="mf">60.0</span> <span class="o">&lt;=</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">3600.</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%M:%S min&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="mf">3600.</span> <span class="o">&lt;=</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="n">util</span><span class="o">.</span><span class="n">time_to_str</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%H:%M h&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%.1f</span><span class="s1"> d&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span> <span class="o">/</span> <span class="p">(</span><span class="mf">24.</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">kde2plot_op</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;extent&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">:</span><span class="n">grid</span><span class="p">,</span> <span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">:</span><span class="n">grid</span><span class="p">]</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">Y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">kde</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">kernel</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">Z</span><span class="p">),</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">kde2plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">kde2plot_op</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>


<span class="k">def</span> <span class="nf">spherical_kde_op</span><span class="p">(</span>
        <span class="n">lats0</span><span class="p">,</span> <span class="n">lons0</span><span class="p">,</span> <span class="n">lats</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lons</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">beat.models.distributions</span> <span class="k">import</span> <span class="n">vonmises_fisher</span><span class="p">,</span> <span class="n">vonmises_std</span>

    <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No sigma given, estimating VonMisesStd ...&#39;</span><span class="p">)</span>
        <span class="n">sigmahat</span> <span class="o">=</span> <span class="n">vonmises_std</span><span class="p">(</span><span class="n">lats</span><span class="o">=</span><span class="n">lats0</span><span class="p">,</span> <span class="n">lons</span><span class="o">=</span><span class="n">lons0</span><span class="p">)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.06</span> <span class="o">*</span> <span class="n">sigmahat</span> <span class="o">*</span> <span class="n">lats0</span><span class="o">.</span><span class="n">size</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.2</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;suggested sigma: </span><span class="si">%f</span><span class="s1">, sigmahat: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">sigmahat</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">lats</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lons</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lats_vec</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">90.</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lons_vec</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lons_vec</span><span class="p">,</span> <span class="n">lats_vec</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">lats</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">lons</span><span class="o">.</span><span class="n">size</span>

    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">cycles</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">mod_i</span><span class="p">(</span><span class="n">lats0</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rest</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Processing rest of spherical kde samples </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rest</span><span class="p">))</span>
        <span class="n">vmf</span> <span class="o">=</span> <span class="n">vonmises_fisher</span><span class="p">(</span>
            <span class="n">lats</span><span class="o">=</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="o">=</span><span class="n">lons</span><span class="p">,</span>
            <span class="n">lats0</span><span class="o">=</span><span class="n">lats0</span><span class="p">[</span><span class="o">-</span><span class="n">rest</span><span class="p">:],</span> <span class="n">lons0</span><span class="o">=</span><span class="n">lons0</span><span class="p">[</span><span class="o">-</span><span class="n">rest</span><span class="p">:],</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">kde</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">vmf</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>   <span class="c1"># , b=self.weights)</span>
            <span class="p">(</span><span class="n">grid_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">grid_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Init new spherical kde samples&#39;</span><span class="p">)</span>
        <span class="n">kde</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">grid_size</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing lune plot for </span><span class="si">%i</span><span class="s1"> samples ... &#39;</span> <span class="o">%</span> <span class="n">lats0</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cyc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cycles</span><span class="p">):</span>
        <span class="n">cyc_s</span> <span class="o">=</span> <span class="n">cyc</span> <span class="o">*</span> <span class="n">batch_size</span>
        <span class="n">cyc_e</span> <span class="o">=</span> <span class="n">cyc_s</span> <span class="o">+</span> <span class="n">batch_size</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Looping over spherical kde samples </span><span class="si">%i</span><span class="s1"> - </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cyc_s</span><span class="p">,</span> <span class="n">cyc_e</span><span class="p">))</span>

        <span class="n">vmf</span> <span class="o">=</span> <span class="n">vonmises_fisher</span><span class="p">(</span>
            <span class="n">lats</span><span class="o">=</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="o">=</span><span class="n">lons</span><span class="p">,</span>
            <span class="n">lats0</span><span class="o">=</span><span class="n">lats0</span><span class="p">[</span><span class="n">cyc_s</span><span class="p">:</span><span class="n">cyc_e</span><span class="p">],</span> <span class="n">lons0</span><span class="o">=</span><span class="n">lons0</span><span class="p">[</span><span class="n">cyc_s</span><span class="p">:</span><span class="n">cyc_e</span><span class="p">],</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">kde</span> <span class="o">+=</span> <span class="n">num</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">vmf</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">kde</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span>


<div class="viewcode-block" id="correlation_plot"><a class="viewcode-back" href="../api.html#plotting.correlation_plot">[docs]</a><span class="k">def</span> <span class="nf">correlation_plot</span><span class="p">(</span>
        <span class="n">mtrace</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">point_style</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">point_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="s1">&#39;8&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot 2d marginals (with kernel density estimation) showing the correlations</span>
<span class="sd">    of the model parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mtrace : :class:`pymc3.base.MutliTrace`</span>
<span class="sd">        Mutlitrace instance containing the sampling results</span>
<span class="sd">    varnames : list of variable names</span>
<span class="sd">        Variables to be plotted, if None all variable are plotted</span>
<span class="sd">    transform : callable</span>
<span class="sd">        Function to transform data (defaults to identity)</span>
<span class="sd">    figsize : figure size tuple</span>
<span class="sd">        If None, size is (12, num of variables * 2) inch</span>
<span class="sd">    cmap : matplotlib colormap</span>
<span class="sd">    grid : resolution of kernel density estimation</span>
<span class="sd">    point : dict</span>
<span class="sd">        Dictionary of variable name / value  to be overplotted as marker</span>
<span class="sd">        to the posteriors e.g. mean of posteriors, true values of a simulation</span>
<span class="sd">    point_style : str</span>
<span class="sd">        style of marker according to matplotlib conventions</span>
<span class="sd">    point_color : str or tuple of 3</span>
<span class="sd">        color according to matplotlib convention</span>
<span class="sd">    point_size : str</span>
<span class="sd">        marker size according to matplotlib conventions</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig : figure object</span>
<span class="sd">    axs : subplot axis handles</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">varnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="n">mtrace</span><span class="o">.</span><span class="n">varnames</span>

    <span class="n">nvar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">varnames</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a4&#39;</span><span class="p">,</span> <span class="s1">&#39;landscape&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
        <span class="n">sharey</span><span class="o">=</span><span class="s1">&#39;row&#39;</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="s1">&#39;col&#39;</span><span class="p">,</span>
        <span class="n">nrows</span><span class="o">=</span><span class="n">nvar</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">nvar</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span>
            <span class="n">mtrace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvar</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">varnames</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nvar</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">varnames</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">varnames</span><span class="p">[</span><span class="n">l</span><span class="p">]))</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">varnames</span><span class="p">[</span><span class="n">l</span><span class="p">]]</span>

            <span class="n">kde2plot</span><span class="p">(</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">point</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">point</span><span class="p">[</span><span class="n">varnames</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span> <span class="n">point</span><span class="p">[</span><span class="n">varnames</span><span class="p">[</span><span class="n">l</span><span class="p">]],</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">point_style</span><span class="p">,</span>
                    <span class="n">markersize</span><span class="o">=</span><span class="n">point_size</span><span class="p">)</span>

            <span class="n">axs</span><span class="p">[</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">varnames</span><span class="p">[</span><span class="n">l</span><span class="p">])</span>

        <span class="n">axs</span><span class="p">[</span><span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">varnames</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvar</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span></div>


<div class="viewcode-block" id="correlation_plot_hist"><a class="viewcode-back" href="../api.html#plotting.correlation_plot_hist">[docs]</a><span class="k">def</span> <span class="nf">correlation_plot_hist</span><span class="p">(</span>
        <span class="n">mtrace</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hist_color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">grid</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ntickmarks</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">point_style</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">point_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span>
        <span class="n">unify</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot 2d marginals (with kernel density estimation) showing the correlations</span>
<span class="sd">    of the model parameters. In the main diagonal is shown the parameter</span>
<span class="sd">    histograms.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mtrace : :class:`pymc3.base.MutliTrace`</span>
<span class="sd">        Mutlitrace instance containing the sampling results</span>
<span class="sd">    varnames : list of variable names</span>
<span class="sd">        Variables to be plotted, if None all variable are plotted</span>
<span class="sd">    transform : callable</span>
<span class="sd">        Function to transform data (defaults to identity)</span>
<span class="sd">    figsize : figure size tuple</span>
<span class="sd">        If None, size is (12, num of variables * 2) inch</span>
<span class="sd">    cmap : matplotlib colormap</span>
<span class="sd">    hist_color : str or tuple of 3</span>
<span class="sd">        color according to matplotlib convention</span>
<span class="sd">    grid : resolution of kernel density estimation</span>
<span class="sd">    chains : int or list of ints</span>
<span class="sd">        chain indexes to select from the trace</span>
<span class="sd">    ntickmarks : int</span>
<span class="sd">        number of ticks at the axis labels</span>
<span class="sd">    point : dict</span>
<span class="sd">        Dictionary of variable name / value  to be overplotted as marker</span>
<span class="sd">        to the posteriors e.g. mean of posteriors, true values of a simulation</span>
<span class="sd">    point_style : str</span>
<span class="sd">        style of marker according to matplotlib conventions</span>
<span class="sd">    point_color : str or tuple of 3</span>
<span class="sd">        color according to matplotlib convention</span>
<span class="sd">    point_size : str</span>
<span class="sd">        marker size according to matplotlib conventions</span>
<span class="sd">    unify: bool</span>
<span class="sd">        If true axis units that belong to one group e.g. [km] will</span>
<span class="sd">        have common axis increments</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig : figure object</span>
<span class="sd">    axs : subplot axis handles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">ntickmarks_max</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">label_pad</span> <span class="o">=</span> <span class="mi">25</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing correlation figure ...&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">varnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="n">mtrace</span><span class="o">.</span><span class="n">varnames</span>

    <span class="n">nvar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">varnames</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nvar</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a5&#39;</span><span class="p">,</span> <span class="s1">&#39;landscape&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a4&#39;</span><span class="p">,</span> <span class="s1">&#39;landscape&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nvar</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="n">nvar</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span>
            <span class="n">mtrace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span>
                <span class="n">var</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="n">chains</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="n">hist_ylims</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvar</span><span class="p">):</span>
        <span class="n">v_namea</span> <span class="o">=</span> <span class="n">varnames</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">v_namea</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">nvar</span><span class="p">):</span>
            <span class="n">v_nameb</span> <span class="o">=</span> <span class="n">varnames</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v_namea</span><span class="p">,</span> <span class="n">v_nameb</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">point</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v_namea</span> <span class="ow">in</span> <span class="n">point</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">reference</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="n">v_namea</span><span class="p">]</span>
                        <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                            <span class="n">x</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span>
                            <span class="n">lw</span><span class="o">=</span><span class="n">point_size</span> <span class="o">/</span> <span class="mf">4.</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">reference</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reference</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">histplot_op</span><span class="p">(</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">pmp</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">make_2d</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">tstd</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">reference</span><span class="p">)</span>

                <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">format_axes</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>
                <span class="n">xticks</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()</span>
                <span class="n">xlim</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
                <span class="n">hist_ylims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">v_nameb</span><span class="p">]</span>

                <span class="n">kde2plot</span><span class="p">(</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

                <span class="n">bmin</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">bmax</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">point</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v_namea</span> <span class="ow">and</span> <span class="n">v_nameb</span> <span class="ow">in</span> <span class="n">point</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                            <span class="n">point</span><span class="p">[</span><span class="n">v_namea</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="n">v_nameb</span><span class="p">],</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">point_color</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">point_style</span><span class="p">,</span>
                            <span class="n">markersize</span><span class="o">=</span><span class="n">point_size</span><span class="p">)</span>

                        <span class="n">bmin</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">bmin</span><span class="p">,</span> <span class="n">point</span><span class="p">[</span><span class="n">v_nameb</span><span class="p">])</span>
                        <span class="n">bmax</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">bmax</span><span class="p">,</span> <span class="n">point</span><span class="p">[</span><span class="n">v_nameb</span><span class="p">])</span>

                <span class="n">yticker</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="n">ntickmarks</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
                <span class="n">yax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span>
                <span class="n">yax</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">yticker</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="n">nvar</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>

            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
                    <span class="n">v_nameb</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">plot_units</span><span class="p">[</span><span class="n">hypername</span><span class="p">(</span><span class="n">v_nameb</span><span class="p">)],</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">utility</span><span class="o">.</span><span class="n">is_odd</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">label_pad</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([])</span>

            <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span>
                <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>    <span class="c1"># matplotlib version issue workaround</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span>
                    <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelrotation</span><span class="o">=</span><span class="mf">50.</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">utility</span><span class="o">.</span><span class="n">is_odd</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="n">label_pad</span><span class="p">)</span>

        <span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
            <span class="n">v_namea</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">plot_units</span><span class="p">[</span><span class="n">hypername</span><span class="p">(</span><span class="n">v_namea</span><span class="p">)],</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">unify</span><span class="p">:</span>
        <span class="n">varnames_repeat_x</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">var_reap</span> <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">varnames</span> <span class="k">for</span> <span class="n">var_reap</span> <span class="ow">in</span> <span class="p">(</span><span class="n">varname</span><span class="p">,)</span> <span class="o">*</span> <span class="n">nvar</span><span class="p">]</span>
        <span class="n">varnames_repeat_y</span> <span class="o">=</span> <span class="n">varnames</span> <span class="o">*</span> <span class="n">nvar</span>
        <span class="n">unitiesx</span> <span class="o">=</span> <span class="n">unify_tick_intervals</span><span class="p">(</span>
            <span class="n">axs</span><span class="p">,</span> <span class="n">varnames_repeat_x</span><span class="p">,</span> <span class="n">ntickmarks_max</span><span class="o">=</span><span class="n">ntickmarks_max</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">apply_unified_axis</span><span class="p">(</span>
            <span class="n">axs</span><span class="p">,</span> <span class="n">varnames_repeat_x</span><span class="p">,</span> <span class="n">unitiesx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
            <span class="n">ntickmarks_max</span><span class="o">=</span><span class="n">ntickmarks_max</span><span class="p">)</span>
        <span class="n">apply_unified_axis</span><span class="p">(</span>
            <span class="n">axs</span><span class="p">,</span> <span class="n">varnames_repeat_y</span><span class="p">,</span> <span class="n">unitiesx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">scale_factor</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
            <span class="n">ntickmarks_max</span><span class="o">=</span><span class="n">ntickmarks_max</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvar</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">unify</span><span class="p">:</span>
            <span class="c1"># reset histogram ylims after unify</span>
            <span class="n">axs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">hist_ylims</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span></div>


<span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">uwifg</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Very simple scatter plot of given IFG for fast inspections.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    point_size : int</span>
<span class="sd">        determines the size of the scatter plot points</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">uwifg</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span> <span class="n">uwifg</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span> <span class="n">point_size</span><span class="p">,</span> <span class="n">uwifg</span><span class="o">.</span><span class="n">displacement</span><span class="p">,</span>
        <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Displacements [m] </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">uwifg</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">plot_cov</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">target</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span> <span class="n">point_size</span><span class="p">,</span>
        <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">covariance</span><span class="o">.</span><span class="n">pred_v</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Prediction Covariance [m2] </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">plot_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Very simple plot of a matrix for fast inspections.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">plot_log_cov</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">cov_mat</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)),</span> <span class="n">mask</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<div class="viewcode-block" id="get_result_point"><a class="viewcode-back" href="../api.html#plotting.get_result_point">[docs]</a><span class="k">def</span> <span class="nf">get_result_point</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">point_llk</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return point of a given stage result.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stage : :class:`models.Stage`</span>
<span class="sd">    config : :class:`config.BEATConfig`</span>
<span class="sd">    point_llk : str</span>
<span class="sd">        with specified llk(max, mean, min).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">point_llk</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
        <span class="n">sampler_name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">sampler_config</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">sampler_name</span> <span class="o">==</span> <span class="s1">&#39;Metropolis&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stage</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                    <span class="s1">&#39;Loading Metropolis results requires&#39;</span>
                    <span class="s1">&#39; sampler parameters to be loaded!&#39;</span><span class="p">)</span>

            <span class="n">sc</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">sampler_config</span><span class="o">.</span><span class="n">parameters</span>
            <span class="n">pdict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_trace_stats</span><span class="p">(</span>
                <span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span><span class="p">,</span> <span class="n">stage</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">sc</span><span class="o">.</span><span class="n">burn</span><span class="p">,</span> <span class="n">sc</span><span class="o">.</span><span class="n">thin</span><span class="p">)</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">pdict</span><span class="p">[</span><span class="n">point_llk</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">sampler_name</span> <span class="o">==</span> <span class="s1">&#39;SMC&#39;</span> <span class="ow">or</span> <span class="n">sampler_name</span> <span class="o">==</span> <span class="s1">&#39;PT&#39;</span><span class="p">:</span>
            <span class="n">llk</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span>
                <span class="n">varname</span><span class="o">=</span><span class="s1">&#39;like&#39;</span><span class="p">,</span>
                <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">posterior_idxs</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">get_fit_indexes</span><span class="p">(</span><span class="n">llk</span><span class="p">)</span>

            <span class="n">point</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">posterior_idxs</span><span class="p">[</span><span class="n">point_llk</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;Sampler &quot;</span><span class="si">%s</span><span class="s1">&quot; is not supported!&#39;</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">sampler_config</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">point</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">point</span></div>


<span class="k">def</span> <span class="nf">plot_quadtree</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">colim</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot UnwrappedIFG displacements on the respective quadtree rectangle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rectangles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">E</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">sE</span><span class="p">,</span> <span class="n">sN</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">iter_leaves</span><span class="p">():</span>
        <span class="n">rectangles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Rectangle</span><span class="p">(</span>
                <span class="p">(</span><span class="n">E</span> <span class="o">/</span> <span class="n">km</span><span class="p">,</span> <span class="n">N</span> <span class="o">/</span> <span class="n">km</span><span class="p">),</span>
                <span class="n">width</span><span class="o">=</span><span class="n">sE</span> <span class="o">/</span> <span class="n">km</span><span class="p">,</span>
                <span class="n">height</span><span class="o">=</span><span class="n">sN</span> <span class="o">/</span> <span class="n">km</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>

    <span class="n">patch_col</span> <span class="o">=</span> <span class="n">PatchCollection</span><span class="p">(</span>
        <span class="n">rectangles</span><span class="p">,</span> <span class="n">match_original</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">patch_col</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="n">patch_col</span><span class="o">.</span><span class="n">set_clim</span><span class="p">((</span><span class="o">-</span><span class="n">colim</span><span class="p">,</span> <span class="n">colim</span><span class="p">))</span>

    <span class="n">E</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">east_shifts</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">north_shifts</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="n">km</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">E</span> <span class="o">+</span> <span class="n">target</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">sizeE</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">km</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">/</span> <span class="n">km</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="n">target</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">sizeN</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">km</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">patch_col</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">patch_col</span>


<span class="k">def</span> <span class="nf">plot_scene</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">scattersize</span><span class="p">,</span> <span class="n">colim</span><span class="p">,</span>
               <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;latlon&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;latlon&#39;</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">lons</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">lats</span>
    <span class="k">elif</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">quadtree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cmap&#39;</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">plot_quadtree</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">colim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">east_shifts</span> <span class="o">/</span> <span class="n">km</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">north_shifts</span> <span class="o">/</span> <span class="n">km</span>

    <span class="k">return</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">scattersize</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
        <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">colim</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">colim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">format_axes</span><span class="p">(</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">visible</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes box top, left and right.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">rm</span> <span class="ow">in</span> <span class="n">remove</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">rm</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="n">visible</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">linewidth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">rm</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="n">linewidth</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">scale_axes</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="k">import</span> <span class="n">ScalarFormatter</span>

    <span class="k">class</span> <span class="nc">FormatScaled</span><span class="p">(</span><span class="n">ScalarFormatter</span><span class="p">):</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{:,.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">value</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="n">axis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">FormatScaled</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">set_anchor</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">anchor</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
        <span class="n">source</span><span class="o">.</span><span class="n">anchor</span> <span class="o">=</span> <span class="n">anchor</span>


<span class="k">def</span> <span class="nf">gnss_fits</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">plot_options</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">automap</span>
    <span class="kn">from</span> <span class="nn">pyrocko.model</span> <span class="k">import</span> <span class="n">gnss</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">gmtpy</span><span class="o">.</span><span class="n">detect_gmt_installations</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">automap</span><span class="o">.</span><span class="n">gmtpy</span><span class="o">.</span><span class="n">GmtPyError</span><span class="p">(</span>
            <span class="s1">&#39;GMT needs to be installed for GNSS plot!&#39;</span><span class="p">)</span>

    <span class="n">gc</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">geodetic_config</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds_config</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="s1">&#39;GNSS&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;No GNSS data in configuration!&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Trying to load GNSS data from: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ds_config</span><span class="o">.</span><span class="n">datadir</span><span class="p">))</span>

    <span class="n">campaigns</span> <span class="o">=</span> <span class="n">ds_config</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">campaign</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">campaigns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s1">&#39;Did not fing GNSS data under </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ds_config</span><span class="o">.</span><span class="n">datadir</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">campaigns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Plotting for more than 1 GNSS dataset needs tp be implemented&#39;</span><span class="p">)</span>

    <span class="n">campaign</span> <span class="o">=</span> <span class="n">campaigns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;geodetic&#39;</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">mode</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">init_hierarchicals</span><span class="p">()</span>

    <span class="n">figsize</span> <span class="o">=</span> <span class="mf">20.</span>  <span class="c1"># size in cm</span>

    <span class="n">po</span> <span class="o">=</span> <span class="n">plot_options</span>

    <span class="n">composite</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">composites</span><span class="p">[</span><span class="n">datatype</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">sources</span>
        <span class="n">ref_sources</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;FFI gnss fit, using reference source ...&#39;</span><span class="p">)</span>
        <span class="n">ref_sources</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">reference_sources</span>
        <span class="n">set_anchor</span><span class="p">(</span><span class="n">ref_sources</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">fault</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">load_fault_geometry</span><span class="p">()</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">get_all_subfaults</span><span class="p">(</span>
            <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="n">composite</span><span class="o">.</span><span class="n">slip_varnames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">set_anchor</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">ffi_mode_str</span><span class="p">:</span>
            <span class="n">composite</span><span class="o">.</span><span class="n">point2sources</span><span class="p">(</span><span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">)</span>
            <span class="n">ref_sources</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">composite</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">get_result_point</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">assemble_results</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>

    <span class="n">dataset_to_result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">composite</span><span class="o">.</span><span class="n">datasets</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;GNSS&#39;</span><span class="p">:</span>
            <span class="n">dataset_to_result</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">plot_projection</span> <span class="o">==</span> <span class="s1">&#39;latlon&#39;</span><span class="p">:</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">event</span>
        <span class="n">locations</span> <span class="o">=</span> <span class="n">campaign</span><span class="o">.</span><span class="n">stations</span>  <span class="c1"># + [event]</span>
        <span class="c1"># print(locations)</span>
        <span class="c1"># lat, lon = otd.geographic_midpoint_locations(locations)</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">loc</span><span class="o">.</span><span class="n">effective_latlon</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">])</span>
        <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">coords</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">coords</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">po</span><span class="o">.</span><span class="n">plot_projection</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
        <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">otd</span><span class="o">.</span><span class="n">geographic_midpoint_locations</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">[</span><span class="n">source</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="n">cs</span><span class="o">=</span><span class="s1">&#39;latlon&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> projection not implemented!&#39;</span> <span class="o">%</span> <span class="n">po</span><span class="o">.</span><span class="n">plot_projection</span><span class="p">)</span>

    <span class="n">radius</span> <span class="o">=</span> <span class="n">otd</span><span class="o">.</span><span class="n">distance_accurate50m_numpy</span><span class="p">(</span>
        <span class="n">lat</span><span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">lon</span><span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
        <span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="n">radius</span> <span class="o">*=</span> <span class="mf">1.2</span>

    <span class="k">if</span> <span class="n">radius</span> <span class="o">&lt;</span> <span class="mf">30.</span> <span class="o">*</span> <span class="n">km</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Radius of GNSS campaign </span><span class="si">%s</span><span class="s1"> too small, defaulting&#39;</span>
            <span class="s1">&#39; to 30 km&#39;</span> <span class="o">%</span> <span class="n">campaign</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">km</span>

    <span class="n">model_camp</span> <span class="o">=</span> <span class="n">gnss</span><span class="o">.</span><span class="n">GNSSCampaign</span><span class="p">(</span>
        <span class="n">stations</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">campaign</span><span class="o">.</span><span class="n">stations</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">dataset_to_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">ista</span><span class="p">,</span> <span class="n">sta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_camp</span><span class="o">.</span><span class="n">stations</span><span class="p">):</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">component</span><span class="p">)</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">processed_syn</span><span class="p">[</span><span class="n">ista</span><span class="p">]</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="n">plot_component_flags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s1">&#39;east&#39;</span> <span class="ow">in</span> <span class="n">ds_config</span><span class="o">.</span><span class="n">components</span> <span class="ow">or</span> <span class="s1">&#39;north&#39;</span> <span class="ow">in</span> <span class="n">ds_config</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
        <span class="n">plot_component_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;up&#39;</span> <span class="ow">in</span> <span class="n">ds_config</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
        <span class="n">plot_component_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">vertical</span> <span class="ow">in</span> <span class="n">plot_component_flags</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">automap</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span>
            <span class="n">width</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
            <span class="n">lat</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
            <span class="n">lon</span><span class="o">=</span><span class="n">lon</span><span class="p">,</span>
            <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
            <span class="n">show_topo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">show_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">show_rivers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">color_wet</span><span class="o">=</span><span class="p">(</span><span class="mi">216</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">254</span><span class="p">),</span>
            <span class="n">color_dry</span><span class="o">=</span><span class="p">(</span><span class="mi">238</span><span class="p">,</span> <span class="mi">236</span><span class="p">,</span> <span class="mi">230</span><span class="p">))</span>

        <span class="n">all_stations</span> <span class="o">=</span> <span class="n">campaign</span><span class="o">.</span><span class="n">stations</span> <span class="o">+</span> <span class="n">model_camp</span><span class="o">.</span><span class="n">stations</span>
        <span class="n">offset_scale</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_stations</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">ista</span><span class="p">,</span> <span class="n">sta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_stations</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">sta</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">offset_scale</span><span class="p">[</span><span class="n">ista</span><span class="p">]</span> <span class="o">+=</span> <span class="n">comp</span><span class="o">.</span><span class="n">shift</span>

        <span class="n">offset_scale</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">offset_scale</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">campaign</span><span class="o">.</span><span class="n">stations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;More than 40 stations disabling station labels ..&#39;</span><span class="p">)</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">m</span><span class="o">.</span><span class="n">add_gnss_campaign</span><span class="p">(</span>
            <span class="n">campaign</span><span class="p">,</span>
            <span class="n">psxy_style</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
                <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="s1">&#39;0.8p,black&#39;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">offset_scale</span><span class="o">=</span><span class="n">offset_scale</span><span class="p">,</span>
            <span class="n">vertical</span><span class="o">=</span><span class="n">vertical</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>

        <span class="n">m</span><span class="o">.</span><span class="n">add_gnss_campaign</span><span class="p">(</span>
            <span class="n">model_camp</span><span class="p">,</span>
            <span class="n">psxy_style</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
                <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="s1">&#39;0.8p,red&#39;</span><span class="p">,</span>
                <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">offset_scale</span><span class="o">=</span><span class="n">offset_scale</span><span class="p">,</span>
            <span class="n">vertical</span><span class="o">=</span><span class="n">vertical</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">):</span>
            <span class="n">in_rows</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="n">cs</span><span class="o">=</span><span class="s1">&#39;lonlat&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">ffi_mode_str</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mpl_graph_color</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">color_str</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color_str</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>

            <span class="k">if</span> <span class="n">in_rows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>    <span class="c1"># finite source</span>
                <span class="n">m</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">psxy</span><span class="p">(</span>
                    <span class="n">in_rows</span><span class="o">=</span><span class="n">in_rows</span><span class="p">,</span>
                    <span class="n">L</span><span class="o">=</span><span class="s1">&#39;+p0.1p,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">color_str</span><span class="p">,</span>
                    <span class="n">W</span><span class="o">=</span><span class="s1">&#39;0.1p,black&#39;</span><span class="p">,</span>
                    <span class="n">G</span><span class="o">=</span><span class="n">color_str</span><span class="p">,</span>
                    <span class="n">t</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
                    <span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">jxyr</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">psxy</span><span class="p">(</span>
                    <span class="n">in_rows</span><span class="o">=</span><span class="n">in_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">W</span><span class="o">=</span><span class="s1">&#39;1p,black&#39;</span><span class="p">,</span>
                    <span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">jxyr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="c1"># point source</span>
                <span class="n">source_scale_factor</span> <span class="o">=</span> <span class="mf">2.</span>
                <span class="n">m</span><span class="o">.</span><span class="n">gmt</span><span class="o">.</span><span class="n">psxy</span><span class="p">(</span>
                    <span class="n">in_rows</span><span class="o">=</span><span class="n">in_rows</span><span class="p">,</span>
                    <span class="n">W</span><span class="o">=</span><span class="s1">&#39;0.1p,black&#39;</span><span class="p">,</span>
                    <span class="n">G</span><span class="o">=</span><span class="n">color_str</span><span class="p">,</span>
                    <span class="n">S</span><span class="o">=</span><span class="s1">&#39;c</span><span class="si">%f</span><span class="s1">p&#39;</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="n">source_scale_factor</span><span class="p">),</span>
                    <span class="n">t</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span>
                    <span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">jxyr</span><span class="p">)</span>

        <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">figs</span>


<span class="k">def</span> <span class="nf">map_displacement_grid</span><span class="p">(</span><span class="n">displacements</span><span class="p">,</span> <span class="n">scene</span><span class="p">):</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">displacement</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">qt</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span>

    <span class="k">for</span> <span class="n">syn_v</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">displacements</span><span class="p">,</span> <span class="n">qt</span><span class="o">.</span><span class="n">leaves</span><span class="p">):</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">_slice_rows</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">_slice_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">syn_v</span>

    <span class="n">arr</span><span class="p">[</span><span class="n">scene</span><span class="o">.</span><span class="n">displacement_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">arr</span>


<span class="k">def</span> <span class="nf">get_latlon_ratio</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get latlon ratio at given location </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dlat_meters</span> <span class="o">=</span> <span class="n">otd</span><span class="o">.</span><span class="n">distance_accurate50m</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span>
    <span class="n">dlon_meters</span> <span class="o">=</span> <span class="n">otd</span><span class="o">.</span><span class="n">distance_accurate50m</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dlat_meters</span> <span class="o">/</span> <span class="n">dlon_meters</span>


<div class="viewcode-block" id="scene_fits"><a class="viewcode-back" href="../api.html#plotting.scene_fits">[docs]</a><span class="k">def</span> <span class="nf">scene_fits</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">plot_options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot geodetic data, synthetics and residuals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pyrocko.dataset</span> <span class="k">import</span> <span class="n">gshhg</span>
    <span class="kn">from</span> <span class="nn">kite.scene</span> <span class="k">import</span> <span class="n">Scene</span><span class="p">,</span> <span class="n">UserIOWarning</span>
    <span class="kn">import</span> <span class="nn">gc</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">homepath</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">geodetic_config</span><span class="o">.</span><span class="n">types</span><span class="p">[</span><span class="s1">&#39;SAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">datadir</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SAR data not in geodetic types!&#39;</span><span class="p">)</span>

    <span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;geodetic&#39;</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">mode</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">init_hierarchicals</span><span class="p">()</span>

    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">fontsize_title</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="n">ndmax</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">nxmax</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span>

    <span class="n">po</span> <span class="o">=</span> <span class="n">plot_options</span>

    <span class="n">composite</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">composites</span><span class="p">[</span><span class="n">datatype</span><span class="p">]</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">event</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">sources</span>
        <span class="n">ref_sources</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;FFI scene fit, using reference source ...&#39;</span><span class="p">)</span>
        <span class="n">ref_sources</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">reference_sources</span>
        <span class="n">set_anchor</span><span class="p">(</span><span class="n">ref_sources</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="n">fault</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">load_fault_geometry</span><span class="p">()</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">get_all_subfaults</span><span class="p">(</span>
            <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="n">composite</span><span class="o">.</span><span class="n">slip_varnames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">set_anchor</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">ffi_mode_str</span><span class="p">:</span>
            <span class="n">composite</span><span class="o">.</span><span class="n">point2sources</span><span class="p">(</span><span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">)</span>
            <span class="n">ref_sources</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">composite</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">point</span> <span class="o">=</span> <span class="n">get_result_point</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">)</span>

    <span class="n">results_tmp</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">assemble_results</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
    <span class="n">dataset_to_result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">composite</span><span class="o">.</span><span class="n">datasets</span><span class="p">,</span> <span class="n">results_tmp</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;SAR&#39;</span><span class="p">:</span>
            <span class="n">dataset_to_result</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">dataset_to_result</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
    <span class="n">dataset_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset_to_result</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="n">nrmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset_to_result</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">fullfig</span><span class="p">,</span> <span class="n">restfig</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">mod_i</span><span class="p">(</span><span class="n">nrmax</span><span class="p">,</span> <span class="n">ndmax</span><span class="p">)</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">fullfig</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">restfig</span><span class="p">:</span>
        <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">restfig</span><span class="p">)</span> <span class="o">/</span> <span class="n">ndmax</span><span class="p">)</span>

    <span class="n">figures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a4&#39;</span><span class="p">,</span> <span class="s1">&#39;portrait&#39;</span><span class="p">))</span>
        <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">f</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ndmax</span> <span class="o">*</span> <span class="n">f</span><span class="p">)),</span> <span class="n">ncols</span><span class="o">=</span><span class="n">nxmax</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span>
            <span class="n">left</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span>
            <span class="n">right</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.03</span><span class="p">,</span>
            <span class="n">bottom</span><span class="o">=</span><span class="mf">0.06</span><span class="p">,</span>
            <span class="n">top</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.06</span><span class="p">,</span>
            <span class="n">wspace</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
            <span class="n">hspace</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">ax_a</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax_a</span><span class="p">)</span>

    <span class="n">nfigs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">axis_config</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">po</span><span class="p">):</span>

        <span class="n">latlon_ratio</span> <span class="o">=</span> <span class="n">get_latlon_ratio</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">plot_projection</span> <span class="o">==</span> <span class="s1">&#39;latlon&#39;</span><span class="p">:</span>
                <span class="n">ystr</span> <span class="o">=</span> <span class="s1">&#39;Latitude [deg]&#39;</span>
                <span class="n">xstr</span> <span class="o">=</span> <span class="s1">&#39;Longitude [deg]&#39;</span>
                <span class="k">if</span> <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">isDegree</span><span class="p">():</span>
                    <span class="n">scale_x</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">}</span>
                    <span class="n">scale_y</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">}</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="n">latlon_ratio</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scale_x</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">otd</span><span class="o">.</span><span class="n">m2d</span><span class="p">}</span>
                    <span class="n">scale_y</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">otd</span><span class="o">.</span><span class="n">m2d</span><span class="p">}</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

                <span class="n">scale_x</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">lon</span>
                <span class="n">scale_y</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">lat</span>

            <span class="k">elif</span> <span class="n">po</span><span class="o">.</span><span class="n">plot_projection</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                <span class="n">ystr</span> <span class="o">=</span> <span class="s1">&#39;Distance [km]&#39;</span>
                <span class="n">xstr</span> <span class="o">=</span> <span class="s1">&#39;Distance [km]&#39;</span>
                <span class="k">if</span> <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">isDegree</span><span class="p">():</span>
                    <span class="n">scale_x</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">otd</span><span class="o">.</span><span class="n">d2m</span> <span class="o">/</span> <span class="n">km</span> <span class="o">/</span> <span class="n">latlon_ratio</span><span class="p">}</span>
                    <span class="n">scale_y</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">otd</span><span class="o">.</span><span class="n">d2m</span> <span class="o">/</span> <span class="n">km</span><span class="p">}</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="n">latlon_ratio</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scale_x</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">km</span><span class="p">}</span>
                    <span class="n">scale_y</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">km</span><span class="p">}</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s1">&#39;Plot projection </span><span class="si">%s</span><span class="s1"> not available&#39;</span> <span class="o">%</span> <span class="n">po</span><span class="o">.</span><span class="n">plot_projection</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">tick</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">tick</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ystr</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xstr</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">scale_x</span> <span class="o">=</span> <span class="n">scale_x</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scale_y</span> <span class="o">=</span> <span class="n">scale_y</span>

            <span class="n">scale_axes</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">(),</span> <span class="o">**</span><span class="n">scale_x</span><span class="p">)</span>
            <span class="n">scale_axes</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">(),</span> <span class="o">**</span><span class="n">scale_y</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>

    <span class="k">def</span> <span class="nf">draw_coastlines</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">xlim</span><span class="p">,</span> <span class="n">ylim</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">po</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        xlim and ylim in Lon/Lat[deg]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Drawing coastlines ...&#39;</span><span class="p">)</span>
        <span class="n">coasts</span> <span class="o">=</span> <span class="n">gshhg</span><span class="o">.</span><span class="n">GSHHG</span><span class="o">.</span><span class="n">full</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">plot_projection</span> <span class="o">==</span> <span class="s1">&#39;latlon&#39;</span><span class="p">:</span>
            <span class="n">west</span><span class="p">,</span> <span class="n">east</span> <span class="o">=</span> <span class="n">xlim</span>
            <span class="n">south</span><span class="p">,</span> <span class="n">north</span> <span class="o">=</span> <span class="n">ylim</span>

        <span class="k">elif</span> <span class="n">po</span><span class="o">.</span><span class="n">plot_projection</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span> <span class="o">=</span> <span class="n">otd</span><span class="o">.</span><span class="n">ne_to_latlon</span><span class="p">(</span>
                <span class="n">event</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
                <span class="n">north_m</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span> <span class="n">east_m</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>
            <span class="n">south</span><span class="p">,</span> <span class="n">north</span> <span class="o">=</span> <span class="n">lats</span>
            <span class="n">west</span><span class="p">,</span> <span class="n">east</span> <span class="o">=</span> <span class="n">lons</span>

        <span class="n">polygons</span> <span class="o">=</span> <span class="n">coasts</span><span class="o">.</span><span class="n">get_polygons_within</span><span class="p">(</span>
            <span class="n">west</span><span class="o">=</span><span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="o">=</span><span class="n">east</span><span class="p">,</span> <span class="n">south</span><span class="o">=</span><span class="n">south</span><span class="p">,</span> <span class="n">north</span><span class="o">=</span><span class="n">north</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polygons</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_land</span><span class="p">()</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">is_antarctic_grounding_line</span><span class="p">()</span> <span class="ow">or</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">is_island_in_lake</span><span class="p">()):</span>

                <span class="k">if</span> <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">isMeter</span><span class="p">():</span>
                    <span class="n">ys</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">otd</span><span class="o">.</span><span class="n">latlon_to_ne_numpy</span><span class="p">(</span>
                        <span class="n">event</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">lons</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">isDegree</span><span class="p">():</span>

                    <span class="n">xs</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">lons</span> <span class="o">-</span> <span class="n">event</span><span class="o">.</span><span class="n">lon</span>
                    <span class="n">ys</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">lats</span> <span class="o">-</span> <span class="n">event</span><span class="o">.</span><span class="n">lat</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addArrow</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">scene</span><span class="p">):</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">los_dx</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">0625</span>
        <span class="n">los_dy</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">0625</span>

        <span class="n">az_dx</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">125</span>
        <span class="n">az_dy</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">125</span>

        <span class="n">anchor_x</span> <span class="o">=</span> <span class="o">.</span><span class="mi">9</span> <span class="k">if</span> <span class="n">los_dx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">.</span><span class="mi">1</span>
        <span class="n">anchor_y</span> <span class="o">=</span> <span class="o">.</span><span class="mi">85</span> <span class="k">if</span> <span class="n">los_dx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">.</span><span class="mi">975</span>

        <span class="n">az_arrow</span> <span class="o">=</span> <span class="n">FancyArrow</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">anchor_x</span> <span class="o">-</span> <span class="n">az_dx</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">anchor_y</span> <span class="o">-</span> <span class="n">az_dy</span><span class="p">,</span>
            <span class="n">dx</span><span class="o">=</span><span class="n">az_dx</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">az_dy</span><span class="p">,</span>
            <span class="n">head_width</span><span class="o">=.</span><span class="mi">025</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
            <span class="n">head_starts_at_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

        <span class="n">los_arrow</span> <span class="o">=</span> <span class="n">FancyArrow</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">anchor_x</span> <span class="o">-</span> <span class="n">az_dx</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">anchor_y</span> <span class="o">-</span> <span class="n">az_dy</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">dx</span><span class="o">=</span><span class="n">los_dx</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="n">los_dy</span><span class="p">,</span>
            <span class="n">head_width</span><span class="o">=.</span><span class="mi">02</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
            <span class="n">head_starts_at_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">az_arrow</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">los_arrow</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_leaves</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">offset_e</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset_n</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">rects</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">getMPLRectangles</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rects</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">((</span><span class="o">.</span><span class="mi">4</span><span class="p">,</span> <span class="o">.</span><span class="mi">4</span><span class="p">,</span> <span class="o">.</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">r</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="o">.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">set_x</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset_e</span><span class="p">)</span>
            <span class="n">r</span><span class="o">.</span><span class="n">set_y</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">get_y</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset_n</span><span class="p">)</span>
        <span class="nb">map</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">,</span> <span class="n">rects</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">leaf_coordinates</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset_e</span><span class="p">,</span>
                   <span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">leaf_coordinates</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset_n</span><span class="p">,</span>
                   <span class="n">s</span><span class="o">=.</span><span class="mi">25</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_sources</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">po</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">bgcolor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">source</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">isMeter</span><span class="p">():</span>
                <span class="n">fn</span><span class="p">,</span> <span class="n">fe</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="n">cs</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="k">elif</span> <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">isDegree</span><span class="p">():</span>
                <span class="n">fn</span><span class="p">,</span> <span class="n">fe</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">outline</span><span class="p">(</span><span class="n">cs</span><span class="o">=</span><span class="s1">&#39;latlon&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                <span class="n">fn</span> <span class="o">-=</span> <span class="n">event</span><span class="o">.</span><span class="n">lat</span>
                <span class="n">fe</span> <span class="o">-=</span> <span class="n">event</span><span class="o">.</span><span class="n">lon</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">bgcolor</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">mpl_graph_color</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">bgcolor</span>

            <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.4</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">fe</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span>
                    <span class="n">fe</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span>
                    <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                    <span class="n">facecolor</span><span class="o">=</span><span class="n">light</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">fn</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">fe</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">fn</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span>
                    <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cbtick</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mf">1000.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.</span>
        <span class="k">return</span> <span class="p">[</span><span class="o">-</span><span class="n">rx</span><span class="p">,</span> <span class="n">rx</span><span class="p">]</span>

    <span class="n">colims</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">([</span>
        <span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">processed_obs</span><span class="p">)),</span>
        <span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">processed_syn</span><span class="p">))])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
    <span class="n">dcolims</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">processed_res</span><span class="p">))</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>

    <span class="kn">import</span> <span class="nn">string</span>
    <span class="k">for</span> <span class="n">idata</span><span class="p">,</span> <span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset_to_result</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="n">subplot_letter</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">[</span><span class="n">idata</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">scene_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">homepath</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Loading full resolution kite scene: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">scene_path</span><span class="p">)</span>
            <span class="n">scene</span> <span class="o">=</span> <span class="n">Scene</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">scene_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UserIOWarning</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Full resolution data could not be loaded! Skipping ...&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">isMeter</span><span class="p">():</span>
            <span class="n">offset_n</span><span class="p">,</span> <span class="n">offset_e</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">otd</span><span class="o">.</span><span class="n">latlon_to_ne_numpy</span><span class="p">(</span>
                <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">llLat</span><span class="p">,</span> <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">llLon</span><span class="p">,</span>
                <span class="n">event</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">lon</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">isDegree</span><span class="p">():</span>
            <span class="n">offset_n</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">lat</span> <span class="o">-</span> <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">llLat</span>
            <span class="n">offset_e</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">lon</span> <span class="o">-</span> <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">llLon</span>

        <span class="n">im_extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset_e</span><span class="p">,</span>
                     <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset_e</span><span class="p">,</span>
                     <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset_n</span><span class="p">,</span>
                     <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset_n</span><span class="p">)</span>

        <span class="n">urE</span><span class="p">,</span> <span class="n">urN</span><span class="p">,</span> <span class="n">llE</span><span class="p">,</span> <span class="n">llN</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

        <span class="n">turE</span><span class="p">,</span> <span class="n">turN</span><span class="p">,</span> <span class="n">tllE</span><span class="p">,</span> <span class="n">tllN</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="o">*</span><span class="p">[(</span><span class="n">l</span><span class="o">.</span><span class="n">gridE</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset_e</span><span class="p">,</span>
               <span class="n">l</span><span class="o">.</span><span class="n">gridN</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset_n</span><span class="p">,</span>
               <span class="n">l</span><span class="o">.</span><span class="n">gridE</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset_e</span><span class="p">,</span>
               <span class="n">l</span><span class="o">.</span><span class="n">gridN</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">offset_n</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">leaves</span><span class="p">])</span>

        <span class="n">turE</span><span class="p">,</span> <span class="n">turN</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="p">(</span><span class="n">turE</span><span class="p">,</span> <span class="n">turN</span><span class="p">))</span>
        <span class="n">tllE</span><span class="p">,</span> <span class="n">tllN</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="p">(</span><span class="n">tllE</span><span class="p">,</span> <span class="n">tllN</span><span class="p">))</span>
        <span class="n">urE</span><span class="p">,</span> <span class="n">urN</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="p">((</span><span class="n">turE</span><span class="p">,</span> <span class="n">urE</span><span class="p">),</span> <span class="p">(</span><span class="n">urN</span><span class="p">,</span> <span class="n">turN</span><span class="p">)))</span>
        <span class="n">llE</span><span class="p">,</span> <span class="n">llN</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="p">((</span><span class="n">tllE</span><span class="p">,</span> <span class="n">llE</span><span class="p">),</span> <span class="p">(</span><span class="n">llN</span><span class="p">,</span> <span class="n">tllN</span><span class="p">)))</span>

        <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">otd</span><span class="o">.</span><span class="n">ne_to_latlon</span><span class="p">(</span>
            <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
            <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">llN</span><span class="p">,</span> <span class="n">urN</span><span class="p">]),</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">llE</span><span class="p">,</span> <span class="n">urE</span><span class="p">]))</span>

        <span class="c1"># result = dataset_to_result[dataset]</span>
        <span class="n">tidx</span> <span class="o">=</span> <span class="n">dataset_index</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span>

        <span class="n">figidx</span><span class="p">,</span> <span class="n">rowidx</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">mod_i</span><span class="p">(</span><span class="n">tidx</span><span class="p">,</span> <span class="n">ndmax</span><span class="p">)</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">figidx</span><span class="p">][</span><span class="n">rowidx</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">imgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">data_str</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="s1">&#39;syn&#39;</span><span class="p">,</span> <span class="s1">&#39;res&#39;</span><span class="p">]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plotting </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data_str</span><span class="p">)</span>
            <span class="n">datavec</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;processed_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data_str</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data_str</span> <span class="o">==</span> <span class="s1">&#39;res&#39;</span> <span class="ow">and</span> <span class="n">po</span><span class="o">.</span><span class="n">plot_projection</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="o">-</span><span class="n">dcolims</span><span class="p">[</span><span class="n">tidx</span><span class="p">]</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">dcolims</span><span class="p">[</span><span class="n">tidx</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="o">-</span><span class="n">colims</span><span class="p">[</span><span class="n">tidx</span><span class="p">]</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">colims</span><span class="p">[</span><span class="n">tidx</span><span class="p">]</span>

            <span class="n">imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">map_displacement_grid</span><span class="p">(</span><span class="n">datavec</span><span class="p">,</span> <span class="n">scene</span><span class="p">),</span>
                <span class="n">extent</span><span class="o">=</span><span class="n">im_extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">))</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">llE</span><span class="p">,</span> <span class="n">urE</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">llN</span><span class="p">,</span> <span class="n">urN</span><span class="p">)</span>

            <span class="n">draw_leaves</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">offset_e</span><span class="p">,</span> <span class="n">offset_n</span><span class="p">)</span>
            <span class="n">draw_coastlines</span><span class="p">(</span>
                <span class="n">ax</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">po</span><span class="p">)</span>

        <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="n">fontsize</span><span class="p">,</span>
            <span class="s1">&#39;fontweight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">,</span>
            <span class="s1">&#39;verticalalignment&#39;</span><span class="p">:</span> <span class="s1">&#39;top&#39;</span><span class="p">}</span>

        <span class="n">transform</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">figidx</span><span class="p">][</span><span class="n">rowidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span>

        <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">::]</span> <span class="o">==</span> <span class="s1">&#39;dscxn&#39;</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;descending&#39;</span>
        <span class="k">elif</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">::]</span> <span class="o">==</span> <span class="s1">&#39;ascxn&#39;</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;ascending&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">name</span>

        <span class="n">axes</span><span class="p">[</span><span class="n">figidx</span><span class="p">][</span><span class="n">rowidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="o">.</span><span class="mi">025</span><span class="p">,</span> <span class="mf">1.025</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">{}</span><span class="s1">) </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subplot_letter</span><span class="p">,</span> <span class="n">title</span><span class="p">),</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize_title</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">quantity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;residual&#39;</span><span class="p">]):</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">figidx</span><span class="p">][</span><span class="n">rowidx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transAxes</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">figidx</span><span class="p">][</span><span class="n">rowidx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">fontdict</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>

        <span class="n">draw_sources</span><span class="p">(</span>
            <span class="n">axes</span><span class="p">[</span><span class="n">figidx</span><span class="p">][</span><span class="n">rowidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">sources</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">po</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ref_sources</span><span class="p">:</span>
            <span class="n">ref_color</span> <span class="o">=</span> <span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;aluminium4&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plotting reference sources&#39;</span><span class="p">)</span>
            <span class="n">draw_sources</span><span class="p">(</span>
                <span class="n">axes</span><span class="p">[</span><span class="n">figidx</span><span class="p">][</span><span class="n">rowidx</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">ref_sources</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">po</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">ref_color</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">factors</span><span class="p">[</span><span class="n">figidx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="mf">2.</span> <span class="o">/</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">cbb</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.68</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.3075</span> <span class="o">*</span> <span class="n">rowidx</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">cbb</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.53</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.47</span> <span class="o">*</span> <span class="n">rowidx</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">cbb</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.06</span><span class="p">)</span>

        <span class="n">cbl</span> <span class="o">=</span> <span class="mf">0.46</span>
        <span class="n">cbw</span> <span class="o">=</span> <span class="mf">0.15</span>
        <span class="n">cbh</span> <span class="o">=</span> <span class="mf">0.01</span>

        <span class="n">cbaxes</span> <span class="o">=</span> <span class="n">figures</span><span class="p">[</span><span class="n">figidx</span><span class="p">]</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">cbl</span><span class="p">,</span> <span class="n">cbb</span><span class="p">,</span> <span class="n">cbw</span><span class="p">,</span> <span class="n">cbh</span><span class="p">])</span>

        <span class="n">cblabel</span> <span class="o">=</span> <span class="s1">&#39;LOS displacement [m]&#39;</span>
        <span class="n">cbs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
            <span class="n">imgs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">figidx</span><span class="p">][</span><span class="n">rowidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">ticks</span><span class="o">=</span><span class="n">cbtick</span><span class="p">(</span><span class="n">colims</span><span class="p">[</span><span class="n">tidx</span><span class="p">]),</span>
            <span class="n">cax</span><span class="o">=</span><span class="n">cbaxes</span><span class="p">,</span>
            <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">cbs</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">cblabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">plot_projection</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">dcbaxes</span> <span class="o">=</span> <span class="n">figures</span><span class="p">[</span><span class="n">figidx</span><span class="p">]</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">cbl</span> <span class="o">+</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">cbb</span><span class="p">,</span> <span class="n">cbw</span><span class="p">,</span> <span class="n">cbh</span><span class="p">])</span>
            <span class="n">cbr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
                <span class="n">imgs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="n">figidx</span><span class="p">][</span><span class="n">rowidx</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">ticks</span><span class="o">=</span><span class="n">cbtick</span><span class="p">(</span><span class="n">dcolims</span><span class="p">[</span><span class="n">tidx</span><span class="p">]),</span>
                <span class="n">cax</span><span class="o">=</span><span class="n">dcbaxes</span><span class="p">,</span>
                <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">cbr</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">cblabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="n">axis_config</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">figidx</span><span class="p">][</span><span class="n">rowidx</span><span class="p">,</span> <span class="p">:],</span> <span class="n">event</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="n">po</span><span class="p">)</span>
        <span class="n">addArrow</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">figidx</span><span class="p">][</span><span class="n">rowidx</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">scene</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">scene</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">figures</span></div>


<span class="k">def</span> <span class="nf">draw_scene_fits</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">plot_options</span><span class="p">):</span>

    <span class="k">if</span> <span class="s1">&#39;geodetic&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">composites</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;No geodetic composite defined in the problem!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;SAR&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">geodetic_config</span><span class="o">.</span><span class="n">types</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;There is no SAR data in the problem setup!&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing SAR misfits ...&#39;</span><span class="p">)</span>
    <span class="n">po</span> <span class="o">=</span> <span class="n">plot_options</span>

    <span class="n">stage</span> <span class="o">=</span> <span class="n">Stage</span><span class="p">(</span><span class="n">homepath</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span>
                  <span class="n">backend</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sampler_config</span><span class="o">.</span><span class="n">backend</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">:</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">load_results</span><span class="p">(</span>
            <span class="n">varnames</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">varnames</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">stage_number</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">load_stage</span><span class="p">,</span>
            <span class="n">load</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">llk_str</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">llk_str</span> <span class="o">=</span> <span class="s1">&#39;ref&#39;</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">mode</span>

    <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">project_dir</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span> <span class="s1">&#39;scenes_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">stage</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">llk_str</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">plot_projection</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
        <span class="n">figs</span> <span class="o">=</span> <span class="n">scene_fits</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">po</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;scene plots exist. Use force=True for replotting!&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving figures to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;pdf&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">outpath</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">opdf</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
                    <span class="n">opdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fig</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">figs</span><span class="p">):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outpath</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">draw_gnss_fits</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">plot_options</span><span class="p">):</span>

    <span class="k">if</span> <span class="s1">&#39;geodetic&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">composites</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;No geodetic composite defined in the problem!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;GNSS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">geodetic_config</span><span class="o">.</span><span class="n">types</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;There is no SAR data in the problem setup!&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing GNSS misfits ...&#39;</span><span class="p">)</span>

    <span class="n">po</span> <span class="o">=</span> <span class="n">plot_options</span>

    <span class="n">stage</span> <span class="o">=</span> <span class="n">Stage</span><span class="p">(</span><span class="n">homepath</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span>
                  <span class="n">backend</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sampler_config</span><span class="o">.</span><span class="n">backend</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">:</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">load_results</span><span class="p">(</span>
            <span class="n">varnames</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">varnames</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">stage_number</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">load_stage</span><span class="p">,</span>
            <span class="n">load</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">llk_str</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">llk_str</span> <span class="o">=</span> <span class="s1">&#39;ref&#39;</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">mode</span>

    <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">project_dir</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span> <span class="s1">&#39;gnss_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">stage</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">llk_str</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">plot_projection</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
        <span class="n">figs</span> <span class="o">=</span> <span class="n">gnss_fits</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">po</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;scene plots exist. Use force=True for replotting!&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving figures to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">fig</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">((</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="s1">&#39;vertical&#39;</span><span class="p">),</span> <span class="n">figs</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outpath</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">component</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">),</span> <span class="n">resolution</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">extract_time_shifts</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">wmap</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">time_shifts</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="n">wmap</span><span class="o">.</span><span class="n">time_shifts_id</span><span class="p">][</span>
            <span class="n">wmap</span><span class="o">.</span><span class="n">station_correction_idxs</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Sampling results do not contain time-shifts for wmap&#39;</span>
            <span class="s1">&#39; </span><span class="si">%s</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="n">wmap</span><span class="o">.</span><span class="n">time_shifts_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">time_shifts</span>


<div class="viewcode-block" id="seismic_fits"><a class="viewcode-back" href="../api.html#plotting.seismic_fits">[docs]</a><span class="k">def</span> <span class="nf">seismic_fits</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">plot_options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modified from grond. Plot synthetic and data waveforms and the misfit for</span>
<span class="sd">    the selected posterior model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">plot_trace</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">(),</span> <span class="n">tr</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_taper</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">taper</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.9</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span>
            <span class="n">taper</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">y</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_dtrace</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">ma</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">y</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span> <span class="o">/</span> \
            <span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span> <span class="o">*</span> <span class="n">space</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">space</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span>
            <span class="n">t2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span>
            <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_inset_hist</span><span class="p">(</span>
            <span class="n">axes</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">best_data</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>

        <span class="n">in_ax</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span>
            <span class="n">axes</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="p">,</span>
            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">bbox_to_anchor</span><span class="p">,</span>
            <span class="n">bbox_transform</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">borderpad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">histplot_op</span><span class="p">(</span>
            <span class="n">in_ax</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">cbounds</span><span class="o">=</span><span class="n">cbounds</span><span class="p">,</span> <span class="n">tstd</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>

        <span class="n">format_axes</span><span class="p">(</span><span class="n">in_ax</span><span class="p">)</span>
        <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">format_axes</span><span class="p">(</span>
            <span class="n">in_ax</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">],</span> <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">best_data</span><span class="p">:</span>
            <span class="n">in_ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">best_data</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>

        <span class="n">in_ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>
        <span class="n">in_ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">in_ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">xticker</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">in_ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">xticker</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">in_ax</span>

    <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="k">import</span> <span class="n">inset_axes</span>

    <span class="n">composite</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">composites</span><span class="p">[</span><span class="s1">&#39;seismic&#39;</span><span class="p">]</span>

    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">fontsize_title</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">target_index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">composite</span><span class="o">.</span><span class="n">targets</span><span class="p">))</span>

    <span class="n">po</span> <span class="o">=</span> <span class="n">plot_options</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">:</span>
        <span class="n">best_point</span> <span class="o">=</span> <span class="n">get_result_point</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">best_point</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">composite</span><span class="o">.</span><span class="n">point2sources</span><span class="p">(</span><span class="n">best_point</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">chop_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;FFI waveform fit, using reference source ...&#39;</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">reference_sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">source</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">time</span>
        <span class="n">chop_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">best_point</span><span class="p">:</span>  <span class="c1"># for source individual contributions</span>
        <span class="n">bresults</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">assemble_results</span><span class="p">(</span>
            <span class="n">best_point</span><span class="p">,</span> <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;tapered_data&#39;</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="o">=</span><span class="n">chop_bounds</span><span class="p">)</span>
        <span class="n">synth_plot_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># get dummy results for data</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Got &quot;None&quot; post_llk, still loading MAP for VR calculation&#39;</span><span class="p">)</span>
        <span class="n">best_point</span> <span class="o">=</span> <span class="n">get_result_point</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span>
        <span class="n">bresults</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">assemble_results</span><span class="p">(</span>
            <span class="n">best_point</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="o">=</span><span class="n">chop_bounds</span><span class="p">)</span>
        <span class="n">synth_plot_flag</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">composite</span><span class="o">.</span><span class="n">analyse_noise</span><span class="p">(</span><span class="n">best_point</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="o">=</span><span class="n">chop_bounds</span><span class="p">)</span>
    <span class="n">composite</span><span class="o">.</span><span class="n">update_weights</span><span class="p">(</span><span class="n">best_point</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="o">=</span><span class="n">chop_bounds</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_options</span><span class="o">.</span><span class="n">nensemble</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Collecting ensemble of </span><span class="si">%i</span><span class="s1"> synthetic waveforms ...&#39;</span> <span class="o">%</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span><span class="p">)</span>
        <span class="n">nchains</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span><span class="p">)</span>
        <span class="n">csteps</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nchains</span><span class="p">)</span> <span class="o">/</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchains</span><span class="p">,</span> <span class="n">csteps</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
        <span class="n">ens_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ens_var_reductions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">idxs</span><span class="p">):</span>
            <span class="n">point</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">assemble_results</span><span class="p">(</span>
                <span class="n">point</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="o">=</span><span class="n">chop_bounds</span><span class="p">)</span>
            <span class="n">ens_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="n">ens_var_reductions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">composite</span><span class="o">.</span><span class="n">get_variance_reductions</span><span class="p">(</span>
                    <span class="n">point</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">composite</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span>
                    <span class="n">results</span><span class="o">=</span><span class="n">results</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="o">=</span><span class="n">chop_bounds</span><span class="p">))</span>

    <span class="n">bvar_reductions</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">get_variance_reductions</span><span class="p">(</span>
        <span class="n">best_point</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">composite</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span>
        <span class="n">results</span><span class="o">=</span><span class="n">bresults</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="o">=</span><span class="n">chop_bounds</span><span class="p">)</span>

    <span class="c1"># collecting results for targets</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Mapping results to targets ...&#39;</span><span class="p">)</span>
    <span class="n">target_to_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">all_syn_trs_target</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">all_var_reductions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dtraces</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">composite</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
        <span class="n">target_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_synths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">target_var_reductions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">target_index</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

        <span class="n">nslc_id_str</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">codes</span><span class="p">)</span>
        <span class="n">target_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bresults</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">target_synths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bresults</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">processed_syn</span><span class="p">)</span>
        <span class="n">target_var_reductions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">bvar_reductions</span><span class="p">[</span><span class="n">nslc_id_str</span><span class="p">])</span>

        <span class="n">dtraces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">bresults</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">processed_res</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">plot_options</span><span class="o">.</span><span class="n">nensemble</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">results</span><span class="p">,</span> <span class="n">var_reductions</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">ens_results</span><span class="p">,</span> <span class="n">ens_var_reductions</span><span class="p">):</span>
                <span class="c1"># put all results per target here not only single</span>
                <span class="n">target_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">target_synths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">processed_syn</span><span class="p">)</span>
                <span class="n">target_var_reductions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">var_reductions</span><span class="p">[</span><span class="n">nslc_id_str</span><span class="p">])</span>

        <span class="n">target_to_results</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_results</span>
        <span class="n">all_syn_trs_target</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_synths</span>
        <span class="n">all_var_reductions</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_var_reductions</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.</span>

    <span class="c1"># collecting time-shifts:</span>
    <span class="n">station_corr</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">station_corrections</span>
    <span class="k">if</span> <span class="n">station_corr</span><span class="p">:</span>
        <span class="n">tshifts</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">hierarchicals</span><span class="p">[</span><span class="s1">&#39;time_shift&#39;</span><span class="p">]</span>
        <span class="n">time_shift_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">tshifts</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">tshifts</span><span class="o">.</span><span class="n">upper</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Collecting time-shifts ...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_options</span><span class="o">.</span><span class="n">nensemble</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ens_time_shifts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
                <span class="n">comp_time_shifts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">wmap</span> <span class="ow">in</span> <span class="n">composite</span><span class="o">.</span><span class="n">wavemaps</span><span class="p">:</span>
                    <span class="n">comp_time_shifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">extract_time_shifts</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">wmap</span><span class="p">))</span>

                <span class="n">ens_time_shifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">num</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">comp_time_shifts</span><span class="p">))</span>

        <span class="n">btime_shifts</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="p">[</span><span class="n">extract_time_shifts</span><span class="p">(</span><span class="n">best_point</span><span class="p">,</span> <span class="n">wmap</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">wmap</span> <span class="ow">in</span> <span class="n">composite</span><span class="o">.</span><span class="n">wavemaps</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Mapping time-shifts to targets ...&#39;</span><span class="p">)</span>
        <span class="n">all_time_shifts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">composite</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="n">target_time_shifts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">target_index</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
            <span class="n">target_time_shifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">btime_shifts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">plot_options</span><span class="o">.</span><span class="n">nensemble</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">time_shifts</span> <span class="ow">in</span> <span class="n">ens_time_shifts</span><span class="p">:</span>
                    <span class="n">target_time_shifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_shifts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">all_time_shifts</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">target_time_shifts</span><span class="p">)</span>

    <span class="n">skey</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tr</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">channel</span>

<span class="c1">#    trace_minmaxs = trace.minmax(all_syn_trs, skey)</span>
    <span class="n">dminmaxs</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">minmax</span><span class="p">(</span><span class="n">dtraces</span><span class="p">,</span> <span class="n">skey</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">dtraces</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tr</span><span class="p">:</span>
            <span class="n">dmin</span><span class="p">,</span> <span class="n">dmax</span> <span class="o">=</span> <span class="n">dminmaxs</span><span class="p">[</span><span class="n">skey</span><span class="p">(</span><span class="n">tr</span><span class="p">)]</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">ydata</span> <span class="o">/=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dmin</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dmax</span><span class="p">))</span>

    <span class="n">cg_to_targets</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
        <span class="n">composite</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="nb">filter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">target_to_results</span><span class="p">)</span>

    <span class="n">cgs</span> <span class="o">=</span> <span class="n">cg_to_targets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plotting waveforms ...&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cg</span> <span class="ow">in</span> <span class="n">cgs</span><span class="p">:</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">cg_to_targets</span><span class="p">[</span><span class="n">cg</span><span class="p">]</span>

        <span class="c1"># can keep from here ... until</span>
        <span class="n">nframes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>

        <span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nframes</span><span class="p">)))</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="p">(</span><span class="n">nframes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">nx</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;nx </span><span class="si">%i</span><span class="s1">, ny </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">))</span>

        <span class="n">nxmax</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">nymax</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="n">nxx</span> <span class="o">=</span> <span class="p">(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">nxmax</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">nyy</span> <span class="o">=</span> <span class="p">(</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">nymax</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">xs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="o">//</span> <span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span> <span class="o">//</span> <span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>

        <span class="n">xs</span> <span class="o">-=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="n">ys</span> <span class="o">-=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>

        <span class="n">fxs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
        <span class="n">fys</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="n">azi</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">azibazi_to</span><span class="p">(</span><span class="n">target</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">distance_to</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">azi</span><span class="p">))</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">azi</span><span class="p">))</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dist</span><span class="p">))</span>

        <span class="n">gxs</span><span class="p">,</span> <span class="n">gys</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="n">iorder</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>

        <span class="n">gxs</span> <span class="o">=</span> <span class="n">gxs</span><span class="p">[</span><span class="n">iorder</span><span class="p">]</span>
        <span class="n">gys</span> <span class="o">=</span> <span class="n">gys</span><span class="p">[</span><span class="n">iorder</span><span class="p">]</span>
        <span class="n">targets_sorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">targets</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">iorder</span><span class="p">]</span>

        <span class="n">gxs</span> <span class="o">-=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gxs</span><span class="p">)</span>
        <span class="n">gys</span> <span class="o">-=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gys</span><span class="p">)</span>

        <span class="n">gmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gys</span><span class="p">)),</span> <span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gxs</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">gmax</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">gmax</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="n">gxs</span> <span class="o">/=</span> <span class="n">gmax</span>
        <span class="n">gys</span> <span class="o">/=</span> <span class="n">gmax</span>

        <span class="n">dists</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="n">fxs</span><span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">gxs</span><span class="p">[:,</span> <span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
            <span class="p">(</span><span class="n">fys</span><span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">gys</span><span class="p">[:,</span> <span class="n">num</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">distmax</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>

        <span class="n">availmask</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">dists</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="n">frame_to_target</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">itarget</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets_sorted</span><span class="p">):</span>
            <span class="n">iframe</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
                <span class="n">num</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">availmask</span><span class="p">,</span> <span class="n">dists</span><span class="p">[</span><span class="n">itarget</span><span class="p">],</span> <span class="n">distmax</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">))</span>
            <span class="n">availmask</span><span class="p">[</span><span class="n">iframe</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">iy</span><span class="p">,</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">iframe</span><span class="p">,</span> <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">))</span>
            <span class="n">frame_to_target</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>

        <span class="n">figures</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">iy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">frame_to_target</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">ixx</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">//</span> <span class="n">nxmax</span>
                <span class="n">iyy</span> <span class="o">=</span> <span class="n">iy</span> <span class="o">//</span> <span class="n">nymax</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">iyy</span><span class="p">,</span> <span class="n">ixx</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">figures</span><span class="p">:</span>
                    <span class="n">figures</span><span class="p">[</span><span class="n">iyy</span><span class="p">,</span> <span class="n">ixx</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span>
                        <span class="n">figsize</span><span class="o">=</span><span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a4&#39;</span><span class="p">,</span> <span class="s1">&#39;landscape&#39;</span><span class="p">))</span>

                    <span class="n">figures</span><span class="p">[</span><span class="n">iyy</span><span class="p">,</span> <span class="n">ixx</span><span class="p">]</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span>
                        <span class="n">left</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span>
                        <span class="n">right</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.03</span><span class="p">,</span>
                        <span class="n">bottom</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span>
                        <span class="n">top</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.06</span><span class="p">,</span>
                        <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                        <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

                    <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">figures</span><span class="p">[</span><span class="n">iyy</span><span class="p">,</span> <span class="n">ixx</span><span class="p">])</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;iyy </span><span class="si">%i</span><span class="s1">, ixx </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iyy</span><span class="p">,</span> <span class="n">ixx</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;iy </span><span class="si">%i</span><span class="s1">, ix </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">))</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">figures</span><span class="p">[</span><span class="n">iyy</span><span class="p">,</span> <span class="n">ixx</span><span class="p">]</span>

                <span class="n">target</span> <span class="o">=</span> <span class="n">frame_to_target</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span>

                <span class="c1"># get min max of all traces</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">amin</span><span class="p">,</span> <span class="n">amax</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">minmax</span><span class="p">(</span>
                    <span class="n">all_syn_trs_target</span><span class="p">[</span><span class="n">target</span><span class="p">],</span>
                    <span class="n">key</span><span class="o">=</span><span class="n">skey</span><span class="p">)[</span><span class="n">key</span><span class="p">]</span>
                <span class="c1"># need target specific minmax</span>
                <span class="n">absmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">amin</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">amax</span><span class="p">))</span>

                <span class="n">ny_this</span> <span class="o">=</span> <span class="n">nymax</span>  <span class="c1"># min(ny, nymax)</span>
                <span class="n">nx_this</span> <span class="o">=</span> <span class="n">nxmax</span>  <span class="c1"># min(nx, nxmax)</span>
                <span class="n">i_this</span> <span class="o">=</span> <span class="p">(</span><span class="n">iy</span> <span class="o">%</span> <span class="n">ny_this</span><span class="p">)</span> <span class="o">*</span> <span class="n">nx_this</span> <span class="o">+</span> <span class="p">(</span><span class="n">ix</span> <span class="o">%</span> <span class="n">nx_this</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;i_this </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i_this</span><span class="p">)</span>
                <span class="n">axes2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">ny_this</span><span class="p">,</span> <span class="n">nx_this</span><span class="p">,</span> <span class="n">i_this</span><span class="p">)</span>

                <span class="n">space</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="n">space_factor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="n">space</span>
                <span class="n">axes2</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
                <span class="n">axes2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.05</span> <span class="o">*</span> <span class="n">space_factor</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>

                <span class="n">axes</span> <span class="o">=</span> <span class="n">axes2</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

                <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="o">-</span> <span class="n">absmax</span> <span class="o">*</span> <span class="mf">1.33</span> <span class="o">*</span> <span class="n">space_factor</span><span class="p">,</span> <span class="n">absmax</span> <span class="o">*</span> <span class="mf">1.33</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>

                <span class="n">itarget</span> <span class="o">=</span> <span class="n">target_index</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">bresults</span><span class="p">[</span><span class="n">itarget</span><span class="p">]</span>

                <span class="n">traces</span> <span class="o">=</span> <span class="n">all_syn_trs_target</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>

                <span class="n">dtrace</span> <span class="o">=</span> <span class="n">dtraces</span><span class="p">[</span><span class="n">itarget</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">minmaxtime</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">skey</span><span class="p">)[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">fuzzy_waveforms</span><span class="p">(</span>
                        <span class="n">axes</span><span class="p">,</span> <span class="n">traces</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">grid_size</span><span class="o">=</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

                <span class="n">tap_color_annot</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">)</span>
                <span class="n">tap_color_edge</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">)</span>
                <span class="c1"># tap_color_fill = (0.95, 0.95, 0.90)</span>

                <span class="n">plot_taper</span><span class="p">(</span>
                    <span class="n">axes2</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">processed_obs</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">(),</span> <span class="n">result</span><span class="o">.</span><span class="n">taper</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="n">composite</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="n">tap_color_edge</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

                <span class="n">time_shift_color</span> <span class="o">=</span> <span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;aluminium3&#39;</span><span class="p">)</span>
                <span class="n">obs_color</span> <span class="o">=</span> <span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;aluminium5&#39;</span><span class="p">)</span>
                <span class="n">syn_color</span> <span class="o">=</span> <span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;scarletred2&#39;</span><span class="p">)</span>
                <span class="n">misfit_color</span> <span class="o">=</span> <span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;scarletred2&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">synth_plot_flag</span><span class="p">:</span>
                    <span class="c1"># only draw if highlighted point exists</span>
                    <span class="n">plot_dtrace</span><span class="p">(</span>
                        <span class="n">axes2</span><span class="p">,</span> <span class="n">dtrace</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span>
                        <span class="n">fc</span><span class="o">=</span><span class="n">light</span><span class="p">(</span><span class="n">misfit_color</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>
                        <span class="n">ec</span><span class="o">=</span><span class="n">misfit_color</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">plot_projection</span> <span class="o">==</span> <span class="s1">&#39;individual&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">source_contributions</span><span class="p">):</span>
                            <span class="n">plot_trace</span><span class="p">(</span>
                                <span class="n">axes</span><span class="p">,</span> <span class="n">tr</span><span class="p">,</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">mpl_graph_color</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">plot_trace</span><span class="p">(</span>
                            <span class="n">axes</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">processed_syn</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">syn_color</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

                <span class="n">plot_trace</span><span class="p">(</span>
                    <span class="n">axes</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">processed_obs</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">obs_color</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

                <span class="n">xdata</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">processed_obs</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xdata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">tmarks</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">processed_obs</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">processed_obs</span><span class="o">.</span><span class="n">tmax</span><span class="p">]</span>
                <span class="n">tmark_fontsize</span> <span class="o">=</span> <span class="n">fontsize</span> <span class="o">-</span> <span class="mi">1</span>

                <span class="c1"># plot variance reductions</span>
                <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">nslc_id_str</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">codes</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s1">&#39;Plotting variance reductions for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nslc_id_str</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">synth_plot_flag</span><span class="p">:</span>
                        <span class="n">best_data</span> <span class="o">=</span> <span class="n">bvar_reductions</span><span class="p">[</span><span class="n">nslc_id_str</span><span class="p">]</span> <span class="o">*</span> <span class="mf">100.</span>
                    <span class="k">else</span><span class="p">:</span>       <span class="c1"># for None post_llk</span>
                        <span class="n">best_data</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="n">in_ax</span> <span class="o">=</span> <span class="n">plot_inset_hist</span><span class="p">(</span>
                        <span class="n">axes</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">pmp</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">make_2d</span><span class="p">(</span><span class="n">all_var_reductions</span><span class="p">[</span><span class="n">target</span><span class="p">]),</span>
                        <span class="n">best_data</span><span class="o">=</span><span class="n">best_data</span><span class="p">,</span>
                        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="o">.</span><span class="mi">75</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">in_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;VR [%]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">station_corr</span><span class="p">:</span>
                    <span class="n">sidebar_ybounds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.9</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3</span><span class="p">]</span>
                    <span class="n">ytmarks</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3</span><span class="p">]</span>
                    <span class="n">hor_alignment</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span>

                    <span class="k">if</span> <span class="n">synth_plot_flag</span><span class="p">:</span>
                        <span class="n">best_data</span> <span class="o">=</span> <span class="n">btime_shifts</span><span class="p">[</span><span class="n">itarget</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>       <span class="c1"># for None post_llk</span>
                        <span class="n">best_data</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">in_ax</span> <span class="o">=</span> <span class="n">plot_inset_hist</span><span class="p">(</span>
                            <span class="n">axes</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">=</span><span class="n">pmp</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">make_2d</span><span class="p">(</span><span class="n">all_time_shifts</span><span class="p">[</span><span class="n">target</span><span class="p">]),</span>
                            <span class="n">best_data</span><span class="o">=</span><span class="n">best_data</span><span class="p">,</span>
                            <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.0985</span><span class="p">,</span> <span class="o">.</span><span class="mi">26</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">,</span> <span class="o">.</span><span class="mi">2</span><span class="p">),</span>
                            <span class="c1"># cmap=plt.cm.get_cmap(&#39;seismic&#39;),</span>
                            <span class="c1"># cbounds=time_shift_bounds,</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">time_shift_color</span><span class="p">,</span>
                            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
                        <span class="n">in_ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">time_shift_bounds</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sidebar_ybounds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">]</span>
                    <span class="n">ytmarks</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">]</span>
                    <span class="n">hor_alignment</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>

                <span class="k">for</span> <span class="n">tmark</span><span class="p">,</span> <span class="n">ybound</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tmarks</span><span class="p">,</span> <span class="n">sidebar_ybounds</span><span class="p">):</span>
                    <span class="n">axes2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">tmark</span><span class="p">,</span> <span class="n">tmark</span><span class="p">],</span> <span class="p">[</span><span class="n">ybound</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">tap_color_annot</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">xtmark</span><span class="p">,</span> <span class="n">ytmark</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">ha</span><span class="p">,</span> <span class="n">va</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="p">(</span><span class="n">tmarks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ytmarks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="s1">&#39;$\,$ &#39;</span> <span class="o">+</span> <span class="n">str_duration</span><span class="p">(</span><span class="n">tmarks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">source</span><span class="o">.</span><span class="n">time</span><span class="p">),</span>
                         <span class="n">hor_alignment</span><span class="p">,</span>
                         <span class="s1">&#39;bottom&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">tmarks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ytmarks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                         <span class="s1">&#39;$\Delta$ &#39;</span> <span class="o">+</span> <span class="n">str_duration</span><span class="p">(</span><span class="n">tmarks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tmarks</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                         <span class="s1">&#39;right&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;bottom&#39;</span><span class="p">)]:</span>

                    <span class="n">axes2</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                        <span class="n">text</span><span class="p">,</span>
                        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">xtmark</span><span class="p">,</span> <span class="n">ytmark</span><span class="p">),</span>
                        <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span>
                            <span class="n">fontsize</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">][</span><span class="n">ha</span> <span class="o">==</span> <span class="s1">&#39;left&#39;</span><span class="p">],</span>
                            <span class="n">fontsize</span> <span class="o">*</span> <span class="mf">0.2</span><span class="p">),</span>
                        <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                        <span class="n">ha</span><span class="o">=</span><span class="n">ha</span><span class="p">,</span>
                        <span class="n">va</span><span class="o">=</span><span class="n">va</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">tap_color_annot</span><span class="p">,</span>
                        <span class="n">fontsize</span><span class="o">=</span><span class="n">tmark_fontsize</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

                <span class="n">scale_string</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">infos</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">scale_string</span><span class="p">:</span>
                    <span class="n">infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scale_string</span><span class="p">)</span>

                <span class="n">infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">codes</span> <span class="k">if</span> <span class="n">x</span><span class="p">))</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">distance_to</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="n">azi</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">azibazi_to</span><span class="p">(</span><span class="n">target</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">str_dist</span><span class="p">(</span><span class="n">dist</span><span class="p">))</span>
                <span class="n">infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.0f</span><span class="se">\u00B0</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">azi</span><span class="p">)</span>
                <span class="c1"># infos.append(&#39;%.3f&#39; % gcms[itarget])</span>
                <span class="n">axes2</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">infos</span><span class="p">),</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
                    <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
                    <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                    <span class="n">fontstyle</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

                <span class="c1"># annotate axis amplitude</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">%0.3g</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> -&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">absmax</span><span class="p">,</span> <span class="n">str_unit</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">quantity</span><span class="p">)),</span>
                    <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">tmarks</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">absmax</span><span class="p">),</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
                    <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">obs_color</span><span class="p">,</span>
                    <span class="n">fontstyle</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">)</span>

                <span class="n">axes2</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">iyy</span><span class="p">,</span> <span class="n">ixx</span><span class="p">),</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figures</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cg</span> <span class="k">if</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">figures</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39; (</span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">, </span><span class="si">%i</span><span class="s1">/</span><span class="si">%i</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iyy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nyy</span><span class="p">,</span> <span class="n">ixx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxx</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize_title</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">figs</span></div>


<span class="k">def</span> <span class="nf">draw_seismic_fits</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">po</span><span class="p">):</span>

    <span class="k">if</span> <span class="s1">&#39;seismic&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">composites</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;No seismic composite defined for this problem!&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing Waveform fits ...&#39;</span><span class="p">)</span>

    <span class="n">stage</span> <span class="o">=</span> <span class="n">Stage</span><span class="p">(</span><span class="n">homepath</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span>
                  <span class="n">backend</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sampler_config</span><span class="o">.</span><span class="n">backend</span><span class="p">)</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">mode</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">:</span>
        <span class="n">llk_str</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span>
        <span class="n">stage</span><span class="o">.</span><span class="n">load_results</span><span class="p">(</span>
            <span class="n">varnames</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">varnames</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">stage_number</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">load_stage</span><span class="p">,</span>
            <span class="n">load</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">llk_str</span> <span class="o">=</span> <span class="s1">&#39;ref&#39;</span>

    <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">project_dir</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span> <span class="s1">&#39;waveforms_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">stage</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">llk_str</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
        <span class="n">figs</span> <span class="o">=</span> <span class="n">seismic_fits</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">po</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;waveform plots exist. Use force=True for replotting!&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving figures to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;pdf&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">outpath</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">opdf</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
                    <span class="n">opdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fig</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">figs</span><span class="p">):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outpath</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">point2array</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">varnames</span><span class="p">,</span> <span class="n">rpoint</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenate values of point according to order of given varnames.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">point</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">varnames</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">varname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">varnames</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">point</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># in case fixed variable</span>
                <span class="k">if</span> <span class="n">rpoint</span><span class="p">:</span>
                    <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpoint</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;Fixed Component &quot;</span><span class="si">%s</span><span class="s1">&quot; no fixed value given!&#39;</span> <span class="o">%</span> <span class="n">varname</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">array</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">extract_mt_components</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">po</span><span class="p">,</span> <span class="n">include_magnitude</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract Moment Tensor components from problem results for plotting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source_type</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">source_type</span>
    <span class="k">if</span> <span class="n">source_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;MTSource&#39;</span><span class="p">,</span> <span class="s1">&#39;MTQTSource&#39;</span><span class="p">]:</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mnn&#39;</span><span class="p">,</span> <span class="s1">&#39;mee&#39;</span><span class="p">,</span> <span class="s1">&#39;mdd&#39;</span><span class="p">,</span> <span class="s1">&#39;mne&#39;</span><span class="p">,</span> <span class="s1">&#39;mnd&#39;</span><span class="p">,</span> <span class="s1">&#39;med&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">source_type</span> <span class="o">==</span> <span class="s1">&#39;DCSource&#39;</span><span class="p">:</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;strike&#39;</span><span class="p">,</span> <span class="s1">&#39;dip&#39;</span><span class="p">,</span> <span class="s1">&#39;rake&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;Plot is only supported for point &quot;MTSource&quot; and &quot;DCSource&quot;&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">include_magnitude</span><span class="p">:</span>
        <span class="n">varnames</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;magnitude&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">:</span>
        <span class="n">rpoint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">llk_str</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span>
        <span class="n">stage</span> <span class="o">=</span> <span class="n">load_stage</span><span class="p">(</span>
            <span class="n">problem</span><span class="p">,</span> <span class="n">stage_number</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">load_stage</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">n_mts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span><span class="p">)</span>
        <span class="n">m6s</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_mts</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">varnames</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">varname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">varnames</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">m6s</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span>
                    <span class="n">varname</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># if fixed value add that to the ensemble</span>
                <span class="n">rpoint</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">get_random_point</span><span class="p">()</span>
                <span class="n">mtfield</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
                    <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_mts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">rpoint</span><span class="p">[</span><span class="n">varname</span><span class="p">])</span>
                <span class="n">m6s</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtfield</span>

        <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Drawing </span><span class="si">%i</span><span class="s1"> solutions from ensemble ...&#39;</span> <span class="o">%</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span><span class="p">)</span>
            <span class="n">csteps</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_mts</span><span class="p">)</span> <span class="o">/</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_mts</span><span class="p">,</span> <span class="n">csteps</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
            <span class="n">m6s</span> <span class="o">=</span> <span class="n">m6s</span><span class="p">[</span><span class="n">idxs</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing full ensemble ...&#39;</span><span class="p">)</span>

        <span class="n">point</span> <span class="o">=</span> <span class="n">get_result_point</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">)</span>
        <span class="n">best_mt</span> <span class="o">=</span> <span class="n">point2array</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">,</span> <span class="n">rpoint</span><span class="o">=</span><span class="n">rpoint</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">llk_str</span> <span class="o">=</span> <span class="s1">&#39;ref&#39;</span>
        <span class="n">m6s</span> <span class="o">=</span> <span class="p">[</span><span class="n">point2array</span><span class="p">(</span><span class="n">point</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">)]</span>
        <span class="n">best_mt</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">m6s</span><span class="p">,</span> <span class="n">best_mt</span><span class="p">,</span> <span class="n">llk_str</span>


<span class="k">def</span> <span class="nf">draw_fuzzy_beachball</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">po</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">n_sources</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Fuzzy beachball is not yet implemented for more than one source!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">m6s</span><span class="p">,</span> <span class="n">best_mt</span><span class="p">,</span> <span class="n">llk_str</span> <span class="o">=</span> <span class="n">extract_mt_components</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">po</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing Fuzzy Beachball ...&#39;</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;beachball_type&#39;</span><span class="p">:</span> <span class="s1">&#39;full&#39;</span><span class="p">,</span>
        <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
        <span class="s1">&#39;size_units&#39;</span><span class="p">:</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="s1">&#39;color_t&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="s1">&#39;grid_resolution&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">}</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span>
        <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span>
        <span class="s1">&#39;fuzzy_beachball_</span><span class="si">%i</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%i</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span><span class="p">,</span> <span class="n">llk_str</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">force</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>

        <span class="n">beachball</span><span class="o">.</span><span class="n">plot_fuzzy_beachball_mpl_pixmap</span><span class="p">(</span>
            <span class="n">m6s</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">best_mt</span><span class="o">=</span><span class="n">best_mt</span><span class="p">,</span> <span class="n">best_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving figure to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plot already exists! Please use --force to overwrite!&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fuzzy_mt_decomposition</span><span class="p">(</span>
        <span class="n">axes</span><span class="p">,</span> <span class="n">list_m6s</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot fuzzy moment tensor decompositions for list of mt ensembles.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pymc3</span> <span class="k">import</span> <span class="n">quantiles</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing Fuzzy MT Decomposition ...&#39;</span><span class="p">)</span>

    <span class="c1"># beachball kwargs</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;beachball_type&#39;</span><span class="p">:</span> <span class="s1">&#39;full&#39;</span><span class="p">,</span>
        <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>
        <span class="s1">&#39;size_units&#39;</span><span class="p">:</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>
        <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;grid_resolution&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_decomps</span><span class="p">(</span><span class="n">source_vals</span><span class="p">):</span>

        <span class="n">isos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">clvds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">devs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">source_vals</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">MomentTensor</span><span class="o">.</span><span class="n">from_values</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">iso</span><span class="p">,</span> <span class="n">dc</span><span class="p">,</span> <span class="n">clvd</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">tot</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">standard_decomposition</span><span class="p">()</span>
            <span class="n">isos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iso</span><span class="p">)</span>
            <span class="n">dcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>
            <span class="n">clvds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clvd</span><span class="p">)</span>
            <span class="n">devs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>
            <span class="n">tots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">isos</span><span class="p">,</span> <span class="n">dcs</span><span class="p">,</span> <span class="n">clvds</span><span class="p">,</span> <span class="n">devs</span><span class="p">,</span> <span class="n">tots</span>

    <span class="n">yscale</span> <span class="o">=</span> <span class="mf">1.3</span>
    <span class="n">nlines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_m6s</span><span class="p">)</span>
    <span class="n">nlines_max</span> <span class="o">=</span> <span class="n">nlines</span> <span class="o">*</span> <span class="n">yscale</span>

    <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">nlines</span> <span class="o">*</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ensemble&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">nlines</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">m6s</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">list_m6s</span><span class="p">,</span> <span class="n">colors</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">mpl_graph_color</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">m6s</span><span class="p">,</span> <span class="n">color</span><span class="p">))</span>

    <span class="n">magnitude_full_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">m6s</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">m6s</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;Full&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="s1">&#39;Isotropic&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="mf">4.</span><span class="p">,</span> <span class="s1">&#39;Deviatoric&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="mf">6.</span><span class="p">,</span> <span class="s1">&#39;CLVD&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="mf">8.</span><span class="p">,</span> <span class="s1">&#39;DC&#39;</span><span class="p">)]:</span>

        <span class="n">axes</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">label</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">nlines_max</span><span class="p">),</span>
            <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>
            <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">m6s</span><span class="p">,</span> <span class="n">color_t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">ypos</span> <span class="o">=</span> <span class="n">nlines_max</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">yscale</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>
        <span class="n">mean_magnitude</span> <span class="o">=</span> <span class="n">m6s</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">size0</span> <span class="o">=</span> <span class="n">mean_magnitude</span> <span class="o">/</span> <span class="n">magnitude_full_max</span>

        <span class="n">isos</span><span class="p">,</span> <span class="n">dcs</span><span class="p">,</span> <span class="n">clvds</span><span class="p">,</span> <span class="n">devs</span><span class="p">,</span> <span class="n">tots</span> <span class="o">=</span> <span class="n">get_decomps</span><span class="p">(</span><span class="n">m6s</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">label</span><span class="p">,</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="p">,</span> <span class="n">ypos</span><span class="p">),</span>
            <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>
            <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">decomp</span><span class="p">,</span> <span class="n">ops</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">tots</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="n">isos</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">4.</span><span class="p">,</span> <span class="n">devs</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">6.</span><span class="p">,</span> <span class="n">clvds</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">8.</span><span class="p">,</span> <span class="n">dcs</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]:</span>

            <span class="n">ratios</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">comp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">decomp</span><span class="p">])</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">ratios</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">ratios_diff</span> <span class="o">=</span> <span class="n">ratios</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">ratios</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

            <span class="n">ratios_qu</span> <span class="o">=</span> <span class="n">quantiles</span><span class="p">(</span><span class="n">ratios</span> <span class="o">*</span> <span class="mf">100.</span><span class="p">)</span>
            <span class="n">mt_parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">decomp</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="mf">1e-4</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.95</span> <span class="o">*</span> <span class="n">size0</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">)</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;color_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color_t</span>
                    <span class="n">beachball</span><span class="o">.</span><span class="n">plot_fuzzy_beachball_mpl_pixmap</span><span class="p">(</span>
                        <span class="n">mt_parts</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">best_mt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">ratios_diff</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:03.1f}</span><span class="s1">-</span><span class="si">{:03.1f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">ratios_qu</span><span class="p">[</span><span class="mf">2.5</span><span class="p">],</span> <span class="n">ratios_qu</span><span class="p">[</span><span class="mf">97.5</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:03.1f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ratios_qu</span><span class="p">[</span><span class="mf">2.5</span><span class="p">])</span>

                    <span class="n">axes</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                        <span class="n">label</span><span class="p">,</span>
                        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span> <span class="o">-</span> <span class="mf">0.65</span><span class="p">),</span>
                        <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>
                        <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                        <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                        <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                        <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

                <span class="k">except</span> <span class="n">beachball</span><span class="o">.</span><span class="n">BeachballError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

                    <span class="n">axes</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                        <span class="s1">&#39;ERROR&#39;</span><span class="p">,</span>
                        <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">),</span>
                        <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                        <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                        <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                    <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">),</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:03.1f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                    <span class="n">label</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span> <span class="o">-</span> <span class="mf">0.65</span><span class="p">),</span>
                    <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                    <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>
                    <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ops</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                    <span class="n">ops</span><span class="p">,</span>
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">),</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                    <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

    <span class="n">axes</span><span class="o">.</span><span class="n">axison</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">2.25</span><span class="p">,</span> <span class="mf">9.75</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">nlines_max</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">draw_fuzzy_mt_decomposition</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">po</span><span class="p">):</span>

    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">n_sources</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Fuzzy MT decomposition is not yet&#39;</span>
            <span class="s1">&#39;implemented for more than one source!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">m6s</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">llk_str</span> <span class="o">=</span> <span class="n">extract_mt_components</span><span class="p">(</span>
        <span class="n">problem</span><span class="p">,</span> <span class="n">po</span><span class="p">,</span> <span class="n">include_magnitude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span>
        <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span>
        <span class="s1">&#39;fuzzy_mt_decomposition_</span><span class="si">%i</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%i</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span><span class="p">,</span> <span class="n">llk_str</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">force</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">fuzzy_mt_decomposition</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">list_m6s</span><span class="o">=</span><span class="p">[</span><span class="n">m6s</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving figure to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plot already exists! Please use --force to overwrite!&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">draw_hudson</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">po</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modified from grond. Plot the hudson graph for the reference event(grey)</span>
<span class="sd">    and the best solution (red beachball).</span>
<span class="sd">    Also a random number of models from the</span>
<span class="sd">    selected stage are plotted as smaller beachballs on the hudson graph.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">pyrocko.plot</span> <span class="k">import</span> <span class="n">beachball</span><span class="p">,</span> <span class="n">hudson</span>
    <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">moment_tensor</span> <span class="k">as</span> <span class="n">mtm</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">random</span>
    <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">n_sources</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Hudson plot is not yet implemented for more than one source!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">m6s</span><span class="p">,</span> <span class="n">best_mt</span><span class="p">,</span> <span class="n">llk_str</span> <span class="o">=</span> <span class="n">extract_mt_components</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">po</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing Hudson plot ...&#39;</span><span class="p">)</span>

    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="n">beachball_type</span> <span class="o">=</span> <span class="s1">&#39;full&#39;</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
    <span class="n">markersize</span> <span class="o">=</span> <span class="n">fontsize</span> <span class="o">*</span> <span class="mf">1.5</span>
    <span class="n">markersize_small</span> <span class="o">=</span> <span class="n">markersize</span> <span class="o">*</span> <span class="mf">0.2</span>
    <span class="n">beachballsize</span> <span class="o">=</span> <span class="n">markersize</span>
    <span class="n">beachballsize_small</span> <span class="o">=</span> <span class="n">beachballsize</span> <span class="o">*</span> <span class="mf">0.5</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">))</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">hudson</span><span class="o">.</span><span class="n">draw_axes</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m6</span> <span class="ow">in</span> <span class="n">m6s</span><span class="p">:</span>
        <span class="n">mt</span> <span class="o">=</span> <span class="n">mtm</span><span class="o">.</span><span class="n">as_mt</span><span class="p">(</span><span class="n">m6</span><span class="p">)</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">hudson</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">beachball</span><span class="o">.</span><span class="n">plot_beachball_mpl</span><span class="p">(</span>
                    <span class="n">mt</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span>
                    <span class="n">beachball_type</span><span class="o">=</span><span class="n">beachball_type</span><span class="p">,</span>
                    <span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span>
                    <span class="n">size</span><span class="o">=</span><span class="n">beachballsize_small</span><span class="p">,</span>
                    <span class="n">color_t</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">beachball</span><span class="o">.</span><span class="n">BeachballError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="n">ms</span><span class="o">=</span><span class="n">markersize_small</span><span class="p">,</span>
            <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
            <span class="n">mew</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">best_mt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mt</span> <span class="o">=</span> <span class="n">mtm</span><span class="o">.</span><span class="n">as_mt</span><span class="p">(</span><span class="n">best_mt</span><span class="p">)</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">hudson</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">beachball</span><span class="o">.</span><span class="n">plot_beachball_mpl</span><span class="p">(</span>
                <span class="n">mt</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span>
                <span class="n">beachball_type</span><span class="o">=</span><span class="n">beachball_type</span><span class="p">,</span>
                <span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span>
                <span class="n">size</span><span class="o">=</span><span class="n">beachballsize</span><span class="p">,</span>
                <span class="n">color_t</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">beachball</span><span class="o">.</span><span class="n">BeachballError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">moment_tensor</span><span class="p">,</span> <span class="n">mtm</span><span class="o">.</span><span class="n">MomentTensor</span><span class="p">):</span>
        <span class="n">mt</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">moment_tensor</span>
        <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">hudson</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">beachball</span><span class="o">.</span><span class="n">plot_beachball_mpl</span><span class="p">(</span>
                    <span class="n">mt</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span>
                    <span class="n">beachball_type</span><span class="o">=</span><span class="n">beachball_type</span><span class="p">,</span>
                    <span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span>
                    <span class="n">size</span><span class="o">=</span><span class="n">beachballsize</span><span class="p">,</span>
                    <span class="n">color_t</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;drawing reference event in grey ...&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">beachball</span><span class="o">.</span><span class="n">BeachballError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;No reference event moment tensor information given, &#39;</span>
            <span class="s1">&#39;skipping drawing ...&#39;</span><span class="p">)</span>

    <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span>
        <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span>
        <span class="s1">&#39;hudson_</span><span class="si">%i</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%i</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span><span class="p">,</span> <span class="n">llk_str</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">force</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving figure to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plot already exists! Please use --force to overwrite!&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="histplot_op"><a class="viewcode-back" href="../api.html#plotting.histplot_op">[docs]</a><span class="k">def</span> <span class="nf">histplot_op</span><span class="p">(</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">35</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tstd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qlist</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">99.99</span><span class="p">],</span> <span class="n">cbounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modified from pymc3. Additional color argument.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Using color for histogram edgecolor ...&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="k">import</span> <span class="n">Colormap</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmap</span><span class="p">,</span> <span class="n">Colormap</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;The colormap needs to be a valid matplotlib colormap!&#39;</span><span class="p">)</span>

        <span class="n">histtype</span> <span class="o">=</span> <span class="s1">&#39;bar&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">histtype</span> <span class="o">=</span> <span class="s1">&#39;stepfilled&#39;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">quants</span> <span class="o">=</span> <span class="n">quantiles</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">qlist</span><span class="o">=</span><span class="n">qlist</span><span class="p">)</span>
        <span class="n">mind</span> <span class="o">=</span> <span class="n">quants</span><span class="p">[</span><span class="n">qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">maxd</span> <span class="o">=</span> <span class="n">quants</span><span class="p">[</span><span class="n">qlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">reference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mind</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">mind</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>
            <span class="n">maxd</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">maxd</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tstd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tstd</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxd</span> <span class="o">-</span> <span class="n">mind</span><span class="p">)</span> <span class="o">/</span> <span class="mf">40.</span>

        <span class="k">if</span> <span class="n">bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">maxd</span> <span class="o">-</span> <span class="n">mind</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span><span class="p">))</span>

        <span class="n">major</span><span class="p">,</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">get_matplotlib_version</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">major</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;normed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">n</span><span class="p">,</span> <span class="n">outbins</span><span class="p">,</span> <span class="n">patches</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="n">d</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">align</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="n">histtype</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cmap</span><span class="p">:</span>
            <span class="n">bin_centers</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">outbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">outbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">cbounds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">bin_centers</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">bin_centers</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">/=</span> <span class="nb">max</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_centers</span> <span class="o">-</span> <span class="n">cbounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">cbounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cbounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">patches</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;facecolor&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>

        <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
        <span class="n">leftb</span> <span class="o">=</span> <span class="n">mind</span> <span class="o">-</span> <span class="n">tstd</span>
        <span class="n">rightb</span> <span class="o">=</span> <span class="n">maxd</span> <span class="o">+</span> <span class="n">tstd</span>

        <span class="k">if</span> <span class="n">left</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">right</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">leftb</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">leftb</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
            <span class="n">rightb</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">rightb</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">leftb</span><span class="p">,</span> <span class="n">rightb</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">unify_tick_intervals</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">varnames</span><span class="p">,</span> <span class="n">ntickmarks_max</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take figure axes objects and determine unit ranges between common</span>
<span class="sd">    unit classes (see utility.grouped_vars). Assures that the number of</span>
<span class="sd">    increments is not larger than ntickmarks_max. Will thus overwrite</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict : with types_sets keys and (min_range, max_range) as values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unities</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">setname</span> <span class="ow">in</span> <span class="n">utility</span><span class="o">.</span><span class="n">unit_sets</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">unities</span><span class="p">[</span><span class="n">setname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">extract_type_range</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">unities</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">setname</span><span class="p">,</span> <span class="n">ranges</span> <span class="ow">in</span> <span class="n">unities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="n">varrange</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">varrange</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only &quot;x&quot; or &quot;y&quot; allowed!&#39;</span><span class="p">)</span>

            <span class="n">tset</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">unit_sets</span><span class="p">[</span><span class="n">setname</span><span class="p">]</span>
            <span class="n">min_range</span><span class="p">,</span> <span class="n">max_range</span> <span class="o">=</span> <span class="n">ranges</span>
            <span class="k">if</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">tset</span><span class="p">:</span>
                <span class="n">new_ranges</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">varrange</span> <span class="o">&lt;</span> <span class="n">min_range</span><span class="p">:</span>
                    <span class="n">new_ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">varrange</span>
                <span class="k">if</span> <span class="n">varrange</span> <span class="o">&gt;</span> <span class="n">max_range</span><span class="p">:</span>
                    <span class="n">new_ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">varrange</span>

                <span class="n">unities</span><span class="p">[</span><span class="n">setname</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ranges</span>

    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">varname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">),</span> <span class="n">varnames</span><span class="p">):</span>
        <span class="n">extract_type_range</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">unities</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">setname</span><span class="p">,</span> <span class="n">ranges</span> <span class="ow">in</span> <span class="n">unities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">min_range</span><span class="p">,</span> <span class="n">max_range</span> <span class="o">=</span> <span class="n">ranges</span>
        <span class="n">max_range_frac</span> <span class="o">=</span> <span class="n">max_range</span> <span class="o">/</span> <span class="n">ntickmarks_max</span>
        <span class="k">if</span> <span class="n">max_range_frac</span> <span class="o">&gt;</span> <span class="n">min_range</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Range difference between min and max for </span><span class="si">%s</span><span class="s1"> is large!&#39;</span>
                <span class="s1">&#39; Extending min_range to </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">setname</span><span class="p">,</span> <span class="n">max_range_frac</span><span class="p">))</span>
            <span class="n">unities</span><span class="p">[</span><span class="n">setname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">max_range_frac</span><span class="p">,</span> <span class="n">max_range</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">unities</span>


<span class="k">def</span> <span class="nf">apply_unified_axis</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">varnames</span><span class="p">,</span> <span class="n">unities</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ntickmarks_max</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                       <span class="n">scale_factor</span><span class="o">=</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">),</span> <span class="n">varnames</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">utility</span><span class="o">.</span><span class="n">grouped_vars</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">setname</span><span class="p">,</span> <span class="n">varrange</span> <span class="ow">in</span> <span class="n">unities</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">utility</span><span class="o">.</span><span class="n">unit_sets</span><span class="p">[</span><span class="n">setname</span><span class="p">]:</span>
                    <span class="n">inc</span> <span class="o">=</span> <span class="n">nice_value</span><span class="p">(</span><span class="n">varrange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">)</span>
                    <span class="n">autos</span> <span class="o">=</span> <span class="n">AutoScaler</span><span class="p">(</span>
                        <span class="n">inc</span><span class="o">=</span><span class="n">inc</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="s1">&#39;on&#39;</span><span class="p">,</span> <span class="n">approx_ticks</span><span class="o">=</span><span class="n">ntickmarks_max</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                        <span class="nb">min</span><span class="p">,</span> <span class="nb">max</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                        <span class="nb">min</span><span class="p">,</span> <span class="nb">max</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

                    <span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="n">sinc</span> <span class="o">=</span> <span class="n">autos</span><span class="o">.</span><span class="n">make_scale</span><span class="p">(</span>
                        <span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">),</span> <span class="n">override_mode</span><span class="o">=</span><span class="s1">&#39;min-max&#39;</span><span class="p">)</span>

                    <span class="c1"># check physical bounds if passed truncate</span>
                    <span class="n">phys_min</span><span class="p">,</span> <span class="n">phys_max</span> <span class="o">=</span> <span class="n">physical_bounds</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">min</span> <span class="o">&lt;</span> <span class="n">phys_min</span><span class="p">:</span>
                        <span class="nb">min</span> <span class="o">=</span> <span class="n">phys_min</span>
                    <span class="k">if</span> <span class="nb">max</span> <span class="o">&gt;</span> <span class="n">phys_max</span><span class="p">:</span>
                        <span class="nb">max</span> <span class="o">=</span> <span class="n">phys_max</span>

                    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span><span class="p">))</span>

                    <span class="n">ticks</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="nb">max</span> <span class="o">+</span> <span class="n">inc</span><span class="p">,</span> <span class="n">inc</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ticker</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>


<div class="viewcode-block" id="traceplot"><a class="viewcode-back" href="../api.html#plotting.traceplot">[docs]</a><span class="k">def</span> <span class="nf">traceplot</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">varnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">lines</span><span class="o">=</span><span class="p">{},</span> <span class="n">chains</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">varbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source_idxs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">alpha</span><span class="o">=</span><span class="mf">0.35</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prior_alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prior_style</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
              <span class="n">axs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">posterior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_style</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">,</span>
              <span class="n">prior_bounds</span><span class="o">=</span><span class="p">{},</span> <span class="n">unify</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">qlist</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">],</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots posterior pdfs as histograms from multiple mtrace objects.</span>

<span class="sd">    Modified from pymc3.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    trace : result of MCMC run</span>
<span class="sd">    varnames : list of variable names</span>
<span class="sd">        Variables to be plotted, if None all variable are plotted</span>
<span class="sd">    transform : callable</span>
<span class="sd">        Function to transform data (defaults to identity)</span>
<span class="sd">    posterior : str</span>
<span class="sd">        To mark posterior value in distribution &#39;max&#39;, &#39;min&#39;, &#39;mean&#39;, &#39;all&#39;</span>
<span class="sd">    figsize : figure size tuple</span>
<span class="sd">        If None, size is (12, num of variables * 2) inch</span>
<span class="sd">    lines : dict</span>
<span class="sd">        Dictionary of variable name / value  to be overplotted as vertical</span>
<span class="sd">        lines to the posteriors and horizontal lines on sample values</span>
<span class="sd">        e.g. mean of posteriors, true values of a simulation</span>
<span class="sd">    chains : int or list of ints</span>
<span class="sd">        chain indexes to select from the trace</span>
<span class="sd">    combined : bool</span>
<span class="sd">        Flag for combining multiple chains into a single chain. If False</span>
<span class="sd">        (default), chains will be plotted separately.</span>
<span class="sd">    source_idxs : list</span>
<span class="sd">        array like, indexes to sources to plot marginals</span>
<span class="sd">    grid : bool</span>
<span class="sd">        Flag for adding gridlines to histogram. Defaults to True.</span>
<span class="sd">    varbins : list of arrays</span>
<span class="sd">        List containing the binning arrays for the variables, if None they will</span>
<span class="sd">        be created.</span>
<span class="sd">    nbins : int</span>
<span class="sd">        Number of bins for each histogram</span>
<span class="sd">    color : tuple</span>
<span class="sd">        mpl color tuple</span>
<span class="sd">    alpha : float</span>
<span class="sd">        Alpha value for plot line. Defaults to 0.35.</span>
<span class="sd">    axs : axes</span>
<span class="sd">        Matplotlib axes. Defaults to None.</span>
<span class="sd">    fig : figure</span>
<span class="sd">        Matplotlib figure. Defaults to None.</span>
<span class="sd">    unify : bool</span>
<span class="sd">        If true axis units that belong to one group e.g. [km] will</span>
<span class="sd">        have common axis increments</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        for histplot op</span>
<span class="sd">    qlist : list</span>
<span class="sd">        of quantiles to plot. Default: (all, 0., 100.)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    ax : matplotlib axes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ntickmarks</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">ntickmarks_max</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ntickmarks_max&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;scale_factor&#39;</span><span class="p">,</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">num</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_bins</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">qlist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">qlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qu</span> <span class="o">=</span> <span class="n">quantiles</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">qlist</span><span class="o">=</span><span class="n">qlist</span><span class="p">)</span>
            <span class="n">mind</span> <span class="o">=</span> <span class="n">qu</span><span class="p">[</span><span class="n">qlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">maxd</span> <span class="o">=</span> <span class="n">qu</span><span class="p">[</span><span class="n">qlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mind</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">maxd</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mind</span><span class="p">,</span> <span class="n">maxd</span><span class="p">,</span> <span class="n">nbins</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_var</span><span class="p">(</span><span class="n">varnames</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">varnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
        <span class="n">varnames</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">varnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">trace</span><span class="o">.</span><span class="n">varnames</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>

    <span class="k">if</span> <span class="s1">&#39;geo_like&#39;</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
        <span class="n">remove_var</span><span class="p">(</span><span class="n">varnames</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="s1">&#39;geo_like&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;seis_like&#39;</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">:</span>
        <span class="n">remove_var</span><span class="p">(</span><span class="n">varnames</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="s1">&#39;seis_like&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">posterior</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
        <span class="n">llk</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span>
            <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="n">combined</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="n">chains</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">llk</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">transform</span><span class="p">(</span><span class="n">llk</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">llk</span> <span class="o">=</span> <span class="n">pmp</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">make_2d</span><span class="p">(</span><span class="n">llk</span><span class="p">)</span>

        <span class="n">posterior_idxs</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">get_fit_indexes</span><span class="p">(</span><span class="n">llk</span><span class="p">)</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;orange1&#39;</span><span class="p">),</span>
            <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;butter1&#39;</span><span class="p">),</span>
            <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;scarletred2&#39;</span><span class="p">)}</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">varnames</span><span class="p">)</span>
    <span class="n">nrow</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">))</span>
    <span class="n">ncol</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">n_fig</span> <span class="o">=</span> <span class="n">nrow</span> <span class="o">*</span> <span class="n">ncol</span>
    <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a6&#39;</span><span class="p">,</span> <span class="s1">&#39;landscape&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a5&#39;</span><span class="p">,</span> <span class="s1">&#39;portrait&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a4&#39;</span><span class="p">,</span> <span class="s1">&#39;portrait&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">axs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">axs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">axs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">axs</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;traceplot requires n*2 subplots </span><span class="si">%i</span><span class="s1">, </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">varbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">make_bins_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">varbins</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">make_bins_flag</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">input_color</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_fig</span><span class="p">):</span>
        <span class="n">coli</span><span class="p">,</span> <span class="n">rowi</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">mod_i</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">nrow</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">varnames</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">varnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_color</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">trace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span>
                    <span class="n">v</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="n">combined</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="n">chains</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="c1"># iterate over columns in case varsize &gt; 1</span>

                <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dist_vars</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">source_idxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No patches defined using 1 every 10!&#39;</span><span class="p">)</span>
                        <span class="n">source_idxs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;Plotting patches: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">utility</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span>
                            <span class="n">source_idxs</span><span class="p">))</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">selected</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">source_idxs</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
                            <span class="s1">&#39;One or several patches do not exist! &#39;</span>
                            <span class="s1">&#39;Patch idxs: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">utility</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span>
                                <span class="n">source_idxs</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">selected</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">T</span>

                <span class="k">for</span> <span class="n">isource</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected</span><span class="p">):</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">pmp</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">make_2d</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">make_bins_flag</span><span class="p">:</span>
                        <span class="n">varbin</span> <span class="o">=</span> <span class="n">make_bins</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="n">nbins</span><span class="p">,</span> <span class="n">qlist</span><span class="o">=</span><span class="n">qlist</span><span class="p">)</span>
                        <span class="n">varbins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">varbin</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">varbin</span> <span class="o">=</span> <span class="n">varbins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                            <span class="n">reference</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">reference</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">reference</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pcolor</span> <span class="o">=</span> <span class="n">mpl_graph_color</span><span class="p">(</span><span class="n">isource</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pcolor</span> <span class="o">=</span> <span class="n">color</span>

                    <span class="k">if</span> <span class="n">plot_style</span> <span class="o">==</span> <span class="s1">&#39;kde&#39;</span><span class="p">:</span>
                        <span class="n">pmp</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span>
                            <span class="n">e</span><span class="p">,</span> <span class="n">shade</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">],</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                            <span class="n">kwargs_shade</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">pcolor</span><span class="p">})</span>
                        <span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">]</span><span class="o">.</span><span class="n">relim</span><span class="p">()</span>
                        <span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">]</span><span class="o">.</span><span class="n">autoscale</span><span class="p">(</span><span class="n">tight</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">xax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span>
                        <span class="c1"># axs[rowi, coli].set_ylim([0, e.max()])</span>
                        <span class="n">xticker</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                        <span class="n">xax</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">xticker</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">plot_style</span> <span class="o">==</span> <span class="s1">&#39;hist&#39;</span><span class="p">:</span>
                        <span class="n">histplot_op</span><span class="p">(</span>
                            <span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">],</span> <span class="n">e</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
                            <span class="n">bins</span><span class="o">=</span><span class="n">varbin</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">pcolor</span><span class="p">,</span>
                            <span class="n">qlist</span><span class="o">=</span><span class="n">qlist</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                            <span class="s1">&#39;Plot style &quot;</span><span class="si">%s</span><span class="s1">&quot; not implemented&#39;</span> <span class="o">%</span> <span class="n">plot_style</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">param</span> <span class="o">=</span> <span class="n">prior_bounds</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

                        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dist_vars</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>  <span class="c1"># variable bounds</span>
                                <span class="n">lower</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">lower</span><span class="p">[</span><span class="n">source_idxs</span><span class="p">]</span>
                                <span class="n">upper</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">upper</span><span class="p">[</span><span class="n">source_idxs</span><span class="p">]</span>
                            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                                <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">upper</span>

                            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">plot_units</span><span class="p">[</span><span class="n">hypername</span><span class="p">(</span><span class="n">v</span><span class="p">)])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lower</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span>
                                <span class="n">param</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">upper</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span>
                                <span class="n">param</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> priors: (</span><span class="si">{}</span><span class="s1">; </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">v</span><span class="p">,</span> <span class="n">plot_units</span><span class="p">[</span><span class="n">hypername</span><span class="p">(</span><span class="n">v</span><span class="p">)],</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">v</span><span class="p">]))</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">plot_units</span><span class="p">[</span><span class="n">hypername</span><span class="p">(</span><span class="n">v</span><span class="p">)])</span>

                    <span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">format_axes</span><span class="p">(</span><span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">])</span>
                    <span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="c1">#                axs[rowi, coli].set_ylabel(&quot;Frequency&quot;)</span>

                    <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                                <span class="n">x</span><span class="o">=</span><span class="n">lines</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">pass</span>

                    <span class="k">if</span> <span class="n">posterior</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">posterior</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">posterior_idxs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                                    <span class="n">x</span><span class="o">=</span><span class="n">e</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">idx</span> <span class="o">=</span> <span class="n">posterior_idxs</span><span class="p">[</span><span class="n">posterior</span><span class="p">]</span>
                            <span class="n">axs</span><span class="p">[</span><span class="n">rowi</span><span class="p">,</span> <span class="n">coli</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                                <span class="n">x</span><span class="o">=</span><span class="n">e</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">pcolor</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">unify</span><span class="p">:</span>
        <span class="n">unities</span> <span class="o">=</span> <span class="n">unify_tick_intervals</span><span class="p">(</span>
            <span class="n">axs</span><span class="p">,</span> <span class="n">varnames</span><span class="p">,</span> <span class="n">ntickmarks_max</span><span class="o">=</span><span class="n">ntickmarks_max</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">apply_unified_axis</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">varnames</span><span class="p">,</span> <span class="n">unities</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                           <span class="n">scale_factor</span><span class="o">=</span><span class="n">scale_factor</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">source_idxs</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">source_idxs</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span><span class="p">,</span> <span class="n">varbins</span></div>


<span class="k">def</span> <span class="nf">get_matplotlib_version</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">mplversion</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">mplversion</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">mplversion</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>


<div class="viewcode-block" id="select_transform"><a class="viewcode-back" href="../api.html#plotting.select_transform">[docs]</a><span class="k">def</span> <span class="nf">select_transform</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select transform function to be applied after loading the sampling results.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sc : :class:`config.SamplerConfig`</span>
<span class="sd">        Name of the sampler that has been used in sampling the posterior pdf</span>
<span class="sd">    n_steps : int</span>
<span class="sd">        Number of chains to select last samples of each trace.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    func : instance</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pa</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parameters</span>

    <span class="k">def</span> <span class="nf">last_sample</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[(</span><span class="n">n_steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)::</span><span class="n">n_steps</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">burn_sample</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n_steps</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nchains</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">n_steps</span>
            <span class="n">xout</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchains</span><span class="p">):</span>
                <span class="n">nstart</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">n_steps</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">n_steps</span> <span class="o">*</span> <span class="n">pa</span><span class="o">.</span><span class="n">burn</span><span class="p">))</span>
                <span class="n">nend</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_steps</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">xout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">nstart</span><span class="p">:</span><span class="n">nend</span><span class="p">:</span><span class="n">pa</span><span class="o">.</span><span class="n">thin</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">standard</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">if</span> <span class="n">n_steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">standard</span>

    <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;SMC&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">last_sample</span>
    <span class="k">elif</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Metropolis&#39;</span> <span class="ow">or</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;PT&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">burn_sample</span></div>


<span class="k">def</span> <span class="nf">select_metropolis_chains</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">mtrace</span><span class="p">,</span> <span class="n">post_llk</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select chains from Multitrace</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">draws</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mtrace</span><span class="p">)</span>

    <span class="n">llks</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mtrace</span><span class="o">.</span><span class="n">point</span><span class="p">(</span>
        <span class="n">draws</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">chain</span><span class="p">)[</span>
            <span class="n">problem</span><span class="o">.</span><span class="n">_like_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">mtrace</span><span class="o">.</span><span class="n">chains</span><span class="p">])</span>

    <span class="n">chain_idxs</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">get_fit_indexes</span><span class="p">(</span><span class="n">llks</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chain_idxs</span><span class="p">[</span><span class="n">post_llk</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">draw_posteriors</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">plot_options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Identify which stage is the last complete stage and plot posteriors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">hypers</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">check_hyper_flag</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>
    <span class="n">po</span> <span class="o">=</span> <span class="n">plot_options</span>

    <span class="n">stage</span> <span class="o">=</span> <span class="n">Stage</span><span class="p">(</span><span class="n">homepath</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span>
                  <span class="n">backend</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sampler_config</span><span class="o">.</span><span class="n">backend</span><span class="p">)</span>

    <span class="n">pc</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span>

    <span class="n">list_indexes</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">get_stage_indexes</span><span class="p">(</span><span class="n">po</span><span class="o">.</span><span class="n">load_stage</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">hypers</span><span class="p">:</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hyper_sampler_config</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">hypernames</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;like&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sampler_config</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">varnames</span> <span class="o">+</span> <span class="n">problem</span><span class="o">.</span><span class="n">hypernames</span> <span class="o">+</span> \
            <span class="n">problem</span><span class="o">.</span><span class="n">hierarchicalnames</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;like&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">po</span><span class="o">.</span><span class="n">varnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">varnames</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plotting variables: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">))))</span>
    <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">list_indexes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">draws</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">hypers</span> <span class="ow">and</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Metropolis&#39;</span><span class="p">:</span>
            <span class="n">draws</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">n_steps</span> <span class="o">*</span> <span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">draws</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">transform</span> <span class="o">=</span> <span class="n">select_transform</span><span class="p">(</span><span class="n">sc</span><span class="o">=</span><span class="n">sc</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="n">draws</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">source_idxs</span><span class="p">:</span>
            <span class="n">sidxs</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">po</span><span class="o">.</span><span class="n">source_idxs</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sidxs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span>
            <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span>
            <span class="s1">&#39;stage_</span><span class="si">%i</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidxs</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plotting stage: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">stage</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">stage_path</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="n">stage</span><span class="o">.</span><span class="n">load_results</span><span class="p">(</span>
                <span class="n">varnames</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">varnames</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">problem</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">stage_number</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                <span class="n">load</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Metropolis&#39;</span> <span class="ow">and</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">chains</span> <span class="o">=</span> <span class="n">select_metropolis_chains</span><span class="p">(</span>
                    <span class="n">problem</span><span class="p">,</span> <span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plotting result: </span><span class="si">%s</span><span class="s1"> of Metropolis chain </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">,</span> <span class="n">chains</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chains</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">prior_bounds</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">prior_bounds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">pc</span><span class="o">.</span><span class="n">hyperparameters</span><span class="p">)</span>
            <span class="n">prior_bounds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">pc</span><span class="o">.</span><span class="n">hierarchicals</span><span class="p">)</span>
            <span class="n">prior_bounds</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">pc</span><span class="o">.</span><span class="n">priors</span><span class="p">)</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">traceplot</span><span class="p">(</span>
                <span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span><span class="p">,</span>
                <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
                <span class="n">chains</span><span class="o">=</span><span class="n">chains</span><span class="p">,</span>
                <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">source_idxs</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">source_idxs</span><span class="p">,</span>
                <span class="n">plot_style</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span>
                <span class="n">lines</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">,</span>
                <span class="n">posterior</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">,</span>
                <span class="n">prior_bounds</span><span class="o">=</span><span class="n">prior_bounds</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving figure to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;plot for stage </span><span class="si">%s</span><span class="s1"> exists. Use force=True for&#39;</span>
                <span class="s1">&#39; replotting!&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">draw_correlation_hist</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">plot_options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw parameter correlation plot and histograms from the final atmip stage.</span>
<span class="sd">    Only feasible for &#39;geometry&#39; problem.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">n_sources</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;correlation_hist plot not working (yet) for n_sources &gt; 1&#39;</span><span class="p">)</span>

    <span class="n">po</span> <span class="o">=</span> <span class="n">plot_options</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">mode</span>

    <span class="k">assert</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">geometry_mode_str</span>
    <span class="k">assert</span> <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span> <span class="o">!=</span> <span class="mi">0</span>

    <span class="n">hypers</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">check_hyper_flag</span><span class="p">(</span><span class="n">problem</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">hypers</span><span class="p">:</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hyper_sampler_config</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">hypernames</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sampler_config</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">varnames</span><span class="p">)</span> <span class="o">+</span> <span class="n">problem</span><span class="o">.</span><span class="n">hypernames</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;like&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">po</span><span class="o">.</span><span class="n">varnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">varnames</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">varnames</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plotting variables: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">varnames</span><span class="p">))))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">varnames</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Need at least two parameters to compare!&#39;</span>
                        <span class="s1">&#39;Found only </span><span class="si">%i</span><span class="s1"> variables! &#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">varnames</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">hypers</span> <span class="ow">and</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Metropolis&#39;</span><span class="p">:</span>
        <span class="n">draws</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">n_steps</span> <span class="o">*</span> <span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">draws</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">transform</span> <span class="o">=</span> <span class="n">select_transform</span><span class="p">(</span><span class="n">sc</span><span class="o">=</span><span class="n">sc</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="n">draws</span><span class="p">)</span>

    <span class="n">stage</span> <span class="o">=</span> <span class="n">load_stage</span><span class="p">(</span>
        <span class="n">problem</span><span class="p">,</span> <span class="n">stage_number</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">load_stage</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Metropolis&#39;</span> <span class="ow">and</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">chains</span> <span class="o">=</span> <span class="n">select_metropolis_chains</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;plotting result: </span><span class="si">%s</span><span class="s1"> of Metropolis chain </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">,</span> <span class="n">chains</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chains</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">:</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="n">get_result_point</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">)</span>
        <span class="n">llk_str</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span>
        <span class="n">llk_str</span> <span class="o">=</span> <span class="s1">&#39;ref&#39;</span>

    <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span> <span class="s1">&#39;corr_hist_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">stage</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">llk_str</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">correlation_plot_hist</span><span class="p">(</span>
            <span class="n">mtrace</span><span class="o">=</span><span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span><span class="p">,</span>
            <span class="n">varnames</span><span class="o">=</span><span class="n">varnames</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_earth_r</span><span class="p">,</span>
            <span class="n">chains</span><span class="o">=</span><span class="n">chains</span><span class="p">,</span>
            <span class="n">point</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
            <span class="n">point_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
            <span class="n">point_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;correlation plot exists. Use force=True for replotting!&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving figure to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">n_model_plot</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">draw_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">highlightidx</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot cake layered earth models.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mpl_init</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a6&#39;</span><span class="p">,</span> <span class="s1">&#39;portrait&#39;</span><span class="p">))</span>
        <span class="n">labelpos</span> <span class="o">=</span> <span class="n">mpl_margins</span><span class="p">(</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">labelpos</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_profile</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">vp_c</span><span class="p">,</span> <span class="n">vs_c</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
        <span class="n">vp</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="s1">&#39;vp&#39;</span><span class="p">)</span>
        <span class="n">vs</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">profile</span><span class="p">(</span><span class="s1">&#39;vs&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vp</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">vp_c</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vs</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">vs_c</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>

    <span class="n">cp</span><span class="o">.</span><span class="n">labelspace</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
    <span class="n">cp</span><span class="o">.</span><span class="n">labels_model</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">draw_bg</span><span class="p">:</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">sketch_model</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ref_vp_c</span> <span class="o">=</span> <span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;aluminium5&#39;</span><span class="p">)</span>
    <span class="n">ref_vs_c</span> <span class="o">=</span> <span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;aluminium5&#39;</span><span class="p">)</span>
    <span class="n">vp_c</span> <span class="o">=</span> <span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;scarletred2&#39;</span><span class="p">)</span>
    <span class="n">vs_c</span> <span class="o">=</span> <span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;skyblue2&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
        <span class="n">plot_profile</span><span class="p">(</span>
            <span class="n">mod</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">vp_c</span><span class="o">=</span><span class="n">light</span><span class="p">(</span><span class="n">vp_c</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span> <span class="n">vs_c</span><span class="o">=</span><span class="n">light</span><span class="p">(</span><span class="n">vs_c</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">highlightidx</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">vpcolor</span> <span class="o">=</span> <span class="n">ref_vp_c</span>
            <span class="n">vscolor</span> <span class="o">=</span> <span class="n">ref_vs_c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vpcolor</span> <span class="o">=</span> <span class="n">vp_c</span>
            <span class="n">vscolor</span> <span class="o">=</span> <span class="n">vs_c</span>

        <span class="n">plot_profile</span><span class="p">(</span>
            <span class="n">models</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axes</span><span class="p">,</span> <span class="n">vp_c</span><span class="o">=</span><span class="n">vpcolor</span><span class="p">,</span> <span class="n">vs_c</span><span class="o">=</span><span class="n">vscolor</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.</span><span class="p">)</span>

    <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">my</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.05</span>
    <span class="n">mx</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">-</span> <span class="n">my</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">+</span> <span class="n">mx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span>


<span class="k">def</span> <span class="nf">load_earthmodels</span><span class="p">(</span><span class="n">store_superdir</span><span class="p">,</span> <span class="n">store_ids</span><span class="p">,</span> <span class="n">depth_max</span><span class="o">=</span><span class="s1">&#39;cmb&#39;</span><span class="p">):</span>

    <span class="n">ems</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">emr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">store_id</span> <span class="ow">in</span> <span class="n">store_ids</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">store_superdir</span><span class="p">,</span> <span class="n">store_id</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
        <span class="n">em</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">earthmodel_1d</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">depth_max</span><span class="o">=</span><span class="n">depth_max</span><span class="p">)</span>
        <span class="n">ems</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">em</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">earthmodel_receiver_1d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">emr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">earthmodel_receiver_1d</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">ems</span><span class="p">,</span> <span class="n">emr</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">draw_earthmodels</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">plot_options</span><span class="p">):</span>

    <span class="n">po</span> <span class="o">=</span> <span class="n">plot_options</span>

    <span class="k">for</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">composite</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">composites</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;seismic&#39;</span><span class="p">:</span>
            <span class="n">models_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sc</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">seismic_config</span>

            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">reference_location</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plot_stations</span> <span class="o">=</span> <span class="n">composite</span><span class="o">.</span><span class="n">datahandler</span><span class="o">.</span><span class="n">stations</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_stations</span> <span class="o">=</span> <span class="p">[</span><span class="n">composite</span><span class="o">.</span><span class="n">datahandler</span><span class="o">.</span><span class="n">stations</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">plot_stations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">station</span> <span class="o">=</span> \
                    <span class="n">sc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">reference_location</span><span class="o">.</span><span class="n">station</span>

            <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">plot_stations</span><span class="p">:</span>
                <span class="n">outbasepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_velocity_model&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">datatype</span><span class="p">,</span> <span class="n">station</span><span class="o">.</span><span class="n">station</span><span class="p">))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outbasepath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
                    <span class="n">targets</span> <span class="o">=</span> <span class="n">init_seismic_targets</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">station</span><span class="p">],</span>
                        <span class="n">earth_model_name</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">earth_model_name</span><span class="p">,</span>
                        <span class="n">channels</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">get_unique_channels</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">sample_rate</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">,</span>
                        <span class="n">crust_inds</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">sc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">n_variations</span><span class="p">)),</span>
                        <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;multilinear&#39;</span><span class="p">)</span>
                    <span class="n">store_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">store_id</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">]</span>

                    <span class="n">models</span> <span class="o">=</span> <span class="n">load_earthmodels</span><span class="p">(</span>
                        <span class="n">composite</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">store_superdirs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">store_ids</span><span class="p">,</span>
                        <span class="n">depth_max</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">depth_limit_variation</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mods</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">site</span> <span class="o">=</span> <span class="s1">&#39;source&#39;</span>
                        <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">site</span> <span class="o">=</span> <span class="s1">&#39;receiver&#39;</span>

                        <span class="n">outpath</span> <span class="o">=</span> <span class="n">outbasepath</span> <span class="o">+</span> \
                            <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">)</span>

                        <span class="n">models_dict</span><span class="p">[</span><span class="n">outpath</span><span class="p">]</span> <span class="o">=</span> <span class="n">mods</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> earthmodel plot for station </span><span class="si">%s</span><span class="s1"> exists. Use &#39;</span>
                        <span class="s1">&#39;force=True for replotting!&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">datatype</span><span class="p">,</span> <span class="n">station</span><span class="o">.</span><span class="n">station</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;geodetic&#39;</span><span class="p">:</span>
            <span class="n">gc</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">geodetic_config</span>

            <span class="n">models_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_velocity_model.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">datatype</span><span class="p">,</span> <span class="s1">&#39;psgrn&#39;</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
                <span class="n">targets</span> <span class="o">=</span> <span class="n">init_geodetic_targets</span><span class="p">(</span>
                    <span class="n">datasets</span><span class="o">=</span><span class="n">composite</span><span class="o">.</span><span class="n">datasets</span><span class="p">,</span>
                    <span class="n">earth_model_name</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">earth_model_name</span><span class="p">,</span>
                    <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;multilinear&#39;</span><span class="p">,</span>
                    <span class="n">crust_inds</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">gc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">n_variations</span><span class="p">)),</span>
                    <span class="n">sample_rate</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">)</span>

                <span class="n">models</span> <span class="o">=</span> <span class="n">load_earthmodels</span><span class="p">(</span>
                    <span class="n">store_superdir</span><span class="o">=</span><span class="n">composite</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">store_superdirs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span>
                    <span class="n">depth_max</span><span class="o">=</span><span class="n">gc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">source_depth_max</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>
                <span class="n">models_dict</span><span class="p">[</span><span class="n">outpath</span><span class="p">]</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># select only source site</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> earthmodel plot exists. Use force=True for&#39;</span>
                    <span class="s1">&#39; replotting!&#39;</span> <span class="o">%</span> <span class="n">datatype</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;Plot for datatype </span><span class="si">%s</span><span class="s1"> not (yet) supported&#39;</span> <span class="o">%</span> <span class="n">datatype</span><span class="p">)</span>

        <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tobepopped</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">models</span> <span class="ow">in</span> <span class="n">models_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">n_model_plot</span><span class="p">(</span>
                    <span class="n">models</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">draw_bg</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">,</span> <span class="n">highlightidx</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">axs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tobepopped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">tobepopped</span><span class="p">:</span>
            <span class="n">models_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fig</span><span class="p">,</span> <span class="n">outpath</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">figs</span><span class="p">,</span> <span class="n">models_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving figure to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fuzzy_waveforms</span><span class="p">(</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">traces</span><span class="p">,</span> <span class="n">linewidth</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">grid_size</span><span class="o">=</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fuzzy waveforms</span>

<span class="sd">    traces : list</span>
<span class="sd">        of class:`pyrocko.trace.Trace`, the times of the traces should not</span>
<span class="sd">        vary too much</span>
<span class="sd">    zorder : int</span>
<span class="sd">        the higher number is drawn above the lower number</span>
<span class="sd">    extent : list</span>
<span class="sd">        of [xmin, xmax, ymin, ymax] (tmin, tmax, min/max of amplitudes)</span>
<span class="sd">        if None, the default is to determine it from traces list</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="k">import</span> <span class="n">LinearSegmentedColormap</span>

        <span class="n">ncolors</span> <span class="o">=</span> <span class="mi">256</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span>
            <span class="s1">&#39;dummy&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;chocolate2&#39;</span><span class="p">),</span> <span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;scarletred2&#39;</span><span class="p">)],</span>
            <span class="n">N</span><span class="o">=</span><span class="n">ncolors</span><span class="p">)</span>
        <span class="c1"># cmap = plt.cm.gist_earth_r</span>

    <span class="k">if</span> <span class="n">extent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">channel</span>
        <span class="n">skey</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tr</span><span class="p">:</span> <span class="n">tr</span><span class="o">.</span><span class="n">channel</span>

        <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">minmax</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">skey</span><span class="p">)[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">minmaxtime</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">skey</span><span class="p">)[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ymin</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ymax</span><span class="p">))</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="o">-</span><span class="n">ymax</span>

        <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>

        <span class="n">draw_line_on_array</span><span class="p">(</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">(),</span> <span class="n">tr</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span>
            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
            <span class="n">grid_resolution</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>

    <span class="c1"># increase contrast reduce high intense values</span>
    <span class="c1"># truncate = len(traces) / 2</span>
    <span class="c1"># grid[grid &gt; truncate] = truncate</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">grid</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fuzzy_rupture_fronts</span><span class="p">(</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">rupture_fronts</span><span class="p">,</span> <span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fuzzy rupture fronts</span>

<span class="sd">    rupture_fronts : list</span>
<span class="sd">        of output of cs = pyplot.contour; cs.allsegs</span>
<span class="sd">    xgrid : array_like</span>
<span class="sd">        of center coordinates of the sub-patches of the fault in</span>
<span class="sd">        strike-direction in [km]</span>
<span class="sd">    ygrid : array_like</span>
<span class="sd">        of center coordinates of the sub-patches of the fault in</span>
<span class="sd">        dip-direction in [km]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="k">import</span> <span class="n">LinearSegmentedColormap</span>

    <span class="n">ncolors</span> <span class="o">=</span> <span class="mi">256</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span>
        <span class="s1">&#39;dummy&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">],</span> <span class="n">N</span><span class="o">=</span><span class="n">ncolors</span><span class="p">)</span>

    <span class="n">res_km</span> <span class="o">=</span> <span class="mi">25</span>   <span class="c1"># pixel per km</span>

    <span class="n">xmin</span> <span class="o">=</span> <span class="n">xgrid</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">xgrid</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">ygrid</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">ygrid</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
        <span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ymax</span><span class="p">)</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ymin</span><span class="p">))</span> <span class="o">*</span> <span class="n">res_km</span><span class="p">),</span>
         <span class="nb">int</span><span class="p">((</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xmax</span><span class="p">)</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xmin</span><span class="p">))</span> <span class="o">*</span> <span class="n">res_km</span><span class="p">)),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rupture_front</span> <span class="ow">in</span> <span class="n">rupture_fronts</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">rupture_front</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">level</span><span class="p">:</span>
                <span class="n">draw_line_on_array</span><span class="p">(</span>
                    <span class="n">line</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">line</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                    <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
                    <span class="n">grid_resolution</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>

    <span class="c1"># increase contrast reduce high intense values</span>
    <span class="n">truncate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rupture_fronts</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">grid</span><span class="p">[</span><span class="n">grid</span> <span class="o">&gt;</span> <span class="n">truncate</span><span class="p">]</span> <span class="o">=</span> <span class="n">truncate</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">grid</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fault_slip_distribution</span><span class="p">(</span>
        <span class="n">fault</span><span class="p">,</span> <span class="n">mtrace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">ntickmarks</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">reference</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nensemble</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw discretized fault geometry rotated to the 2-d view of the foot-wall</span>
<span class="sd">    of the fault.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fault : :class:`ffi.fault.FaultGeometry`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">draw_quivers</span><span class="p">(</span>
            <span class="n">ax</span><span class="p">,</span> <span class="n">uperp</span><span class="p">,</span> <span class="n">uparr</span><span class="p">,</span> <span class="n">xgr</span><span class="p">,</span> <span class="n">ygr</span><span class="p">,</span> <span class="n">rake</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
            <span class="n">draw_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalisation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="c1"># positive uperp is always dip-normal- have to multiply -1</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="n">uperp</span><span class="p">,</span> <span class="n">uparr</span><span class="p">)</span> <span class="o">*</span> <span class="n">mt</span><span class="o">.</span><span class="n">r2d</span> <span class="o">+</span> <span class="n">rake</span>
        <span class="n">slips</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">uperp</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">uparr</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">normalisation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">beat.models.laplacian</span> <span class="k">import</span> <span class="n">distances</span>
            <span class="n">centers</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xgr</span><span class="p">,</span> <span class="n">ygr</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="c1">#interpatch_dists = distances(centers, centers)</span>
            <span class="n">normalisation</span> <span class="o">=</span> <span class="n">slips</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="c1">#/ interpatch_dists.min()</span>

        <span class="n">slips</span> <span class="o">/=</span> <span class="n">normalisation</span>

        <span class="n">slipsx</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span> <span class="o">*</span> <span class="n">mt</span><span class="o">.</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">slips</span>
        <span class="n">slipsy</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angles</span> <span class="o">*</span> <span class="n">mt</span><span class="o">.</span><span class="n">d2r</span><span class="p">)</span> <span class="o">*</span> <span class="n">slips</span>

        <span class="c1"># slip arrows of slip on patches</span>
        <span class="n">quivers</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span>
            <span class="n">xgr</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">ygr</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">slipsx</span><span class="p">,</span> <span class="n">slipsy</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="s1">&#39;dots&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="n">scale_units</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">draw_legend</span><span class="p">:</span>
            <span class="n">quiver_legend_length</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span>
                <span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">slips</span> <span class="o">*</span> <span class="n">normalisation</span><span class="p">)</span> <span class="o">*</span> <span class="mf">10.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.</span>

            <span class="c1"># ax.quiverkey(</span>
            <span class="c1">#    quivers, 0.9, 0.8, quiver_legend_length,</span>
            <span class="c1">#    &#39;{} [m]&#39;.format(quiver_legend_length), labelpos=&#39;E&#39;,</span>
            <span class="c1">#    coordinates=&#39;figure&#39;)</span>

        <span class="k">return</span> <span class="n">quivers</span><span class="p">,</span> <span class="n">normalisation</span>

    <span class="k">def</span> <span class="nf">rotate_coords_plane_normal</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">sf</span><span class="p">):</span>

        <span class="n">coords</span> <span class="o">-=</span> <span class="n">sf</span><span class="o">.</span><span class="n">bottom_left</span> <span class="o">/</span> <span class="n">km</span>

        <span class="n">rots</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">get_rotation_matrix</span><span class="p">()</span>
        <span class="n">rotz</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rots</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">](</span><span class="n">mt</span><span class="o">.</span><span class="n">d2r</span> <span class="o">*</span> <span class="o">-</span><span class="n">sf</span><span class="o">.</span><span class="n">strike</span><span class="p">))</span>
        <span class="n">roty</span> <span class="o">=</span> <span class="n">rotz</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rots</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">](</span><span class="n">mt</span><span class="o">.</span><span class="n">d2r</span> <span class="o">*</span> <span class="o">-</span><span class="n">sf</span><span class="o">.</span><span class="n">dip</span><span class="p">))</span>

        <span class="n">roty</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span> <span class="mf">1.</span>
        <span class="k">return</span> <span class="n">roty</span>

    <span class="k">def</span> <span class="nf">draw_patches</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">fault</span><span class="p">,</span> <span class="n">subfault_idx</span><span class="p">,</span> <span class="n">patch_values</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>

        <span class="n">lls</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">get_subfault_patch_attributes</span><span class="p">(</span>
            <span class="n">subfault_idx</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;bottom_left&#39;</span><span class="p">])</span>
        <span class="n">widths</span><span class="p">,</span> <span class="n">lengths</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">get_subfault_patch_attributes</span><span class="p">(</span>
            <span class="n">subfault_idx</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">])</span>
        <span class="n">sf</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">get_subfault</span><span class="p">(</span><span class="n">subfault_idx</span><span class="p">)</span>

        <span class="c1"># subtract reference fault lower left and rotate</span>
        <span class="n">rot_lls</span> <span class="o">=</span> <span class="n">rotate_coords_plane_normal</span><span class="p">(</span><span class="n">lls</span><span class="p">,</span> <span class="n">sf</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">d_patches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ll</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rot_lls</span><span class="p">,</span> <span class="n">widths</span><span class="p">,</span> <span class="n">lengths</span><span class="p">):</span>
            <span class="n">d_patches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Rectangle</span><span class="p">(</span>
                    <span class="n">ll</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>

        <span class="n">lower</span> <span class="o">=</span> <span class="n">rot_lls</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="n">km</span> <span class="o">*</span> <span class="mf">0.05</span>

        <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="n">lower</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pad</span><span class="p">,</span> <span class="n">lower</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">sf</span><span class="o">.</span><span class="n">length</span> <span class="o">/</span> <span class="n">km</span> <span class="o">+</span> <span class="n">pad</span><span class="p">]</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="n">lower</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span> <span class="n">pad</span><span class="p">,</span> <span class="n">lower</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">sf</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">km</span> <span class="o">+</span> <span class="n">pad</span><span class="p">]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">*</span><span class="n">ylim</span><span class="p">)</span>

        <span class="n">scale_y</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;offset&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">sf</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">km</span><span class="p">)}</span>
        <span class="n">scale_axes</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="p">,</span> <span class="o">**</span><span class="n">scale_y</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;strike-direction [km]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;dip-direction [km]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="n">xticker</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="n">ntickmarks</span><span class="p">)</span>
        <span class="n">yticker</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="n">ntickmarks</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">xticker</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">yticker</span><span class="p">)</span>

        <span class="n">pa_col</span> <span class="o">=</span> <span class="n">PatchCollection</span><span class="p">(</span>
            <span class="n">d_patches</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">match_original</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pa_col</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="n">patch_values</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">pa_col</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pa_col</span>

    <span class="k">def</span> <span class="nf">draw_colorbar</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cb_related</span><span class="p">,</span> <span class="n">labeltext</span><span class="p">,</span> <span class="n">ntickmarks</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">cbaxes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.88</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb_related</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbaxes</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">labeltext</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="n">ntickmarks</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_values_from_trace</span><span class="p">(</span><span class="n">mtrace</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">reference</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span>
                <span class="n">mtrace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span>
                    <span class="n">varname</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">except</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">reference</span><span class="p">[</span><span class="n">varname</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">u</span>

    <span class="kn">from</span> <span class="nn">beat.colormap</span> <span class="k">import</span> <span class="n">slip_colormap</span>
    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="n">reference_slip</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">reference</span><span class="p">[</span><span class="s1">&#39;uperp&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">reference</span><span class="p">[</span><span class="s1">&#39;uparr&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ns</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fault</span><span class="o">.</span><span class="n">nsubfaults</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a5&#39;</span><span class="p">,</span> <span class="s1">&#39;landscape&#39;</span><span class="p">))</span>

        <span class="c1"># alphas = alpha * num.ones(np_h * np_w, dtype=&#39;int8&#39;)</span>

        <span class="n">ext_source</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">get_subfault</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s1">&#39;uparr&#39;</span><span class="p">)</span>
        <span class="n">patch_idxs</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">get_patch_indexes</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>

        <span class="n">pa_col</span> <span class="o">=</span> <span class="n">draw_patches</span><span class="p">(</span>
            <span class="n">ax</span><span class="p">,</span> <span class="n">fault</span><span class="p">,</span>
            <span class="n">subfault_idx</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span>
            <span class="n">patch_values</span><span class="o">=</span><span class="n">reference_slip</span><span class="p">[</span><span class="n">patch_idxs</span><span class="p">],</span>
            <span class="n">cmap</span><span class="o">=</span><span class="n">slip_colormap</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.65</span><span class="p">)</span>

        <span class="c1"># patch central locations</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">get_subfault_patch_attributes</span><span class="p">(</span>
            <span class="n">ns</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;center&#39;</span><span class="p">])</span>
        <span class="n">rot_centers</span> <span class="o">=</span> <span class="n">rotate_coords_plane_normal</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span> <span class="n">ext_source</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">xgr</span><span class="p">,</span> <span class="n">ygr</span> <span class="o">=</span> <span class="n">rot_centers</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="s1">&#39;seismic&#39;</span> <span class="ow">in</span> <span class="n">fault</span><span class="o">.</span><span class="n">datatypes</span><span class="p">:</span>
            <span class="n">shp</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">ordering</span><span class="o">.</span><span class="n">get_subfault_discretization</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
            <span class="n">xgr</span> <span class="o">=</span> <span class="n">xgr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>
            <span class="n">ygr</span> <span class="o">=</span> <span class="n">ygr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">shp</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">mtrace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
                <span class="n">nuc_dip</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">mtrace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span>
                    <span class="s1">&#39;nucleation_dip&#39;</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="n">nuc_strike</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">mtrace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span>
                    <span class="s1">&#39;nucleation_strike&#39;</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="n">velocities</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">mtrace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span>
                    <span class="s1">&#39;velocities&#39;</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="n">nchains</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mtrace</span><span class="p">)</span>
                <span class="n">csteps</span> <span class="o">=</span> <span class="mi">6</span>
                <span class="n">rupture_fronts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">dummy_fig</span><span class="p">,</span> <span class="n">dummy_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                    <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a5&#39;</span><span class="p">,</span> <span class="s1">&#39;landscape&#39;</span><span class="p">))</span>
                <span class="n">csteps</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nchains</span><span class="p">)</span> <span class="o">/</span> <span class="n">nensemble</span>
                <span class="n">idxs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                    <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchains</span><span class="p">,</span> <span class="n">csteps</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Rendering rupture fronts ...&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">idxs</span><span class="p">):</span>
                    <span class="n">nuc_dip_idx</span><span class="p">,</span> <span class="n">nuc_strike_idx</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">fault_locations2idxs</span><span class="p">(</span>
                        <span class="n">ns</span><span class="p">,</span> <span class="n">nuc_dip</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nuc_strike</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
                    <span class="n">veloc_ns</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">vector2subfault</span><span class="p">(</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="n">velocities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
                    <span class="n">sts</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">get_subfault_starttimes</span><span class="p">(</span>
                        <span class="n">ns</span><span class="p">,</span> <span class="n">veloc_ns</span><span class="p">,</span> <span class="n">nuc_dip_idx</span><span class="p">[</span><span class="n">ns</span><span class="p">],</span> <span class="n">nuc_strike_idx</span><span class="p">[</span><span class="n">ns</span><span class="p">])</span>

                    <span class="n">contours</span> <span class="o">=</span> <span class="n">dummy_ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xgr</span><span class="p">,</span> <span class="n">ygr</span><span class="p">,</span> <span class="n">sts</span><span class="p">)</span>
                    <span class="n">rupture_fronts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contours</span><span class="o">.</span><span class="n">allsegs</span><span class="p">)</span>

                <span class="n">fuzzy_rupture_fronts</span><span class="p">(</span>
                    <span class="n">ax</span><span class="p">,</span> <span class="n">rupture_fronts</span><span class="p">,</span> <span class="n">xgr</span><span class="p">,</span> <span class="n">ygr</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">durations</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">mtrace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span>
                    <span class="s1">&#39;durations&#39;</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="n">std_durations</span> <span class="o">=</span> <span class="n">durations</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># alphas = std_durations.min() / std_durations</span>

            <span class="c1"># rupture durations</span>
            <span class="n">fig2</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a5&#39;</span><span class="p">,</span> <span class="s1">&#39;landscape&#39;</span><span class="p">))</span>

            <span class="n">reference_durations</span> <span class="o">=</span> <span class="n">reference</span><span class="p">[</span><span class="s1">&#39;durations&#39;</span><span class="p">][</span><span class="n">patch_idxs</span><span class="p">]</span>

            <span class="n">pa_col2</span> <span class="o">=</span> <span class="n">draw_patches</span><span class="p">(</span>
                <span class="n">ax2</span><span class="p">,</span> <span class="n">fault</span><span class="p">,</span> <span class="n">subfault_idx</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span> <span class="n">patch_values</span><span class="o">=</span><span class="n">reference_durations</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">seismic</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

            <span class="n">draw_colorbar</span><span class="p">(</span><span class="n">fig2</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">pa_col2</span><span class="p">,</span> <span class="n">labeltext</span><span class="o">=</span><span class="s1">&#39;durations [s]&#39;</span><span class="p">)</span>
            <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig2</span><span class="p">)</span>
            <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax2</span><span class="p">)</span>

            <span class="n">ref_starttimes</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">point2starttimes</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ns</span><span class="p">)</span>
            <span class="n">contours</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span>
                <span class="n">xgr</span><span class="p">,</span> <span class="n">ygr</span><span class="p">,</span> <span class="n">ref_starttimes</span><span class="p">,</span>
                <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">reference</span><span class="p">[</span><span class="s1">&#39;nucleation_strike&#39;</span><span class="p">][</span><span class="n">ns</span><span class="p">],</span>
                <span class="n">ext_source</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">km</span> <span class="o">-</span> <span class="n">reference</span><span class="p">[</span><span class="s1">&#39;nucleation_dip&#39;</span><span class="p">][</span><span class="n">ns</span><span class="p">],</span>
                <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">contours</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mtrace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing quantiles ...&#39;</span><span class="p">)</span>

            <span class="n">uparr</span> <span class="o">=</span> <span class="n">get_values_from_trace</span><span class="p">(</span>
                <span class="n">mtrace</span><span class="p">,</span> <span class="s1">&#39;uparr&#39;</span><span class="p">,</span> <span class="n">reference</span><span class="p">)[:,</span> <span class="n">patch_idxs</span><span class="p">]</span>
            <span class="n">uperp</span> <span class="o">=</span> <span class="n">get_values_from_trace</span><span class="p">(</span>
                <span class="n">mtrace</span><span class="p">,</span> <span class="s1">&#39;uperp&#39;</span><span class="p">,</span> <span class="n">reference</span><span class="p">)[:,</span> <span class="n">patch_idxs</span><span class="p">]</span>

            <span class="n">uparrmean</span> <span class="o">=</span> <span class="n">uparr</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">uperpmean</span> <span class="o">=</span> <span class="n">uperp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">quivers</span><span class="p">,</span> <span class="n">normalisation</span> <span class="o">=</span> <span class="n">draw_quivers</span><span class="p">(</span>
                <span class="n">ax</span><span class="p">,</span> <span class="n">uperpmean</span><span class="p">,</span> <span class="n">uparrmean</span><span class="p">,</span> <span class="n">xgr</span><span class="p">,</span> <span class="n">ygr</span><span class="p">,</span>
                <span class="n">ext_source</span><span class="o">.</span><span class="n">rake</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span>
                <span class="n">draw_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">uparrstd</span> <span class="o">=</span> <span class="n">uparr</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">normalisation</span>
            <span class="n">uperpstd</span> <span class="o">=</span> <span class="n">uperp</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">normalisation</span>

            <span class="n">slipvecrotmat</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">euler_to_matrix</span><span class="p">(</span>
                <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">ext_source</span><span class="o">.</span><span class="n">rake</span> <span class="o">*</span> <span class="n">mt</span><span class="o">.</span><span class="n">d2r</span><span class="p">)</span>

            <span class="n">circle</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="c1"># 2sigma error ellipses</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">upe</span><span class="p">,</span> <span class="n">upa</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">uperpstd</span><span class="p">,</span> <span class="n">uparrstd</span><span class="p">)):</span>
                <span class="n">ellipse_x</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">upa</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
                <span class="n">ellipse_y</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">upe</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">circle</span><span class="p">)</span>
                <span class="n">ellipse</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">ellipse_x</span><span class="p">,</span> <span class="n">ellipse_y</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ellipse_x</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
                <span class="n">rot_ellipse</span> <span class="o">=</span> <span class="n">ellipse</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">slipvecrotmat</span><span class="p">)</span>

                <span class="n">xcoords</span> <span class="o">=</span> <span class="n">xgr</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">rot_ellipse</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">quivers</span><span class="o">.</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">ycoords</span> <span class="o">=</span> <span class="n">ygr</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">rot_ellipse</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">quivers</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xcoords</span><span class="p">,</span> <span class="n">ycoords</span><span class="p">,</span> <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">normalisation</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">uperp</span> <span class="o">=</span> <span class="n">reference</span><span class="p">[</span><span class="s1">&#39;uperp&#39;</span><span class="p">][</span><span class="n">patch_idxs</span><span class="p">]</span>
        <span class="n">uparr</span> <span class="o">=</span> <span class="n">reference</span><span class="p">[</span><span class="s1">&#39;uparr&#39;</span><span class="p">][</span><span class="n">patch_idxs</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing slip vectors ...&#39;</span><span class="p">)</span>
        <span class="n">draw_quivers</span><span class="p">(</span>
            <span class="n">ax</span><span class="p">,</span> <span class="n">uperp</span><span class="p">,</span> <span class="n">uparr</span><span class="p">,</span>
            <span class="n">xgr</span><span class="p">,</span> <span class="n">ygr</span><span class="p">,</span> <span class="n">ext_source</span><span class="o">.</span><span class="n">rake</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">draw_legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">normalisation</span><span class="o">=</span><span class="n">normalisation</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">draw_colorbar</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">pa_col</span><span class="p">,</span> <span class="n">labeltext</span><span class="o">=</span><span class="s1">&#39;slip [m]&#39;</span><span class="p">)</span>
        <span class="n">format_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">])</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="n">axs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">figs</span><span class="p">,</span> <span class="n">axs</span>


<span class="k">class</span> <span class="nc">ModeError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">draw_slip_dist</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">po</span><span class="p">):</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">mode</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">ffi_mode_str</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ModeError</span><span class="p">(</span>
            <span class="s1">&#39;Wrong optimization mode: </span><span class="si">%s</span><span class="s1">! This plot &#39;</span>
            <span class="s1">&#39;variant is only valid for &quot;</span><span class="si">%s</span><span class="s1">&quot; mode&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">ffi_mode_str</span><span class="p">))</span>

    <span class="n">datatype</span><span class="p">,</span> <span class="n">gc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">composites</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">fault</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">load_fault_geometry</span><span class="p">()</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sampler_config</span>
    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sc</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Metropolis&#39;</span><span class="p">:</span>
        <span class="n">draws</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">n_steps</span> <span class="o">*</span> <span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">draws</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">transform</span> <span class="o">=</span> <span class="n">select_transform</span><span class="p">(</span><span class="n">sc</span><span class="o">=</span><span class="n">sc</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="n">draws</span><span class="p">)</span>

    <span class="n">stage</span> <span class="o">=</span> <span class="n">load_stage</span><span class="p">(</span>
        <span class="n">problem</span><span class="p">,</span> <span class="n">stage_number</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">load_stage</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">:</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">get_test_point</span><span class="p">()</span>
        <span class="n">res_point</span> <span class="o">=</span> <span class="n">get_result_point</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">)</span>
        <span class="n">reference</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">res_point</span><span class="p">)</span>
        <span class="n">llk_str</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span>
        <span class="n">mtrace</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span>
        <span class="n">llk_str</span> <span class="o">=</span> <span class="s1">&#39;ref&#39;</span>
        <span class="n">mtrace</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">figs</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">fault_slip_distribution</span><span class="p">(</span>
        <span class="n">fault</span><span class="p">,</span> <span class="n">mtrace</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
        <span class="n">reference</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span> <span class="n">nensemble</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">nensemble</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span>
            <span class="s1">&#39;slip_dist_</span><span class="si">%i</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">llk_str</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Storing slip-distribution to: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;pdf&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">PdfPages</span><span class="p">(</span><span class="n">outpath</span> <span class="o">+</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">opdf</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="p">:</span>
                    <span class="n">opdf</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fig</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">figs</span><span class="p">):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outpath</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_weighted_line</span><span class="p">(</span>
        <span class="n">r0</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">cmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmax</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw weighted lines into array</span>
<span class="sd">    Modiefied from:</span>
<span class="sd">    https://stackoverflow.com/questions/31638651/how-can-i-draw-lines-into-numpy-arrays</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r0 : int</span>
<span class="sd">        row index for line end point 0</span>
<span class="sd">    c0 : int</span>
<span class="sd">        col index for line end point 0</span>
<span class="sd">    r1 : int</span>
<span class="sd">        row index for line end point 1</span>
<span class="sd">    c1 : int</span>
<span class="sd">        col index for line end point 1</span>
<span class="sd">    w : int</span>
<span class="sd">        width in pixels for line</span>
<span class="sd">    rmin : int</span>
<span class="sd">        min row index for grid to draw on</span>
<span class="sd">    rmax : int</span>
<span class="sd">        max row index for grid to draw on</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rr : array of row indexes of line</span>
<span class="sd">    cc : array of col indexes of line</span>
<span class="sd">    w : array of line weights</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">trapez</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
            <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">y0</span><span class="p">,</span>
            <span class="o">-</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">w</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">y0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># The algorithm below works fine if c1 &gt;= c0 and c1-c0 &gt;= abs(r1-r0).</span>
    <span class="c1"># If either of these cases are violated, do some switches.</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">c1</span> <span class="o">-</span> <span class="n">c0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">r1</span> <span class="o">-</span> <span class="n">r0</span><span class="p">):</span>
        <span class="c1"># Switch x and y, and switch again when returning.</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">_weighted_line</span><span class="p">(</span>
            <span class="n">c0</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="n">cmin</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="n">cmax</span><span class="p">,</span> <span class="n">cmin</span><span class="o">=</span><span class="n">rmin</span><span class="p">,</span> <span class="n">cmax</span><span class="o">=</span><span class="n">rmax</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># At this point we know that the distance in columns (x) is greater</span>
    <span class="c1"># than that in rows (y). Possibly one more switch if c0 &gt; c1.</span>
    <span class="k">if</span> <span class="n">c0</span> <span class="o">&gt;</span> <span class="n">c1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_weighted_line</span><span class="p">(</span>
            <span class="n">r1</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="n">rmax</span><span class="p">,</span> <span class="n">cmin</span><span class="o">=</span><span class="n">cmin</span><span class="p">,</span> <span class="n">cmax</span><span class="o">=</span><span class="n">cmax</span><span class="p">)</span>

    <span class="c1"># The following is now always &lt; 1 in abs</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">r1</span> <span class="o">-</span> <span class="n">r0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">c1</span> <span class="o">-</span> <span class="n">c0</span><span class="p">)</span>

    <span class="c1"># Adjust weight by the slope</span>
    <span class="n">w</span> <span class="o">*=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">slope</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># We write y as a function of x, because the slope is always &lt;= 1</span>
    <span class="c1"># (in absolute value)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">c1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">slope</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">c1</span> <span class="o">*</span> <span class="n">r0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">c0</span> <span class="o">*</span> <span class="n">r1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">c1</span> <span class="o">-</span> <span class="n">c0</span><span class="p">)</span>

    <span class="c1"># Now instead of 2 values for y, we have 2*np.ceil(w/2).</span>
    <span class="c1"># All values are 1 except the upmost and bottommost.</span>
    <span class="n">thickness</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">yy</span> <span class="o">=</span> <span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
          <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">thickness</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">thickness</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">yy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">vals</span> <span class="o">=</span> <span class="n">trapez</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Exclude useless parts and those outside of the interval</span>
    <span class="c1"># to avoid parts outside of the picture</span>
    <span class="n">mask_y</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">yy</span> <span class="o">&gt;=</span> <span class="n">rmin</span><span class="p">,</span> <span class="n">yy</span> <span class="o">&lt;</span> <span class="n">rmax</span><span class="p">,</span> <span class="n">vals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">mask_x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">xx</span> <span class="o">&gt;=</span> <span class="n">cmin</span><span class="p">,</span> <span class="n">xx</span> <span class="o">&lt;</span> <span class="n">cmax</span><span class="p">,</span> <span class="n">vals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span><span class="n">mask_y</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mask_x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">yy</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">xx</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">vals</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">draw_line_on_array</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[],</span> <span class="n">grid_resolution</span><span class="o">=</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw line on given array by adding 1 to its fields.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : array_like</span>
<span class="sd">        timeseries on xcoordinate (columns of array)</span>
<span class="sd">    Y : array_like</span>
<span class="sd">        timeseries on ycoordinate (rows of array)</span>
<span class="sd">    grid : array_like 2d</span>
<span class="sd">        input array that is used for drawing</span>
<span class="sd">    extent : array extent</span>
<span class="sd">        [xmin, xmax, ymin, ymax] (cols, rows)</span>
<span class="sd">    grid_resolution : tuple</span>
<span class="sd">        shape of given grid or grid that is being used for allocation</span>
<span class="sd">    linewidth : int</span>
<span class="sd">        weight (width) of line drawn on grid</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    grid, extent</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">check_grid_shape</span><span class="p">(</span><span class="n">ngr</span><span class="p">,</span> <span class="n">naim</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ngr</span> <span class="o">!=</span> <span class="n">naim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;Gridsize of given grid is inconistent for axis </span><span class="si">%i</span><span class="s1">!&#39;</span>
                <span class="s1">&#39; Expected </span><span class="si">%i</span><span class="s1"> got </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">naim</span><span class="p">,</span> <span class="n">ngr</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">check_line_in_grid</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">extent</span><span class="p">):</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="n">idxs</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">imax</span> <span class="o">&gt;</span> <span class="n">nmax</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;Line endpoint outside of given grid Axis &quot;</span><span class="si">%s</span><span class="s1">&quot;! </span><span class="si">%i</span><span class="s1"> &gt; </span><span class="si">%i</span><span class="s1">&#39;</span>
                <span class="s1">&#39; Extent [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">axis</span><span class="p">,</span> <span class="n">imax</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">utility</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">extent</span><span class="p">)))</span>

    <span class="n">nxs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">nys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nxs</span> <span class="o">!=</span> <span class="n">nys</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;Length of X and Y have to be identical! </span><span class="si">%i</span><span class="s1"> != </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nxs</span><span class="p">,</span> <span class="n">nys</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">extent</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;extent has to be of length 4! [xmin, xmax, ymin, ymax]&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grid_resolution</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;grid_resolution has to be of length 2! [xstep, ystep]!&#39;</span><span class="p">)</span>

    <span class="n">ynstep</span><span class="p">,</span> <span class="n">xnstep</span> <span class="o">=</span> <span class="n">grid_resolution</span>

    <span class="n">xvec</span><span class="p">,</span> <span class="n">xstep</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">xnstep</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">yvec</span><span class="p">,</span> <span class="n">ystep</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ynstep</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Given grid has to be of dimension 2!&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">axis</span><span class="p">,</span> <span class="p">(</span><span class="n">ngr</span><span class="p">,</span> <span class="n">naim</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="nb">zip</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">grid_resolution</span><span class="p">)):</span>
            <span class="n">check_grid_shape</span><span class="p">(</span><span class="n">ngr</span><span class="p">,</span> <span class="n">naim</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ynstep</span><span class="p">,</span> <span class="n">xnstep</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

    <span class="n">xidxs</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">positions2idxs</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">min_pos</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span> <span class="n">cell_size</span><span class="o">=</span><span class="n">xstep</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
    <span class="n">yidxs</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">positions2idxs</span><span class="p">(</span>
        <span class="n">Y</span><span class="p">,</span> <span class="n">min_pos</span><span class="o">=</span><span class="n">ymin</span><span class="p">,</span> <span class="n">cell_size</span><span class="o">=</span><span class="n">ystep</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>

    <span class="n">check_line_in_grid</span><span class="p">(</span><span class="n">xidxs</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="n">xnstep</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
    <span class="n">check_line_in_grid</span><span class="p">(</span><span class="n">yidxs</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="n">ynstep</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
    <span class="n">new_grid</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nxs</span><span class="p">):</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">xidxs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="n">yidxs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">xidxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">yidxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rr</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">_weighted_line</span><span class="p">(</span>
                <span class="n">r0</span><span class="o">=</span><span class="n">r0</span><span class="p">,</span> <span class="n">c0</span><span class="o">=</span><span class="n">c0</span><span class="p">,</span> <span class="n">r1</span><span class="o">=</span><span class="n">r1</span><span class="p">,</span> <span class="n">c1</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">linewidth</span><span class="p">,</span>
                <span class="n">rmax</span><span class="o">=</span><span class="n">ynstep</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cmax</span><span class="o">=</span><span class="n">xnstep</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">new_grid</span><span class="p">[</span><span class="n">rr</span><span class="p">,</span> <span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># line start and end fall in the same grid point cant be drawn</span>
            <span class="k">pass</span>

    <span class="n">grid</span> <span class="o">+=</span> <span class="n">new_grid</span>
    <span class="k">return</span> <span class="n">grid</span><span class="p">,</span> <span class="n">extent</span>


<span class="k">def</span> <span class="nf">fuzzy_moment_rate</span><span class="p">(</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">moment_rates</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">500</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot fuzzy moment rate function into axes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># from matplotlib.colors import LinearSegmentedColormap</span>
        <span class="c1"># ncolors = 256</span>
        <span class="c1"># cmap = LinearSegmentedColormap.from_list(</span>
        <span class="c1">#    &#39;dummy&#39;, [background_color, rates_color], N=ncolors)</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">hot_r</span>

    <span class="n">nrates</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">moment_rates</span><span class="p">)</span>
    <span class="n">ntimes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nrates</span> <span class="o">!=</span> <span class="n">ntimes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;Number of rates and times have to be identical!&#39;</span>
            <span class="s1">&#39; </span><span class="si">%i</span><span class="s1"> != </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nrates</span><span class="p">,</span> <span class="n">ntimes</span><span class="p">))</span>

    <span class="n">max_rates</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">moment_rates</span><span class="p">))</span>
    <span class="n">max_times</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">,</span> <span class="n">times</span><span class="p">))</span>
    <span class="n">min_rates</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">moment_rates</span><span class="p">))</span>
    <span class="n">min_times</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">times</span><span class="p">))</span>

    <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_times</span><span class="p">,</span> <span class="n">max_times</span><span class="p">,</span> <span class="n">min_rates</span><span class="p">,</span> <span class="n">max_rates</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">grid_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">mr</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">moment_rates</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
        <span class="n">draw_line_on_array</span><span class="p">(</span>
            <span class="n">time</span><span class="p">,</span> <span class="n">mr</span><span class="p">,</span>
            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
            <span class="n">grid_resolution</span><span class="o">=</span><span class="n">grid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

    <span class="c1"># increase contrast reduce high intense values</span>
    <span class="n">truncate</span> <span class="o">=</span> <span class="n">nrates</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">grid</span><span class="p">[</span><span class="n">grid</span> <span class="o">&gt;</span> <span class="n">truncate</span><span class="p">]</span> <span class="o">=</span> <span class="n">truncate</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [s]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Moment rate [$Nm / s$]&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">draw_moment_rate</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">po</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Draw moment rate function for the results of a seismic/joint finite fault</span>
<span class="sd">    optimization.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">mode</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">ffi_mode_str</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ModeError</span><span class="p">(</span>
            <span class="s1">&#39;Wrong optimization mode: </span><span class="si">%s</span><span class="s1">! This plot &#39;</span>
            <span class="s1">&#39;variant is only valid for &quot;</span><span class="si">%s</span><span class="s1">&quot; mode&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">ffi_mode_str</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;seismic&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">datatypes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;Moment rate function only available for optimization results that&#39;</span>
            <span class="s1">&#39; include seismic data.&#39;</span><span class="p">)</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">composites</span><span class="p">[</span><span class="s1">&#39;seismic&#39;</span><span class="p">]</span>
    <span class="n">fault</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">load_fault_geometry</span><span class="p">()</span>

    <span class="n">stage</span> <span class="o">=</span> <span class="n">load_stage</span><span class="p">(</span>
        <span class="n">problem</span><span class="p">,</span> <span class="n">stage_number</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">load_stage</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span><span class="p">:</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="n">get_result_point</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">)</span>
        <span class="n">llk_str</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span>
        <span class="n">mtrace</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">reference</span>
        <span class="n">llk_str</span> <span class="o">=</span> <span class="s1">&#39;ref&#39;</span>
        <span class="n">mtrace</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s1">&#39;Drawing ensemble of </span><span class="si">%i</span><span class="s1"> moment rate functions ...&#39;</span> <span class="o">%</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">wavemaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">plot_projection</span> <span class="o">==</span> <span class="s1">&#39;individual&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing subfault individual rates ...&#39;</span><span class="p">)</span>
        <span class="n">sf_idxs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">fault</span><span class="o">.</span><span class="n">nsubfaults</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing total rates ...&#39;</span><span class="p">)</span>
        <span class="n">sf_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">fault</span><span class="o">.</span><span class="n">nsubfaults</span><span class="p">))]</span>

    <span class="n">mpl_init</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ns</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sf_idxs</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Fault </span><span class="si">%i</span><span class="s1"> / </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sf_idxs</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">ns_str</span> <span class="o">=</span> <span class="s1">&#39;total&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ns_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>

        <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span>
            <span class="s1">&#39;moment_rate_</span><span class="si">%i</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%i</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">stage</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">ns_str</span><span class="p">,</span>
                <span class="n">llk_str</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">))</span>

        <span class="n">ref_mrf_rates</span><span class="p">,</span> <span class="n">ref_mrf_times</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">get_moment_rate_function</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
            <span class="n">store</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">get_store</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">store_id</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a7&#39;</span><span class="p">,</span> <span class="s1">&#39;landscape&#39;</span><span class="p">))</span>
            <span class="n">labelpos</span> <span class="o">=</span> <span class="n">mpl_margins</span><span class="p">(</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">labelpos</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mtrace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nchains</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mtrace</span><span class="p">)</span>
                <span class="n">csteps</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nchains</span><span class="p">)</span> <span class="o">/</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span>
                <span class="n">idxs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
                    <span class="n">num</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchains</span><span class="p">,</span> <span class="n">csteps</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int32&#39;</span><span class="p">)</span>
                <span class="n">mrfs_rate</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">mrfs_time</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                    <span class="n">point</span> <span class="o">=</span> <span class="n">mtrace</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">mrf_rate</span><span class="p">,</span> <span class="n">mrf_time</span> <span class="o">=</span> \
                        <span class="n">fault</span><span class="o">.</span><span class="n">get_moment_rate_function</span><span class="p">(</span>
                            <span class="n">index</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="n">point</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
                            <span class="n">store</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">get_store</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">store_id</span><span class="p">))</span>
                    <span class="n">mrfs_rate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mrf_rate</span><span class="p">)</span>
                    <span class="n">mrfs_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mrf_time</span><span class="p">)</span>

                <span class="n">fuzzy_moment_rate</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">mrfs_rate</span><span class="p">,</span> <span class="n">mrfs_time</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">ref_mrf_times</span><span class="p">,</span> <span class="n">ref_mrf_rates</span><span class="p">,</span>
                <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
            <span class="n">format_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving figure to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plot exists! Use --force to overwrite!&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">source_geometry</span><span class="p">(</span><span class="n">fault</span><span class="p">,</span> <span class="n">ref_sources</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">datasets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot source geometry in 3d rotatable view</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fault: :class:`beat.ffi.fault.FaultGeometry`</span>
<span class="sd">    ref_sources: list</span>
<span class="sd">        of :class:&#39;beat.sources.RectangularSource&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="k">import</span> <span class="n">Axes3D</span>
    <span class="kn">from</span> <span class="nn">beat.utility</span> <span class="k">import</span> <span class="n">RS_center</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d.art3d</span> <span class="k">import</span> <span class="n">Poly3DCollection</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.7</span>

    <span class="k">def</span> <span class="nf">plot_subfault</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">refloc</span><span class="p">):</span>
        <span class="n">source</span><span class="o">.</span><span class="n">anchor</span> <span class="o">=</span> <span class="s1">&#39;top&#39;</span>
        <span class="n">shift_ne</span> <span class="o">=</span> <span class="n">otd</span><span class="o">.</span><span class="n">latlon_to_ne</span><span class="p">(</span>
            <span class="n">refloc</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">refloc</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">outline</span><span class="p">()</span>
        <span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_ne</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span>
            <span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">RS_center</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_ne</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_axes_radius</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="s1">&#39;x&#39;</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim3d</span><span class="p">([</span><span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;y&#39;</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim3d</span><span class="p">([</span><span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_zlim3d</span><span class="p">([</span><span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">radius</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;xyz&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Make axes of 3D plot have equal scale so that spheres appear as</span>
<span class="sd">        spheres, cubes as cubes, etc.. </span>
<span class="sd">        This is one possible solution to Matplotlib&#39;s</span>
<span class="sd">        ax.set_aspect(&#39;equal&#39;) and ax.axis(&#39;equal&#39;) not working for 3D.</span>

<span class="sd">        Input</span>
<span class="sd">          ax: a matplotlib axis, e.g., as output from plt.gca().</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">limits</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim3d</span><span class="p">(),</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim3d</span><span class="p">(),</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_zlim3d</span><span class="p">(),</span>
        <span class="p">])</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">limits</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">limits</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">limits</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">set_axes_radius</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>


    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a4&#39;</span><span class="p">,</span> <span class="s1">&#39;landscape&#39;</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
    <span class="n">extfs</span> <span class="o">=</span> <span class="n">fault</span><span class="o">.</span><span class="n">get_all_subfaults</span><span class="p">()</span>

    <span class="n">arr_coords</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">refs</span><span class="p">,</span> <span class="n">exts</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ref_sources</span><span class="p">,</span> <span class="n">extfs</span><span class="p">)):</span>

        <span class="n">plot_subfault</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">exts</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">mpl_graph_color</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">refloc</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
        <span class="n">plot_subfault</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">refs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;aluminium4&#39;</span><span class="p">),</span> <span class="n">refloc</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">patch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fault</span><span class="o">.</span><span class="n">get_subfault_patches</span><span class="p">(</span><span class="n">idx</span><span class="p">)):</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">patch</span><span class="o">.</span><span class="n">outline</span><span class="p">()</span>
            <span class="n">shift_ne</span> <span class="o">=</span> <span class="n">otd</span><span class="o">.</span><span class="n">latlon_to_ne</span><span class="p">(</span>
                <span class="n">event</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">patch</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">patch</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shift_ne</span>
            <span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.</span>
            <span class="n">coords</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>  <span class="c1"># swap columns to [E, N, Z] (X, Y, Z)</span>
            <span class="n">arr_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">mpl_graph_color</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="n">patch</span><span class="o">.</span><span class="n">east_shift</span> <span class="o">+</span> <span class="n">shift_ne</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">patch</span><span class="o">.</span><span class="n">north_shift</span> <span class="o">+</span> <span class="n">shift_ne</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">patch</span><span class="o">.</span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">fault</span><span class="o">.</span><span class="n">cum_subfault_npatches</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;jet&#39;</span><span class="p">)</span>

        <span class="n">poly_patches</span> <span class="o">=</span> <span class="n">Poly3DCollection</span><span class="p">(</span>
            <span class="n">verts</span><span class="o">=</span><span class="n">arr_coords</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">poly_patches</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">poly_patches</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">poly_patches</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">poly_patches</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">poly_patches</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">poly_patches</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">datasets</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
            <span class="c1"># print(dataset.east_shifts, dataset.north_shifts)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">east_shifts</span><span class="p">,</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">north_shifts</span><span class="p">,</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">coords5</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span>
                <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">km</span><span class="p">}</span>
    <span class="n">scale_axes</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="p">,</span> <span class="o">**</span><span class="n">scale</span><span class="p">)</span>
    <span class="n">scale_axes</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="p">,</span> <span class="o">**</span><span class="n">scale</span><span class="p">)</span>
    <span class="n">scale_axes</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">zaxis</span><span class="p">,</span> <span class="o">**</span><span class="n">scale</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Depth [km]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;North_shift [km]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;East_shift [km]&#39;</span><span class="p">)</span>
    <span class="n">set_axes_equal</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="s1">&#39;xy&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_gmt_config</span><span class="p">(</span><span class="n">gmtpy</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">20.</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">is_gmt5</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="s1">&#39;newest&#39;</span><span class="p">):</span>
        <span class="n">gmtconfig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;MAP_GRID_PEN_PRIMARY&#39;</span><span class="p">:</span> <span class="s1">&#39;0.1p&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MAP_GRID_PEN_SECONDARY&#39;</span><span class="p">:</span> <span class="s1">&#39;0.1p&#39;</span><span class="p">,</span>
            <span class="s1">&#39;MAP_FRAME_TYPE&#39;</span><span class="p">:</span> <span class="s1">&#39;fancy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FONT_ANNOT_PRIMARY&#39;</span><span class="p">:</span> <span class="s1">&#39;14p,Helvetica,black&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FONT_ANNOT_SECONDARY&#39;</span><span class="p">:</span> <span class="s1">&#39;14p,Helvetica,black&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FONT_LABEL&#39;</span><span class="p">:</span> <span class="s1">&#39;14p,Helvetica,black&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FORMAT_GEO_MAP&#39;</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span>
            <span class="s1">&#39;GMT_TRIANGULATE&#39;</span><span class="p">:</span> <span class="s1">&#39;Watson&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PS_MEDIA&#39;</span><span class="p">:</span> <span class="s1">&#39;Custom_</span><span class="si">%i</span><span class="s1">x</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">cm</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">cm</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gmtconfig</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;MAP_FRAME_TYPE&#39;</span><span class="p">:</span> <span class="s1">&#39;fancy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;GRID_PEN_PRIMARY&#39;</span><span class="p">:</span> <span class="s1">&#39;0.01p&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ANNOT_FONT_PRIMARY&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ANNOT_FONT_SIZE_PRIMARY&#39;</span><span class="p">:</span> <span class="s1">&#39;12p&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PLOT_DEGREE_FORMAT&#39;</span><span class="p">:</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span>
            <span class="s1">&#39;GRID_PEN_SECONDARY&#39;</span><span class="p">:</span> <span class="s1">&#39;0.01p&#39;</span><span class="p">,</span>
            <span class="s1">&#39;FONT_LABEL&#39;</span><span class="p">:</span> <span class="s1">&#39;14p,Helvetica,black&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PS_MEDIA&#39;</span><span class="p">:</span> <span class="s1">&#39;Custom_</span><span class="si">%i</span><span class="s1">x</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">cm</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">cm</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">gmtconfig</span>


<span class="k">def</span> <span class="nf">draw_station_map_gmt</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">po</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">gmtpy</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gmtpy</span><span class="o">.</span><span class="n">detect_gmt_installations</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">GmtPyError</span><span class="p">(</span>
            <span class="s1">&#39;GMT needs to be installed for station_map plot!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;svg&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;SVG format is not supported for this plot!&#39;</span><span class="p">)</span>

    <span class="n">ts</span> <span class="o">=</span> <span class="s1">&#39;time_shift&#39;</span>
    <span class="k">if</span> <span class="n">ts</span> <span class="ow">in</span> <span class="n">po</span><span class="o">.</span><span class="n">varnames</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plotting time-shifts on station locations&#39;</span><span class="p">)</span>
        <span class="n">stage</span> <span class="o">=</span> <span class="n">load_stage</span><span class="p">(</span>
            <span class="n">problem</span><span class="p">,</span> <span class="n">stage_number</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">load_stage</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">point</span> <span class="o">=</span> <span class="n">get_result_point</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">)</span>
        <span class="n">value_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">point</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">value_string</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>

    <span class="n">font_size</span> <span class="o">=</span> <span class="mi">12</span>
    <span class="n">font</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
    <span class="n">bin_width</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># major grid and tick increment in [deg]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># outsize in cm</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">h</span> <span class="o">-</span> <span class="mi">5</span>

    <span class="n">gmtconfig</span> <span class="o">=</span> <span class="n">get_gmt_config</span><span class="p">(</span><span class="n">gmtpy</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_time_shifts_stations</span><span class="p">(</span><span class="n">gmt</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">wmap</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Draw MAP time-shifts at station locations as colored triangles</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time_shifts</span> <span class="o">=</span> <span class="n">extract_time_shifts</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">wmap</span><span class="p">)</span>

        <span class="n">cptfilepath</span> <span class="o">=</span> <span class="s1">&#39;/tmp/tempfile.cpt&#39;</span>
        <span class="n">miny</span> <span class="o">=</span> <span class="n">time_shifts</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">maxy</span> <span class="o">=</span> <span class="n">time_shifts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">bound</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">miny</span><span class="p">),</span> <span class="n">maxy</span><span class="p">))</span>

        <span class="n">gmt</span><span class="o">.</span><span class="n">makecpt</span><span class="p">(</span>
            <span class="n">C</span><span class="o">=</span><span class="s1">&#39;blue,white,red&#39;</span><span class="p">,</span>
            <span class="n">Z</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">T</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">/</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">bound</span><span class="p">,</span> <span class="n">bound</span><span class="p">),</span>
            <span class="n">out_filename</span><span class="o">=</span><span class="n">cptfilepath</span><span class="p">,</span> <span class="n">suppress_defaults</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">station</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wmap</span><span class="o">.</span><span class="n">stations</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="n">time_shifts</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="n">gmt</span><span class="o">.</span><span class="n">psxy</span><span class="p">(</span>
            <span class="n">in_columns</span><span class="o">=</span><span class="p">(</span><span class="n">st_lons</span><span class="p">,</span> <span class="n">st_lats</span><span class="p">,</span> <span class="n">time_shifts</span><span class="o">.</span><span class="n">tolist</span><span class="p">()),</span>
            <span class="n">C</span><span class="o">=</span><span class="n">cptfilepath</span><span class="p">,</span>
            <span class="n">S</span><span class="o">=</span><span class="s1">&#39;t14p&#39;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="mf">30.</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="s1">&#39;x1.5c/0c+w6c/0.5c+jMC+h&#39;</span>
            <span class="n">F</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="s1">&#39;x5.5c/4.1c+w6c/0.5c+jMC+h&#39;</span>
            <span class="n">F</span> <span class="o">=</span> <span class="s1">&#39;+gwhite&#39;</span>

        <span class="c1"># add a colorbar</span>
        <span class="n">gmt</span><span class="o">.</span><span class="n">psscale</span><span class="p">(</span>
            <span class="n">B</span><span class="o">=</span><span class="s1">&#39;xa</span><span class="si">%s</span><span class="s1"> +l time shifts [s]&#39;</span> <span class="o">%</span> <span class="n">num</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">bound</span><span class="p">),</span>
            <span class="n">D</span><span class="o">=</span><span class="n">D</span><span class="p">,</span>
            <span class="n">F</span><span class="o">=</span><span class="n">F</span><span class="p">,</span>
            <span class="n">C</span><span class="o">=</span><span class="n">cptfilepath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_events</span><span class="p">(</span><span class="n">gmt</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>

        <span class="n">ev_lons</span> <span class="o">=</span> <span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">lon</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
        <span class="n">ev_lats</span> <span class="o">=</span> <span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">lat</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>

        <span class="n">gmt</span><span class="o">.</span><span class="n">psxy</span><span class="p">(</span>
            <span class="n">in_columns</span><span class="o">=</span><span class="p">(</span><span class="n">ev_lons</span><span class="p">,</span> <span class="n">ev_lats</span><span class="p">),</span>
            <span class="n">G</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
            <span class="n">S</span><span class="o">=</span><span class="s1">&#39;a14p&#39;</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing Station Map ...&#39;</span><span class="p">)</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">composites</span><span class="p">[</span><span class="s1">&#39;seismic&#39;</span><span class="p">]</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">event</span>

    <span class="k">for</span> <span class="n">wmap</span> <span class="ow">in</span> <span class="n">sc</span><span class="o">.</span><span class="n">wavemaps</span><span class="p">:</span>
        <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span> <span class="s1">&#39;station_map_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%i</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">wmap</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">wmap</span><span class="o">.</span><span class="n">mapnumber</span><span class="p">,</span> <span class="n">value_string</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">))</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">wmap</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">distances</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>

            <span class="n">st_lons</span> <span class="o">=</span> <span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">lon</span> <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">wmap</span><span class="o">.</span><span class="n">stations</span><span class="p">]</span>
            <span class="n">st_lats</span> <span class="o">=</span> <span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">lat</span> <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">wmap</span><span class="o">.</span><span class="n">stations</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">dist</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">*</span> <span class="mf">1.05</span>  <span class="c1"># add interval to have bound</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Using equidistant azimuthal projection for&#39;</span>
                    <span class="s1">&#39; teleseismic setup of wavemap </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">wmap</span><span class="o">.</span><span class="n">_mapid</span><span class="p">)</span>
                <span class="n">J_basemap</span> <span class="o">=</span> <span class="s1">&#39;E0/-90/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                <span class="n">J_location</span> <span class="o">=</span> <span class="s1">&#39;E</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
                <span class="n">R_location</span> <span class="o">=</span> <span class="s1">&#39;0/360/-90/0&#39;</span>

                <span class="n">gmt</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">GMT</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">gmtconfig</span><span class="p">)</span>
                <span class="n">gmt</span><span class="o">.</span><span class="n">psbasemap</span><span class="p">(</span>
                    <span class="n">R</span><span class="o">=</span><span class="n">R_location</span><span class="p">,</span>
                    <span class="n">J</span><span class="o">=</span><span class="s1">&#39;S0/-90/90/</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">w</span><span class="p">,</span>
                    <span class="n">B</span><span class="o">=</span><span class="s1">&#39;xa</span><span class="si">%s</span><span class="s1">f</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bin_width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bin_width</span><span class="p">))</span>
                <span class="n">gmt</span><span class="o">.</span><span class="n">pscoast</span><span class="p">(</span>
                    <span class="n">R</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span>
                    <span class="n">J</span><span class="o">=</span><span class="s1">&#39;E</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span>
                    <span class="n">D</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span>
                    <span class="n">G</span><span class="o">=</span><span class="s1">&#39;darkgrey&#39;</span><span class="p">)</span>
                <span class="n">gmt</span><span class="o">.</span><span class="n">psbasemap</span><span class="p">(</span>
                    <span class="n">R</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span>
                    <span class="n">J</span><span class="o">=</span><span class="n">J_basemap</span><span class="p">,</span>
                    <span class="n">B</span><span class="o">=</span><span class="s1">&#39;xg</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">bin_width</span><span class="p">)</span>
                <span class="n">gmt</span><span class="o">.</span><span class="n">psbasemap</span><span class="p">(</span>
                    <span class="n">R</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span>
                    <span class="n">J</span><span class="o">=</span><span class="n">J_basemap</span><span class="p">,</span>
                    <span class="n">B</span><span class="o">=</span><span class="s1">&#39;yg</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">bin_width</span><span class="p">))</span>

                <span class="n">draw_events</span><span class="p">(</span>
                    <span class="n">gmt</span><span class="p">,</span> <span class="p">[</span><span class="n">event</span><span class="p">],</span> <span class="o">*</span><span class="p">(</span><span class="s1">&#39;-J</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">J_location</span><span class="p">,</span> <span class="s1">&#39;-R</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">R_location</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">point</span><span class="p">:</span>
                    <span class="n">draw_time_shifts_stations</span><span class="p">(</span>
                        <span class="n">gmt</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">wmap</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span>
                            <span class="s1">&#39;-J</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">J_location</span><span class="p">,</span> <span class="s1">&#39;-R</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">R_location</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gmt</span><span class="o">.</span><span class="n">psxy</span><span class="p">(</span>
                        <span class="n">R</span><span class="o">=</span><span class="n">R_location</span><span class="p">,</span>
                        <span class="n">J</span><span class="o">=</span><span class="n">J_location</span><span class="p">,</span>
                        <span class="n">in_columns</span><span class="o">=</span><span class="p">(</span><span class="n">st_lons</span><span class="p">,</span> <span class="n">st_lats</span><span class="p">),</span>
                        <span class="n">G</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                        <span class="n">S</span><span class="o">=</span><span class="s1">&#39;t14p&#39;</span><span class="p">)</span>

                <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">alignment</span> <span class="o">=</span> <span class="s1">&#39;TC&#39;</span>
                <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">wmap</span><span class="o">.</span><span class="n">stations</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">gmt</span><span class="o">.</span><span class="n">is_gmt5</span><span class="p">():</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
                            <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">font_size</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">),</span>
                            <span class="n">alignment</span><span class="p">,</span>
                            <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">station</span><span class="p">))</span>
                        <span class="n">farg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-F+f+j&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">st</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
                            <span class="n">font_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span>
                            <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">station</span><span class="p">))</span>
                        <span class="n">farg</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

                <span class="n">gmt</span><span class="o">.</span><span class="n">pstext</span><span class="p">(</span>
                    <span class="n">in_rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span>
                    <span class="n">R</span><span class="o">=</span><span class="n">R_location</span><span class="p">,</span>
                    <span class="n">J</span><span class="o">=</span><span class="n">J_location</span><span class="p">,</span>
                    <span class="n">N</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">*</span><span class="n">farg</span><span class="p">)</span>

                <span class="n">gmt</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Using equidistant projection for regional setup &#39;</span>
                    <span class="s1">&#39;of wavemap </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">wmap</span><span class="o">.</span><span class="n">_mapid</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">pyrocko.automap</span> <span class="k">import</span> <span class="n">Map</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">Map</span><span class="p">(</span>
                    <span class="n">lat</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
                    <span class="n">lon</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
                    <span class="n">radius</span><span class="o">=</span><span class="n">dist</span> <span class="o">*</span> <span class="n">otd</span><span class="o">.</span><span class="n">d2m</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="n">h</span><span class="p">,</span>
                    <span class="n">height</span><span class="o">=</span><span class="n">h</span><span class="p">,</span>
                    <span class="n">show_grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">show_topo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">show_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">color_dry</span><span class="o">=</span><span class="p">(</span><span class="mi">143</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">143</span><span class="p">),</span>  <span class="c1"># grey</span>
                    <span class="n">illuminate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">illuminate_factor_ocean</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
                    <span class="c1"># illuminate_factor_land = 0.2,</span>
                    <span class="n">show_rivers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">show_plates</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">gmt_config</span><span class="o">=</span><span class="n">gmtconfig</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">point</span><span class="p">:</span>
                    <span class="n">draw_time_shifts_stations</span><span class="p">(</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">gmt</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">wmap</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">jxyr</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">wmap</span><span class="o">.</span><span class="n">stations</span><span class="p">:</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">station</span><span class="p">)</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">add_stations</span><span class="p">(</span>
                        <span class="n">wmap</span><span class="o">.</span><span class="n">stations</span><span class="p">,</span> <span class="n">psxy_style</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">S</span><span class="o">=</span><span class="s1">&#39;t14p&#39;</span><span class="p">,</span> <span class="n">G</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">))</span>

                <span class="n">draw_events</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">gmt</span><span class="p">,</span> <span class="p">[</span><span class="n">event</span><span class="p">],</span> <span class="o">*</span><span class="n">m</span><span class="o">.</span><span class="n">jxyr</span><span class="p">)</span>
                <span class="n">m</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">,</span> <span class="n">oversample</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving figure to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plot exists! Use --force to overwrite!&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">draw_lune_plot</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">po</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;svg&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;SVG format is not supported for this plot!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">n_sources</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Lune plot is not yet implemented for more than one source!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">stage</span> <span class="o">=</span> <span class="n">load_stage</span><span class="p">(</span>
        <span class="n">problem</span><span class="p">,</span> <span class="n">stage_number</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">load_stage</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">n_mts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span><span class="p">)</span>

    <span class="n">result_ensemble</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result_ensemble</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span> <span class="o">=</span> <span class="n">stage</span><span class="o">.</span><span class="n">mtrace</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span>
                <span class="n">varname</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="c1"># if fixed value add that to the ensemble</span>
            <span class="n">rpoint</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">get_random_point</span><span class="p">()</span>
            <span class="n">result_ensemble</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span>
                <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_mts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">rpoint</span><span class="p">[</span><span class="n">varname</span><span class="p">])</span>

    <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span>
        <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span>
        <span class="s1">&#39;lune_</span><span class="si">%i</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%i</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">po</span><span class="o">.</span><span class="n">load_stage</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">post_llk</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plotting selected ensemble as nensemble &gt; 1 ...&#39;</span><span class="p">)</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">n_mts</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">nensemble</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">v_tape</span> <span class="o">=</span> <span class="n">result_ensemble</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">][</span><span class="n">selected</span><span class="p">]</span>
        <span class="n">w_tape</span> <span class="o">=</span> <span class="n">result_ensemble</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">][</span><span class="n">selected</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plotting whole posterior ...&#39;</span><span class="p">)</span>
        <span class="n">v_tape</span> <span class="o">=</span> <span class="n">result_ensemble</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span>
        <span class="n">w_tape</span> <span class="o">=</span> <span class="n">result_ensemble</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">force</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing Lune plot ...&#39;</span><span class="p">)</span>
        <span class="n">gmt</span> <span class="o">=</span> <span class="n">lune_plot</span><span class="p">(</span><span class="n">v_tape</span><span class="o">=</span><span class="n">v_tape</span><span class="p">,</span> <span class="n">w_tape</span><span class="o">=</span><span class="n">w_tape</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving figure to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
        <span class="n">gmt</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plot exists! Use --force to overwrite!&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">lune_plot</span><span class="p">(</span><span class="n">v_tape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w_tape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">gmtpy</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gmtpy</span><span class="o">.</span><span class="n">detect_gmt_installations</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">GmtPyError</span><span class="p">(</span>
            <span class="s1">&#39;GMT needs to be installed for lune_plot!&#39;</span><span class="p">)</span>

    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span>
    <span class="n">font</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>

    <span class="k">def</span> <span class="nf">draw_lune_arcs</span><span class="p">(</span><span class="n">gmt</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">J</span><span class="p">):</span>

        <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="mf">30.</span><span class="p">,</span> <span class="o">-</span><span class="mf">30.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">,</span> <span class="o">-</span><span class="mf">30.</span><span class="p">]</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="mf">54.7356</span><span class="p">,</span> <span class="mf">35.2644</span><span class="p">,</span> <span class="o">-</span><span class="mf">35.2644</span><span class="p">,</span> <span class="o">-</span><span class="mf">54.7356</span><span class="p">]</span>

        <span class="n">gmt</span><span class="o">.</span><span class="n">psxy</span><span class="p">(</span>
            <span class="n">in_columns</span><span class="o">=</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">),</span> <span class="n">N</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="s1">&#39;1p,black&#39;</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">,</span> <span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_lune_points</span><span class="p">(</span><span class="n">gmt</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">lons</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">30.</span><span class="p">,</span> <span class="o">-</span><span class="mf">30.</span><span class="p">,</span> <span class="o">-</span><span class="mf">30.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">90.</span><span class="p">,</span> <span class="o">-</span><span class="mf">54.7356</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">35.2644</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> <span class="mf">54.7356</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">35.2644</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="n">annotations</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;-ISO&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;+CLVD&#39;</span><span class="p">,</span> <span class="s1">&#39;+LVD&#39;</span><span class="p">,</span> <span class="s1">&#39;+ISO&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;-CLVD&#39;</span><span class="p">,</span> <span class="s1">&#39;-LVD&#39;</span><span class="p">,</span> <span class="s1">&#39;DC&#39;</span><span class="p">]</span>
        <span class="n">alignments</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TC&#39;</span><span class="p">,</span> <span class="s1">&#39;TC&#39;</span><span class="p">,</span> <span class="s1">&#39;RM&#39;</span><span class="p">,</span> <span class="s1">&#39;RM&#39;</span><span class="p">,</span> <span class="s1">&#39;BC&#39;</span><span class="p">,</span> <span class="s1">&#39;BC&#39;</span><span class="p">,</span> <span class="s1">&#39;LM&#39;</span><span class="p">,</span> <span class="s1">&#39;LM&#39;</span><span class="p">,</span> <span class="s1">&#39;TC&#39;</span><span class="p">]</span>

        <span class="n">gmt</span><span class="o">.</span><span class="n">psxy</span><span class="p">(</span><span class="n">in_columns</span><span class="o">=</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">),</span> <span class="n">N</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="s1">&#39;p6p&#39;</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="s1">&#39;1p,0&#39;</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">,</span> <span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">)</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">labels</span><span class="p">:</span>
            <span class="n">farg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-F+f+j&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">align</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">annotations</span><span class="p">,</span> <span class="n">alignments</span><span class="p">):</span>

                <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                    <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span>
                    <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">font</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">),</span>
                    <span class="n">align</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>

            <span class="n">gmt</span><span class="o">.</span><span class="n">pstext</span><span class="p">(</span>
                <span class="n">in_rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span>
                <span class="n">N</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">,</span> <span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="s1">&#39;j5p&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">farg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">draw_lune_kde</span><span class="p">(</span>
            <span class="n">gmt</span><span class="p">,</span> <span class="n">v_tape</span><span class="p">,</span> <span class="n">w_tape</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span> <span class="n">R</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">J</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">check_fixed</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Spread of variable &quot;</span><span class="si">%s</span><span class="s1">&quot; is </span><span class="si">%f</span><span class="s1">, which is below necessary&#39;</span>
                    <span class="s1">&#39; width to estimate a spherical kde, adding some jitter to&#39;</span>
                    <span class="s1">&#39; make kde estimate possible&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">varname</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">std</span><span class="p">()))</span>
                <span class="n">a</span> <span class="o">+=</span> <span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">beat.sources</span> <span class="k">import</span> <span class="n">v_to_gamma</span><span class="p">,</span> <span class="n">w_to_delta</span>

        <span class="n">gamma</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">v_to_gamma</span><span class="p">(</span><span class="n">v_tape</span><span class="p">))</span>   <span class="c1"># lune longitude [rad]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">w_to_delta</span><span class="p">(</span><span class="n">w_tape</span><span class="p">))</span>   <span class="c1"># lune latitude [rad]</span>

        <span class="n">check_fixed</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">)</span>
        <span class="n">check_fixed</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="n">lats_vec</span><span class="p">,</span> <span class="n">lats_inc</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="o">-</span><span class="mf">90.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">lons_vec</span><span class="p">,</span> <span class="n">lons_inc</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="o">-</span><span class="mf">30.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">,</span> <span class="n">grid_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">lons_vec</span><span class="p">,</span> <span class="n">lats_vec</span><span class="p">)</span>

        <span class="n">kde_vals</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">spherical_kde_op</span><span class="p">(</span>
            <span class="n">lats0</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span> <span class="n">lons0</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
            <span class="n">lons</span><span class="o">=</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="o">=</span><span class="n">lats</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="n">grid_size</span><span class="p">)</span>
        <span class="n">Tmin</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">kde_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()])</span>
        <span class="n">Tmax</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">kde_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>

        <span class="n">cptfilepath</span> <span class="o">=</span> <span class="s1">&#39;/tmp/tempfile.cpt&#39;</span>
        <span class="n">gmt</span><span class="o">.</span><span class="n">makecpt</span><span class="p">(</span>
            <span class="n">C</span><span class="o">=</span><span class="s1">&#39;white,yellow,orange,red,magenta,violet&#39;</span><span class="p">,</span>
            <span class="n">Z</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">T</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">/</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Tmin</span><span class="p">,</span> <span class="n">Tmax</span><span class="p">),</span>
            <span class="n">out_filename</span><span class="o">=</span><span class="n">cptfilepath</span><span class="p">,</span> <span class="n">suppress_defaults</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">grdfile</span> <span class="o">=</span> <span class="n">gmt</span><span class="o">.</span><span class="n">tempfilename</span><span class="p">()</span>
        <span class="n">gmt</span><span class="o">.</span><span class="n">xyz2grd</span><span class="p">(</span>
            <span class="n">G</span><span class="o">=</span><span class="n">grdfile</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">,</span> <span class="n">I</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">/</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lons_inc</span><span class="p">,</span> <span class="n">lats_inc</span><span class="p">),</span>
            <span class="n">in_columns</span><span class="o">=</span><span class="p">(</span><span class="n">lons</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">lats</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">kde_vals</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span>  <span class="c1"># noqa</span>
            <span class="n">out_discard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">gmt</span><span class="o">.</span><span class="n">grdimage</span><span class="p">(</span><span class="n">grdfile</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">,</span> <span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="n">cptfilepath</span><span class="p">)</span>

        <span class="c1"># gmt.pscontour(</span>
        <span class="c1">#    in_columns=(lons.ravel(), lats.ravel(),  kde_vals.ravel()),</span>
        <span class="c1">#    R=R, J=J, I=True, N=True, A=True, C=cptfilepath)</span>
        <span class="c1"># -Ctmp_$out.cpt -I -N -A- -O -K &gt;&gt; $ps</span>

    <span class="n">h</span> <span class="o">=</span> <span class="mf">20.</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="mf">1.9</span>

    <span class="n">gmtconfig</span> <span class="o">=</span> <span class="n">get_gmt_config</span><span class="p">(</span><span class="n">gmtpy</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="n">bin_width</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># tick increment</span>

    <span class="n">J</span> <span class="o">=</span> <span class="s1">&#39;H0/</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="mf">5.</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="s1">&#39;-30/30/-90/90&#39;</span>
    <span class="n">B</span> <span class="o">=</span> <span class="s1">&#39;f</span><span class="si">%i</span><span class="s1">g</span><span class="si">%i</span><span class="s1">/f</span><span class="si">%i</span><span class="s1">g</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bin_width</span><span class="p">,</span> <span class="n">bin_width</span><span class="p">,</span> <span class="n">bin_width</span><span class="p">,</span> <span class="n">bin_width</span><span class="p">)</span>
    <span class="c1"># range_arg=&quot;-T${zmin}/${zmax}/${dz}&quot;</span>

    <span class="n">gmt</span> <span class="o">=</span> <span class="n">gmtpy</span><span class="o">.</span><span class="n">GMT</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">gmtconfig</span><span class="p">)</span>

    <span class="n">draw_lune_kde</span><span class="p">(</span>
        <span class="n">gmt</span><span class="p">,</span> <span class="n">v_tape</span><span class="o">=</span><span class="n">v_tape</span><span class="p">,</span> <span class="n">w_tape</span><span class="o">=</span><span class="n">w_tape</span><span class="p">,</span> <span class="n">grid_size</span><span class="o">=</span><span class="p">(</span><span class="mi">701</span><span class="p">,</span> <span class="mi">301</span><span class="p">),</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">,</span> <span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">)</span>
    <span class="n">gmt</span><span class="o">.</span><span class="n">psbasemap</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">,</span> <span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="n">B</span><span class="p">)</span>
    <span class="n">draw_lune_arcs</span><span class="p">(</span><span class="n">gmt</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">,</span> <span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">)</span>
    <span class="n">draw_lune_points</span><span class="p">(</span><span class="n">gmt</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="n">R</span><span class="p">,</span> <span class="n">J</span><span class="o">=</span><span class="n">J</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gmt</span>


<span class="k">def</span> <span class="nf">draw_station_map_cartopy</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">po</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">mticker</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Drawing Station Map ...&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">cartopy</span> <span class="k">as</span> <span class="nn">ctp</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s1">&#39;Cartopy is not installed.&#39;</span>
            <span class="s1">&#39;For a station map cartopy needs to be installed!&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">draw_gridlines</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
        <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">grid_proj</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">n_steps</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">xlines</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">gl</span><span class="o">.</span><span class="n">ylocator</span> <span class="o">=</span> <span class="n">mticker</span><span class="o">.</span><span class="n">FixedLocator</span><span class="p">([</span><span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">90</span><span class="p">])</span>

    <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="k">if</span> <span class="s1">&#39;seismic&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">problem_config</span><span class="o">.</span><span class="n">datatypes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;Station map is available only for seismic stations!&#39;</span>
            <span class="s1">&#39; However, the datatypes do not include &quot;seismic&quot; data&#39;</span><span class="p">)</span>

    <span class="n">event</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">event</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">composites</span><span class="p">[</span><span class="s1">&#39;seismic&#39;</span><span class="p">]</span>

    <span class="n">mpl_init</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">stations_proj</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">wmap</span> <span class="ow">in</span> <span class="n">sc</span><span class="o">.</span><span class="n">wavemaps</span><span class="p">:</span>
        <span class="n">outpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">problem</span><span class="o">.</span><span class="n">outfolder</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">figure_dir</span><span class="p">,</span> <span class="s1">&#39;station_map_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%i</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">wmap</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">wmap</span><span class="o">.</span><span class="n">mapnumber</span><span class="p">,</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">po</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">wmap</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">distances</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
                <span class="n">map_proj</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">Orthographic</span><span class="p">(</span>
                    <span class="n">central_longitude</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">central_latitude</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
                <span class="n">extent</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">max_dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">wmap</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">map_proj</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
                <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">lon</span> <span class="o">-</span> <span class="n">max_dist</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">lon</span> <span class="o">+</span> <span class="n">max_dist</span><span class="p">,</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">lat</span> <span class="o">-</span> <span class="n">max_dist</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">lat</span> <span class="o">+</span> <span class="n">max_dist</span><span class="p">]</span>

            <span class="n">grid_proj</span> <span class="o">=</span> <span class="n">ctp</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">RotatedPole</span><span class="p">(</span>
                <span class="n">pole_longitude</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">pole_latitude</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">mpl_papersize</span><span class="p">(</span><span class="s1">&#39;a6&#39;</span><span class="p">,</span> <span class="s1">&#39;landscape&#39;</span><span class="p">),</span>
                <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">map_proj</span><span class="p">})</span>

            <span class="n">stations_meta</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">station</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">station</span><span class="o">.</span><span class="n">station</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">wmap</span><span class="o">.</span><span class="n">stations</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">extent</span><span class="p">:</span>
                <span class="c1"># regional map</span>
                <span class="n">labelpos</span> <span class="o">=</span> <span class="n">mpl_margins</span><span class="p">(</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

                <span class="kn">import</span> <span class="nn">cartopy.feature</span> <span class="k">as</span> <span class="nn">cfeature</span>
                <span class="kn">from</span> <span class="nn">cartopy.mpl.gridliner</span> <span class="k">import</span> \
                    <span class="n">LONGITUDE_FORMATTER</span><span class="p">,</span> <span class="n">LATITUDE_FORMATTER</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">map_proj</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">NaturalEarthFeature</span><span class="p">(</span>
                    <span class="n">category</span><span class="o">=</span><span class="s1">&#39;physical&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;land&#39;</span><span class="p">,</span>
                    <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;50m&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">cfeature</span><span class="o">.</span><span class="n">LAND</span><span class="o">.</span><span class="n">kwargs</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_feature</span><span class="p">(</span><span class="n">cfeature</span><span class="o">.</span><span class="n">NaturalEarthFeature</span><span class="p">(</span>
                    <span class="n">category</span><span class="o">=</span><span class="s1">&#39;physical&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">,</span>
                    <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;50m&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">cfeature</span><span class="o">.</span><span class="n">OCEAN</span><span class="o">.</span><span class="n">kwargs</span><span class="p">))</span>

                <span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">gl</span><span class="o">.</span><span class="n">ylocator</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">gl</span><span class="o">.</span><span class="n">xlocator</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">gl</span><span class="o">.</span><span class="n">xlabels_top</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">gl</span><span class="o">.</span><span class="n">ylabels_right</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">gl</span><span class="o">.</span><span class="n">xformatter</span> <span class="o">=</span> <span class="n">LONGITUDE_FORMATTER</span>
                <span class="n">gl</span><span class="o">.</span><span class="n">yformatter</span> <span class="o">=</span> <span class="n">LATITUDE_FORMATTER</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># global teleseismic map</span>
                <span class="n">labelpos</span> <span class="o">=</span> <span class="n">mpl_margins</span><span class="p">(</span>
                    <span class="n">fig</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">coastlines</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                <span class="n">draw_gridlines</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">stock_img</span><span class="p">()</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">stations_meta</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="s1">&#39;r^&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">stations_proj</span><span class="p">,</span>
                    <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">markeredgewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">stations_proj</span><span class="p">,</span>
                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">event</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">stations_proj</span><span class="p">,</span>
                <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">markeredgewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">scolor</span><span class="p">(</span><span class="s1">&#39;butter1&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">po</span><span class="o">.</span><span class="n">outformat</span> <span class="o">==</span> <span class="s1">&#39;display&#39;</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving figure to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">outpath</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outpath</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">outformat</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">po</span><span class="o">.</span><span class="n">dpi</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Plot exists! Use --force to overwrite!&#39;</span><span class="p">)</span>


<span class="n">plots_catalog</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;correlation_hist&#39;</span><span class="p">:</span> <span class="n">draw_correlation_hist</span><span class="p">,</span>
    <span class="s1">&#39;stage_posteriors&#39;</span><span class="p">:</span> <span class="n">draw_posteriors</span><span class="p">,</span>
    <span class="s1">&#39;waveform_fits&#39;</span><span class="p">:</span> <span class="n">draw_seismic_fits</span><span class="p">,</span>
    <span class="s1">&#39;scene_fits&#39;</span><span class="p">:</span> <span class="n">draw_scene_fits</span><span class="p">,</span>
    <span class="s1">&#39;gnss_fits&#39;</span><span class="p">:</span> <span class="n">draw_gnss_fits</span><span class="p">,</span>
    <span class="s1">&#39;velocity_models&#39;</span><span class="p">:</span> <span class="n">draw_earthmodels</span><span class="p">,</span>
    <span class="s1">&#39;slip_distribution&#39;</span><span class="p">:</span> <span class="n">draw_slip_dist</span><span class="p">,</span>
    <span class="s1">&#39;hudson&#39;</span><span class="p">:</span> <span class="n">draw_hudson</span><span class="p">,</span>
    <span class="s1">&#39;lune&#39;</span><span class="p">:</span> <span class="n">draw_lune_plot</span><span class="p">,</span>
    <span class="s1">&#39;fuzzy_beachball&#39;</span><span class="p">:</span> <span class="n">draw_fuzzy_beachball</span><span class="p">,</span>
    <span class="s1">&#39;fuzzy_mt_decomp&#39;</span><span class="p">:</span> <span class="n">draw_fuzzy_mt_decomposition</span><span class="p">,</span>
    <span class="s1">&#39;moment_rate&#39;</span><span class="p">:</span> <span class="n">draw_moment_rate</span><span class="p">,</span>
    <span class="s1">&#39;station_map&#39;</span><span class="p">:</span> <span class="n">draw_station_map_gmt</span><span class="p">}</span>


<span class="n">common_plots</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;stage_posteriors&#39;</span><span class="p">,</span>
    <span class="s1">&#39;velocity_models&#39;</span><span class="p">]</span>


<span class="n">seismic_plots</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;station_map&#39;</span><span class="p">,</span>
    <span class="s1">&#39;waveform_fits&#39;</span><span class="p">]</span>


<span class="n">geodetic_plots</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;scene_fits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;gnss_fits&#39;</span><span class="p">]</span>


<span class="n">geometry_plots</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;correlation_hist&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hudson&#39;</span><span class="p">,</span>
    <span class="s1">&#39;lune&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fuzzy_beachball&#39;</span><span class="p">]</span>


<span class="n">ffi_plots</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;moment_rate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;slip_distribution&#39;</span><span class="p">]</span>


<span class="n">plots_mode_catalog</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">common_plots</span> <span class="o">+</span> <span class="n">geometry_plots</span><span class="p">,</span>
    <span class="s1">&#39;ffi&#39;</span><span class="p">:</span> <span class="n">common_plots</span> <span class="o">+</span> <span class="n">ffi_plots</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">plots_datatype_catalog</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;seismic&#39;</span><span class="p">:</span> <span class="n">seismic_plots</span><span class="p">,</span>
    <span class="s1">&#39;geodetic&#39;</span><span class="p">:</span> <span class="n">geodetic_plots</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">available_plots</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datatypes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;geodetic&#39;</span><span class="p">,</span> <span class="s1">&#39;seismic&#39;</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">plots_catalog</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plots</span> <span class="o">=</span> <span class="n">plots_mode_catalog</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="n">datatypes</span><span class="p">:</span>
            <span class="n">plots</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">plots_datatype_catalog</span><span class="p">[</span><span class="n">datatype</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">plots</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    
<h3><a href="../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../short_installation.html">Short Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../anaconda_installation.html">Anaconda Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Detailed Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../updating.html">Updating beat</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting started with BEAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
    &nbsp;
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Hannes Vasyura-Bathke.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.7.
    </div>
  </body>
</html>