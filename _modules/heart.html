<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>heart &#8212; beat 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="../_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    
      <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto+Slab">
    
    
    <script type="text/javascript" src="../_static/jquery.gifplayer.js"></script>
    <link rel="stylesheet" type="text/css" href="../_static/gifplayer.css">
    <!-- Piwik -->
    <script type="text/javascript">
      var _paq = _paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="//pyrocko.org/pwk/";
        _paq.push(['setTrackerUrl', u+'piwik.php']);
        _paq.push(['setSiteId', '1']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <noscript>
    <img src="https://pyrocko.org/pwk/piwik.php?idsite=1&rec=1" style="border:0" alt="" />
    </noscript>

  </head>
  <body>

    <div class="related">
      <h3>Navigation</h3>
        <ul>
          <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
          <li>
            <img src='https://pyrocko.org/_static/pyrocko.svg' class='pyrocko-button' onclick="window.location = 'https://pyrocko.org';">
          </li>
           &#187;
          <li>
              <a href="../index.html">beat 1.0 documentation</a> &#187;
          </li>
            <li><a href="index.html" accesskey="U">Module code</a> &#187;</li> 
        </ul>
    </div>
    

  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for heart</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Core module with functions to calculate Greens Functions and synthetics.</span>
<span class="sd">Also contains main classes for setup specific parameters.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>

<span class="kn">from</span> <span class="nn">beat</span> <span class="k">import</span> <span class="n">psgrn</span><span class="p">,</span> <span class="n">pscmp</span><span class="p">,</span> <span class="n">utility</span><span class="p">,</span> <span class="n">qseis2d</span>

<span class="kn">from</span> <span class="nn">theano</span> <span class="k">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">tconfig</span>
<span class="kn">from</span> <span class="nn">theano</span> <span class="k">import</span> <span class="n">shared</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">num</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">linalg</span>

<span class="kn">from</span> <span class="nn">pyrocko.guts</span> <span class="k">import</span> <span class="p">(</span><span class="n">Dict</span><span class="p">,</span> <span class="n">Object</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">StringChoice</span><span class="p">,</span>
                          <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Bool</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyrocko.guts_array</span> <span class="k">import</span> <span class="n">Array</span>

<span class="kn">from</span> <span class="nn">pyrocko</span> <span class="k">import</span> <span class="n">crust2x2</span><span class="p">,</span> <span class="n">gf</span><span class="p">,</span> <span class="n">cake</span><span class="p">,</span> <span class="n">orthodrome</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">pyrocko.cake</span> <span class="k">import</span> <span class="n">GradientLayer</span>
<span class="kn">from</span> <span class="nn">pyrocko.fomosto</span> <span class="k">import</span> <span class="n">qseis</span><span class="p">,</span> <span class="n">qssp</span>
<span class="kn">from</span> <span class="nn">pyrocko.model</span> <span class="k">import</span> <span class="n">gnss</span>

<span class="c1"># from pyrocko.fomosto import qseis2d</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;heart&#39;</span><span class="p">)</span>

<span class="n">c</span> <span class="o">=</span> <span class="mf">299792458.</span>  <span class="c1"># [m/s]</span>
<span class="n">km</span> <span class="o">=</span> <span class="mf">1000.</span>
<span class="n">d2r</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span>
<span class="n">r2d</span> <span class="o">=</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span>
<span class="n">near_field_threshold</span> <span class="o">=</span> <span class="mf">9.</span>  <span class="c1"># [deg] below that surface waves are calculated</span>

<span class="n">lambda_sensors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Envisat&#39;</span><span class="p">:</span> <span class="mf">0.056</span><span class="p">,</span>       <span class="c1"># needs updating- no ressource file</span>
    <span class="s1">&#39;ERS1&#39;</span><span class="p">:</span> <span class="mf">0.05656461471698113</span><span class="p">,</span>
    <span class="s1">&#39;ERS2&#39;</span><span class="p">:</span> <span class="mf">0.056</span><span class="p">,</span>          <span class="c1"># needs updating</span>
    <span class="s1">&#39;JERS&#39;</span><span class="p">:</span> <span class="mf">0.23513133960784313</span><span class="p">,</span>
    <span class="s1">&#39;RadarSat2&#39;</span><span class="p">:</span> <span class="mf">0.055465772433</span><span class="p">}</span>


<div class="viewcode-block" id="log_determinant"><a class="viewcode-back" href="../api.html#heart.log_determinant">[docs]</a><span class="k">def</span> <span class="nf">log_determinant</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">inverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the natural logarithm of a determinant of the given matrix &#39;</span>
<span class="sd">    according to the properties of a triangular matrix.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    A : n x n :class:`numpy.ndarray`</span>
<span class="sd">    inverse : boolean</span>
<span class="sd">        If true calculates the log determinant of the inverse of the colesky</span>
<span class="sd">        decomposition, which is equvalent to taking the determinant of the</span>
<span class="sd">        inverse of the matrix.</span>

<span class="sd">        L.T* L = R           inverse=False</span>
<span class="sd">        L-1*(L-1)T = R-1     inverse=True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float logarithm of the determinant of the input Matrix A</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cholesky</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inverse</span><span class="p">:</span>
        <span class="n">cholesky</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cholesky</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cholesky</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mf">2.</span></div>


<div class="viewcode-block" id="ReferenceLocation"><a class="viewcode-back" href="../api.html#heart.ReferenceLocation">[docs]</a><span class="k">class</span> <span class="nc">ReferenceLocation</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">Location</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reference Location for Green&#39;s Function store calculations!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">station</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Store_Name&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;This mimics the station.station attribute which determines the&#39;</span>
             <span class="s1">&#39; store name!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Covariance"><a class="viewcode-back" href="../api.html#heart.Covariance">[docs]</a><span class="k">class</span> <span class="nc">Covariance</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Covariance of an observation. Holds data and model prediction uncertainties</span>
<span class="sd">    for one observation object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Data covariance matrix&#39;</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pred_g</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Model prediction covariance matrix, fault geometry&#39;</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pred_v</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Model prediction covariance matrix, velocity model&#39;</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slog_pdet</span> <span class="o">=</span> <span class="n">shared</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;cov_normalisation&#39;</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Object</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_slog_pdet</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">covs_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;pred_g&#39;</span><span class="p">,</span> <span class="s1">&#39;pred_v&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="Covariance.check_matrix_init"><a class="viewcode-back" href="../api.html#heart.Covariance.check_matrix_init">[docs]</a>    <span class="k">def</span> <span class="nf">check_matrix_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov_mat_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if matrix is initialised and if not set with zeros of size data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cov_mat_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">covs_supported</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;Covariance term </span><span class="si">%s</span><span class="s1"> not supported&#39;</span> <span class="o">%</span> <span class="n">cov_mat_str</span><span class="p">)</span>

        <span class="n">cov_mat</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov_mat_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cov_mat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cov_mat</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cov_mat</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cov_mat</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">cov_mat</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> covariances defined but size &#39;</span>
                    <span class="s1">&#39;inconsistent!&#39;</span> <span class="o">%</span> <span class="n">cov_mat_str</span><span class="p">)</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov_mat_str</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">p_total</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_matrix_init</span><span class="p">(</span><span class="s1">&#39;pred_g&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_matrix_init</span><span class="p">(</span><span class="s1">&#39;pred_v&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_g</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pred_v</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add and invert ALL uncertainty covariance Matrices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Cx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_total</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">Cx</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No covariances given!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Cx</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inverse_p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add and invert different MODEL uncertainty covariance Matrices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_total</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No model covariance defined!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p_total</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inverse_d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invert DATA covariance Matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;No data covariance matrix defined!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cholesky decomposition of ALL uncertainty covariance matrices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Cx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_total</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="n">Cx</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No covariances given!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">Cx</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chol_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cholesky decomposition of the Inverse of the Covariance matrix of</span>
<span class="sd">        ALL uncertainty covariance</span>
<span class="sd">        matrices. To be used as weight in the optimization.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lower triangle of the cholesky decomposition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inverse</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_pdet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the log of the determinant of the total matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ldet_x</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chol</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mf">2.</span>
        <span class="k">return</span> <span class="n">utility</span><span class="o">.</span><span class="n">scalar2floatX</span><span class="p">(</span><span class="n">ldet_x</span><span class="p">)</span>

<div class="viewcode-block" id="Covariance.update_slog_pdet"><a class="viewcode-back" href="../api.html#heart.Covariance.update_slog_pdet">[docs]</a>    <span class="k">def</span> <span class="nf">update_slog_pdet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update shared variable with current log_norm_factor (lnf)</span>
<span class="sd">        (for theano models).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slog_pdet</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_pdet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slog_pdet</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ArrivalTaper"><a class="viewcode-back" href="../api.html#heart.ArrivalTaper">[docs]</a><span class="k">class</span> <span class="nc">ArrivalTaper</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">Taper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cosine arrival Taper.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=-</span><span class="mf">15.</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;start of fading in; [s] w.r.t. phase arrival&#39;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=-</span><span class="mf">10.</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;end of fading in; [s] w.r.t. phase arrival&#39;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">50.</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;start of fading out; [s] w.r.t. phase arrival&#39;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">55.</span><span class="p">,</span>
                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;end of fading out; [s] w.r.t phase arrival&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ArrivalTaper.check_sample_rate_consistency"><a class="viewcode-back" href="../api.html#heart.ArrivalTaper.check_sample_rate_consistency">[docs]</a>    <span class="k">def</span> <span class="nf">check_sample_rate_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deltat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if taper durations are consistent with GF sample rate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">chop_b</span> <span class="ow">in</span> <span class="p">([</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]):</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">(</span><span class="n">chop_b</span><span class="p">)</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">duration</span> <span class="o">/</span> <span class="n">deltat</span>
            <span class="n">utility</span><span class="o">.</span><span class="n">error_not_whole</span><span class="p">(</span>
                <span class="n">ratio</span><span class="p">,</span>
                <span class="n">errstr</span><span class="o">=</span><span class="s1">&#39;Taper duration </span><span class="si">%g</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> is inconsistent with&#39;</span>
                       <span class="s1">&#39; sampling rate of </span><span class="si">%g</span><span class="s1">! Please adjust Taper values!&#39;</span> <span class="o">%</span> <span class="p">(</span>
                           <span class="n">duration</span><span class="p">,</span> <span class="n">utility</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">chop_b</span><span class="p">),</span> <span class="n">deltat</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">duration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]):</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span>

<div class="viewcode-block" id="ArrivalTaper.nsamples"><a class="viewcode-back" href="../api.html#heart.ArrivalTaper.nsamples">[docs]</a>    <span class="k">def</span> <span class="nf">nsamples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of samples a tapered trace would have given</span>
<span class="sd">        its sample rate and chop_bounds</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample_rate : float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">sample_rate</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">(</span><span class="n">chop_bounds</span><span class="p">)))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fadein</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fadeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

<div class="viewcode-block" id="ArrivalTaper.get_pyrocko_taper"><a class="viewcode-back" href="../api.html#heart.ArrivalTaper.get_pyrocko_taper">[docs]</a>    <span class="k">def</span> <span class="nf">get_pyrocko_taper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrival_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get pyrocko CosTaper object that may be applied to trace operations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arrival_time : float</span>
<span class="sd">            [s] of the reference time around which the taper will be applied</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`pyrocko.trace.CosTaper`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Taper values violate: a &lt; b &lt; c &lt; d&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">trace</span><span class="o">.</span><span class="n">CosTaper</span><span class="p">(</span>
            <span class="n">arrival_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span>
            <span class="n">arrival_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
            <span class="n">arrival_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>
            <span class="n">arrival_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Trace"><a class="viewcode-back" href="../api.html#heart.Trace">[docs]</a><span class="k">class</span> <span class="nc">Trace</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="FilterBase"><a class="viewcode-back" href="../api.html#heart.FilterBase">[docs]</a><span class="k">class</span> <span class="nc">FilterBase</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="Filter"><a class="viewcode-back" href="../api.html#heart.Filter">[docs]</a><span class="k">class</span> <span class="nc">Filter</span><span class="p">(</span><span class="n">FilterBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter object defining frequency range of traces after time-domain</span>
<span class="sd">    filtering.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lower_corner</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Lower corner frequency&#39;</span><span class="p">)</span>
    <span class="n">upper_corner</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Upper corner frequency&#39;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;order of filter, the higher the steeper&#39;</span><span class="p">)</span>
    <span class="n">stepwise</span> <span class="o">=</span> <span class="n">Bool</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If set to true the bandpass filter is done it two&#39;</span>
             <span class="s1">&#39; consecutive steps, first high-pass then low-pass.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="c1"># filter traces</span>
        <span class="c1"># stepwise</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stepwise</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stepwise HP LP filtering&#39;</span><span class="p">)</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">highpass</span><span class="p">(</span>
                <span class="n">corner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_corner</span><span class="p">,</span>
                <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                <span class="n">demean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">lowpass</span><span class="p">(</span>
                <span class="n">corner</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_corner</span><span class="p">,</span>
                <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                <span class="n">demean</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Single BP filtering&#39;</span><span class="p">)</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">bandpass</span><span class="p">(</span>
                <span class="n">corner_hp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_corner</span><span class="p">,</span>
                <span class="n">corner_lp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_corner</span><span class="p">,</span>
                <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">)</span></div>


<div class="viewcode-block" id="BandstopFilter"><a class="viewcode-back" href="../api.html#heart.BandstopFilter">[docs]</a><span class="k">class</span> <span class="nc">BandstopFilter</span><span class="p">(</span><span class="n">FilterBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter object defining suppressed frequency range of traces after</span>
<span class="sd">    time-domain filtering.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lower_corner</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Lower corner frequency&#39;</span><span class="p">)</span>
    <span class="n">upper_corner</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Upper corner frequency&#39;</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">Int</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;order of filter, the higher the steeper&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;single bandstop filtering&#39;</span><span class="p">)</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">bandstop</span><span class="p">(</span>
            <span class="n">corner_hp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_corner</span><span class="p">,</span>
            <span class="n">corner_lp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_corner</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="FrequencyFilter"><a class="viewcode-back" href="../api.html#heart.FrequencyFilter">[docs]</a><span class="k">class</span> <span class="nc">FrequencyFilter</span><span class="p">(</span><span class="n">FilterBase</span><span class="p">):</span>

    <span class="n">freqlimits</span> <span class="o">=</span> <span class="n">Tuple</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="mi">4</span><span class="p">,</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(),</span>
        <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.006</span><span class="p">,</span> <span class="mf">166.</span><span class="p">,</span> <span class="mf">200.</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Corner frequencies 4-tuple [Hz] for frequency domain filter.&#39;</span><span class="p">)</span>
    <span class="n">tfade</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Rise/fall time in seconds of taper applied in timedomain at both&#39;</span>
             <span class="s1">&#39; ends of trace.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">transfer</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tfade</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freqlimits</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cut_off_fading</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="ResultPoint"><a class="viewcode-back" href="../api.html#heart.ResultPoint">[docs]</a><span class="k">class</span> <span class="nc">ResultPoint</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Containing point in solution space.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">post_llk</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;describes which posterior likelihood value the point belongs to&#39;</span><span class="p">)</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">Dict</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(),</span>
        <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
            <span class="n">serialize_as</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Point in Solution space for which result is produced.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SeismicResult"><a class="viewcode-back" href="../api.html#heart.SeismicResult">[docs]</a><span class="k">class</span> <span class="nc">SeismicResult</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Result object assembling different traces of misfit.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">ResultPoint</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">ResultPoint</span><span class="o">.</span><span class="n">D</span><span class="p">())</span>
    <span class="n">processed_obs</span> <span class="o">=</span> <span class="n">Trace</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#    processed_syn = Trace.T(optional=True)</span>
<span class="c1">#    processed_res = Trace.T(optional=True)</span>
    <span class="n">arrival_taper</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">Taper</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">llk</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">taper</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">Taper</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">source_contributions</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">Trace</span><span class="o">.</span><span class="n">T</span><span class="p">(),</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;synthetics of source individual contributions.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">processed_syn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_contributions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tr0</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_contributions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">tr0</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">tr0</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_contributions</span><span class="p">:</span>
                <span class="n">tr0</span><span class="o">.</span><span class="n">ydata</span> <span class="o">+=</span> <span class="n">tr</span><span class="o">.</span><span class="n">ydata</span>

        <span class="k">return</span> <span class="n">tr0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">processed_res</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tr</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">processed_syn</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tr</span></div>


<span class="k">def</span> <span class="nf">results_for_export</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">attributes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Either datatype or attributes need to be defined!&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;geodetic&#39;</span> <span class="ow">or</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;seismic&#39;</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;processed_obs&#39;</span><span class="p">,</span> <span class="s1">&#39;processed_syn&#39;</span><span class="p">,</span> <span class="s1">&#39;processed_res&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s1">&#39;datatype </span><span class="si">%s</span><span class="s1"> not implemented!&#39;</span> <span class="o">%</span> <span class="n">datatype</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s1">&#39;Result object does not have the attribute &#39;</span>
                <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; to export!&#39;</span> <span class="o">%</span> <span class="n">attribute</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">data</span><span class="p">,</span> <span class="n">attribute</span>


<span class="n">sqrt2</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>

<span class="n">physical_bounds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">east_shift</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">500.</span><span class="p">,</span> <span class="mf">500.</span><span class="p">),</span>
    <span class="n">north_shift</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">500.</span><span class="p">,</span> <span class="mf">500.</span><span class="p">),</span>
    <span class="n">depth</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">),</span>
    <span class="n">strike</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">90.</span><span class="p">,</span> <span class="mf">420.</span><span class="p">),</span>
    <span class="n">strike1</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">90.</span><span class="p">,</span> <span class="mf">420.</span><span class="p">),</span>
    <span class="n">strike2</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">90.</span><span class="p">,</span> <span class="mf">420.</span><span class="p">),</span>
    <span class="n">dip</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">45.</span><span class="p">,</span> <span class="mf">135.</span><span class="p">),</span>
    <span class="n">dip1</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">45.</span><span class="p">,</span> <span class="mf">135.</span><span class="p">),</span>
    <span class="n">dip2</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">45.</span><span class="p">,</span> <span class="mf">135.</span><span class="p">),</span>
    <span class="n">rake</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">270.</span><span class="p">),</span>
    <span class="n">rake1</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">270.</span><span class="p">),</span>
    <span class="n">rake2</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">270.</span><span class="p">),</span>
    <span class="n">mix</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>

    <span class="n">diameter</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">),</span>
    <span class="n">volume_change</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1e12</span><span class="p">,</span> <span class="mf">1e12</span><span class="p">),</span>

    <span class="n">mnn</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">sqrt2</span><span class="p">,</span> <span class="n">sqrt2</span><span class="p">),</span>
    <span class="n">mee</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">sqrt2</span><span class="p">,</span> <span class="n">sqrt2</span><span class="p">),</span>
    <span class="n">mdd</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">sqrt2</span><span class="p">,</span> <span class="n">sqrt2</span><span class="p">),</span>
    <span class="n">mne</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
    <span class="n">mnd</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
    <span class="n">med</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>

    <span class="n">w</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">3.</span> <span class="o">/</span> <span class="mf">8.</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mf">3.</span> <span class="o">/</span> <span class="mf">8.</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
    <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">),</span>
    <span class="n">kappa</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
    <span class="n">sigma</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">),</span>
    <span class="n">h</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>

    <span class="n">length</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">7000.</span><span class="p">),</span>
    <span class="n">width</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">500.</span><span class="p">),</span>
    <span class="n">slip</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">150.</span><span class="p">),</span>
    <span class="n">nucleation_x</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
    <span class="n">nucleation_y</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>
    <span class="n">magnitude</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">),</span>

    <span class="n">time</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">300.</span><span class="p">,</span> <span class="mf">300.</span><span class="p">),</span>
    <span class="n">time_shift</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">40.</span><span class="p">,</span> <span class="mf">40.</span><span class="p">),</span>

    <span class="n">delta_time</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">),</span>
    <span class="n">delta_depth</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">300.</span><span class="p">),</span>
    <span class="n">distance</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">300.</span><span class="p">),</span>

    <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">600.</span><span class="p">),</span>
    <span class="n">peak_ratio</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span>

    <span class="n">durations</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">600.</span><span class="p">),</span>
    <span class="n">uparr</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">150.</span><span class="p">),</span>
    <span class="n">uperp</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">150.</span><span class="p">,</span> <span class="mf">150.</span><span class="p">),</span>
    <span class="n">nucleation_strike</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
    <span class="n">nucleation_dip</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
    <span class="n">velocities</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">),</span>

    <span class="n">azimuth</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">),</span>
    <span class="n">amplitude</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">10e25</span><span class="p">),</span>
    <span class="n">bl_azimuth</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">),</span>
    <span class="n">bl_amplitude</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
    <span class="n">locking_depth</span><span class="o">=</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">100.</span><span class="p">),</span>

    <span class="n">hypers</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),</span>

    <span class="n">ramp</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
    <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
    <span class="n">lat</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">90.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">),</span>
    <span class="n">lon</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">),</span>
    <span class="n">omega</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">))</span>


<div class="viewcode-block" id="Parameter"><a class="viewcode-back" href="../api.html#heart.Parameter">[docs]</a><span class="k">class</span> <span class="nc">Parameter</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimization parameter determines the bounds of the search space.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;depth&#39;</span><span class="p">)</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;Uniform&#39;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type of prior distribution to use. Options:&#39;</span>
                         <span class="s1">&#39; &quot;Uniform&quot;, ...&#39;</span><span class="p">)</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">,</span>
                    <span class="n">serialize_as</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">))</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">,</span>
                    <span class="n">serialize_as</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">))</span>
    <span class="n">testvalue</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">,</span>
                        <span class="n">serialize_as</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">supported_vars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">physical_bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_vars</span><span class="p">:</span>
            <span class="n">candidate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">supported_vars</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">candidate</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;h_&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s1">&#39;The parameter &quot;</span><span class="si">%s</span><span class="s1">&quot; cannot&#39;</span>
                    <span class="s1">&#39; be optimized for!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;hypers&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">phys_b</span> <span class="o">=</span> <span class="n">physical_bounds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dimension</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;The upper parameter bound for&#39;</span>
                        <span class="s1">&#39; parameter &quot;</span><span class="si">%s</span><span class="s1">&quot; must be higher than the lower&#39;</span>
                        <span class="s1">&#39; bound&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testvalue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">testvalue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;The testvalue of parameter &quot;</span><span class="si">%s</span><span class="s1">&quot; has to&#39;</span>
                        <span class="s1">&#39; be within the upper and lower bounds&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">phys_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">phys_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;The parameter bounds (</span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">) for &quot;</span><span class="si">%s</span><span class="s1">&quot; are outside of&#39;</span>
                        <span class="s1">&#39; physically meaningful values (</span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">)!&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">phys_b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phys_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Parameter bounds for &quot;</span><span class="si">%s</span><span class="s1">&quot; have to be defined!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<div class="viewcode-block" id="Parameter.random"><a class="viewcode-back" href="../api.html#heart.Parameter.random">[docs]</a>    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create random samples within the parameter bounds.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dimensions : int</span>
<span class="sd">            number of draws from distribution</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray` of size (n, m)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dimension</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dimension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimension</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span>
                <span class="n">dimension</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Either use number of patches input vector size for&#39;</span>
                <span class="s1">&#39; variable </span><span class="si">{}</span><span class="s1"> or only [1]]! Now the size is </span><span class="si">{}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">size</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dimension</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="o">.</span><span class="n">size</span>

    <span class="k">def</span> <span class="nf">bound_to_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">],</span>
                         <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span></div>


<div class="viewcode-block" id="DynamicTarget"><a class="viewcode-back" href="../api.html#heart.DynamicTarget">[docs]</a><span class="k">class</span> <span class="nc">DynamicTarget</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">Target</span><span class="p">):</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">PoleZeroResponse</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">magnification</span><span class="p">,</span> <span class="n">damping</span><span class="p">,</span> <span class="n">period</span><span class="p">):</span>
        <span class="n">z</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">proto2zpk</span><span class="p">(</span>
            <span class="n">magnification</span><span class="p">,</span> <span class="n">damping</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="s1">&#39;displacement&#39;</span><span class="p">)</span>
        <span class="c1"># b, a = zpk2tf(z, p, k)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">zeros</span> <span class="o">=</span> <span class="n">z</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">poles</span> <span class="o">=</span> <span class="n">p</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">constant</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Initializing new response!&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">PoleZeroResponse</span><span class="p">(</span>
                <span class="n">zeros</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">poles</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">constant</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>

<div class="viewcode-block" id="DynamicTarget.update_target_times"><a class="viewcode-back" href="../api.html#heart.DynamicTarget.update_target_times">[docs]</a>    <span class="k">def</span> <span class="nf">update_target_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">taperer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the target attributes tmin and tmax to do the stacking</span>
<span class="sd">        only in this interval. Adds twice taper fade in time to each taper</span>
<span class="sd">        side.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : list</span>
<span class="sd">            containing :class:`pyrocko.gf.seismosizer.Source` Objects</span>
<span class="sd">        taperer : :class:`pyrocko.trace.CosTaper`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">taperer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tolerance</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">taperer</span><span class="o">.</span><span class="n">b</span> <span class="o">-</span> <span class="n">taperer</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span> <span class="o">=</span> <span class="n">taperer</span><span class="o">.</span><span class="n">a</span> <span class="o">-</span> <span class="n">tolerance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">taperer</span><span class="o">.</span><span class="n">d</span> <span class="o">+</span> <span class="n">tolerance</span></div></div>


<div class="viewcode-block" id="SeismicDataset"><a class="viewcode-back" href="../api.html#heart.SeismicDataset">[docs]</a><span class="k">class</span> <span class="nc">SeismicDataset</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">Trace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extension to :class:`pyrocko.trace.Trace` to have</span>
<span class="sd">    :class:`Covariance` as an attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">wavename</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">covariance</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;Dataset has no uncertainties! Return full data length!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_len</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_wavename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavename</span> <span class="o">=</span> <span class="n">wavename</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">typ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavename</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pyrocko_trace</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">tmin</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span>
            <span class="n">tmax</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span>
            <span class="n">ydata</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span>
            <span class="n">station</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
            <span class="n">channel</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span>
            <span class="n">network</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
            <span class="n">deltat</span><span class="o">=</span><span class="n">trace</span><span class="o">.</span><span class="n">deltat</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtime</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">,</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">tmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtime</span><span class="p">,</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariance</span> <span class="o">=</span> <span class="n">state</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_growbuffer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_ids</span><span class="p">()</span></div>


<div class="viewcode-block" id="GeodeticDataset"><a class="viewcode-back" href="../api.html#heart.GeodeticDataset">[docs]</a><span class="k">class</span> <span class="nc">GeodeticDataset</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">MultiLocation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overall geodetic data set class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">typ</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;SAR&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type of geodetic data, e.g. SAR, GNSS, ...&#39;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;e.g. GNSS campaign name or InSAR satellite track &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_correction</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrections</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GeodeticDataset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="GeodeticDataset.get_corrections"><a class="viewcode-back" href="../api.html#heart.GeodeticDataset.get_corrections">[docs]</a>    <span class="k">def</span> <span class="nf">get_corrections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hierarchicals</span><span class="p">,</span> <span class="n">point</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Needs to be specified on inherited dataset classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Needs implementation in subclass&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeodeticDataset.setup_corrections"><a class="viewcode-back" href="../api.html#heart.GeodeticDataset.setup_corrections">[docs]</a>    <span class="k">def</span> <span class="nf">setup_corrections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">correction_configs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise geodetic dataset corrections such as Ramps or Euler Poles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corrections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_local_coords</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">corr_conf</span> <span class="ow">in</span> <span class="n">correction_configs</span><span class="p">:</span>
            <span class="n">corr</span> <span class="o">=</span> <span class="n">corr_conf</span><span class="o">.</span><span class="n">init_correction</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">corr_conf</span><span class="o">.</span><span class="n">dataset_names</span> <span class="ow">and</span> <span class="n">corr_conf</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Setting up </span><span class="si">%s</span><span class="s1"> correction for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">corr_conf</span><span class="o">.</span><span class="n">feature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">locx_name</span><span class="p">,</span> <span class="n">locy_name</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">get_required_coordinate_names</span><span class="p">()</span>

                <span class="n">locx</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locx_name</span><span class="p">)</span>
                <span class="n">locy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">locy_name</span><span class="p">)</span>

                <span class="n">blacklist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_blacklist</span><span class="p">(</span><span class="n">corr_conf</span><span class="p">)</span>

                <span class="n">corr</span><span class="o">.</span><span class="n">setup_correction</span><span class="p">(</span>
                    <span class="n">locy</span><span class="o">=</span><span class="n">locy</span><span class="p">,</span> <span class="n">locx</span><span class="o">=</span><span class="n">locx</span><span class="p">,</span> <span class="n">los_vector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span><span class="p">,</span>
                    <span class="n">blacklist</span><span class="o">=</span><span class="n">blacklist</span><span class="p">,</span>
                    <span class="n">dataset_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">has_correction</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Not correcting </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">corr_conf</span><span class="o">.</span><span class="n">feature</span><span class="p">))</span></div>

<div class="viewcode-block" id="GeodeticDataset.update_local_coords"><a class="viewcode-back" href="../api.html#heart.GeodeticDataset.update_local_coords">[docs]</a>    <span class="k">def</span> <span class="nf">update_local_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate local coordinates with respect to given Location.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        loc : :class:`pyrocko.gf.meta.Location`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray` (n_points, 3)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">north_shifts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">east_shifts</span> <span class="o">=</span> <span class="n">orthodrome</span><span class="o">.</span><span class="n">latlon_to_ne_numpy</span><span class="p">(</span>
            <span class="n">loc</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">loc</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">north_shifts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">east_shifts</span></div>

    <span class="k">def</span> <span class="nf">get_distances_to_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="n">north_shifts</span><span class="p">,</span> <span class="n">east_shifts</span> <span class="o">=</span> <span class="n">orthodrome</span><span class="o">.</span><span class="n">latlon_to_ne_numpy</span><span class="p">(</span>
            <span class="n">loc</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">loc</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">north_shifts</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">east_shifts</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">north_shifts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">north_shifts</span><span class="o">.</span><span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No coordinates defined!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span></div>


<div class="viewcode-block" id="GNSSCompoundComponent"><a class="viewcode-back" href="../api.html#heart.GNSSCompoundComponent">[docs]</a><span class="k">class</span> <span class="nc">GNSSCompoundComponent</span><span class="p">(</span><span class="n">GeodeticDataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collecting many GNSS components and merging them into arrays.</span>
<span class="sd">    Make synthetics generation more efficient.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">los_vector</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">displacement</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">component</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;east&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;direction of measurement, north/east/up&#39;</span><span class="p">)</span>
    <span class="n">stations</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">gnss</span><span class="o">.</span><span class="n">GNSSStation</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">covariance</span> <span class="o">=</span> <span class="n">Covariance</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;:py:class:`Covariance` that holds data&#39;</span>
             <span class="s1">&#39;and model prediction covariance matrixes&#39;</span><span class="p">)</span>
    <span class="n">odw</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Overlapping data weights, additional weight factor to the&#39;</span>
             <span class="s1">&#39;dataset for overlaps with other datasets&#39;</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_station2index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GNSSCompoundComponent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_los_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;east&#39;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;north&#39;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;up&#39;</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Component </span><span class="si">%s</span><span class="s1"> not supported&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">component</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;There are Nan values in LOS vector for dataset: </span><span class="si">%s</span><span class="s1">! &#39;</span>
                <span class="s1">&#39;Please check source of imported data!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;GNSS</span><span class="se">\n</span><span class="s1"> compound: </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  component: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">component</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  number of stations: </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">to_kite_scene</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">600</span><span class="p">)):</span>
        <span class="kn">from</span> <span class="nn">kite.scene</span> <span class="k">import</span> <span class="n">Scene</span><span class="p">,</span> <span class="n">SceneConfig</span>
        <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">binned_statistic_2d</span>

        <span class="n">bin_disp</span><span class="p">,</span> <span class="n">bin_lat</span><span class="p">,</span> <span class="n">bin_lon</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">binned_statistic_2d</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement</span><span class="p">,</span>
            <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting up the Kite Scene&#39;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">SceneConfig</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">llLat</span> <span class="o">=</span> <span class="n">bin_lat</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">llLon</span> <span class="o">=</span> <span class="n">bin_lon</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">dE</span> <span class="o">=</span> <span class="n">bin_lon</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_lon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">config</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">dN</span> <span class="o">=</span> <span class="n">bin_lat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">bin_lat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">config</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">spacing</span> <span class="o">=</span> <span class="s1">&#39;degree&#39;</span>

        <span class="n">config</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">scene_title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">component</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">scene_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">los_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">theta_rad</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">los_vec</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">theta_bin</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">bin_disp</span><span class="p">,</span> <span class="n">theta_rad</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">theta_bin</span><span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bin_disp</span><span class="p">)]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="n">theta_rad</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">phi_rad</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">phi_rad</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">los_vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_rad</span><span class="p">))</span>

        <span class="n">phi_bin</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">bin_disp</span><span class="p">,</span> <span class="n">phi_rad</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">phi_bin</span><span class="p">[</span><span class="n">num</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">theta_bin</span><span class="p">)]</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">scene</span> <span class="o">=</span> <span class="n">Scene</span><span class="p">(</span>
            <span class="n">theta</span><span class="o">=</span><span class="n">theta_bin</span><span class="p">,</span>
            <span class="n">phi</span><span class="o">=</span><span class="n">phi_bin</span><span class="p">,</span>
            <span class="n">displacement</span><span class="o">=</span><span class="n">bin_disp</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scene</span>

    <span class="k">def</span> <span class="nf">get_blacklist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corr_config</span><span class="p">):</span>
        <span class="n">s2idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_name_index_mapping</span><span class="p">()</span>
        <span class="n">station_blacklist_idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">corr_config</span><span class="o">.</span><span class="n">station_blacklist</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">station_blacklist_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s2idx</span><span class="p">[</span><span class="n">code</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Blacklisted station </span><span class="si">%s</span><span class="s1"> not in dataset,&#39;</span>
                    <span class="s1">&#39; skipping ...&#39;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Stations with idxs </span><span class="si">%s</span><span class="s1"> got blacklisted!&#39;</span> <span class="o">%</span>
            <span class="n">utility</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">station_blacklist_idxs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">station_blacklist_idxs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">station_name_index_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station2index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_station2index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">station</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station2index</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pyrocko_gnss_campaign</span><span class="p">(</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">campaign</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">,</span> <span class="s1">&#39;east&#39;</span><span class="p">,</span> <span class="s1">&#39;up&#39;</span><span class="p">]):</span>

        <span class="n">valid_components</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">,</span> <span class="s1">&#39;east&#39;</span><span class="p">,</span> <span class="s1">&#39;up&#39;</span><span class="p">]</span>

        <span class="n">compounds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading &quot;</span><span class="si">%s</span><span class="s1">&quot; GNSS component&#39;</span> <span class="o">%</span> <span class="n">comp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">comp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_components</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Component: </span><span class="si">%s</span><span class="s1"> not available! &#39;</span>
                    <span class="s1">&#39;Valid GNSS components are: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">comp</span><span class="p">,</span> <span class="n">utility</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">valid_components</span><span class="p">)))</span>

            <span class="n">comp_stations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">components</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">campaign</span><span class="o">.</span><span class="n">stations</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">comp</span><span class="p">])</span>
                    <span class="n">comp_stations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warngin</span><span class="p">(</span>
                        <span class="s1">&#39;No data for GNSS station: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>

            <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">loc</span><span class="o">.</span><span class="n">effective_latlon</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">comp_stations</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">vs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">shift</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components</span><span class="p">])</span>
            <span class="n">variances</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">power</span><span class="p">(</span>
                <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">sigma</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">compounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">campaign</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">typ</span><span class="o">=</span><span class="s1">&#39;GNSS&#39;</span><span class="p">,</span>
                <span class="n">stations</span><span class="o">=</span><span class="n">comp_stations</span><span class="p">,</span>
                <span class="n">displacement</span><span class="o">=</span><span class="n">vs</span><span class="p">,</span>
                <span class="n">covariance</span><span class="o">=</span><span class="n">Covariance</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="n">variances</span><span class="p">),</span>
                <span class="n">lats</span><span class="o">=</span><span class="n">lats</span><span class="p">,</span>
                <span class="n">lons</span><span class="o">=</span><span class="n">lons</span><span class="p">,</span>
                <span class="n">east_shifts</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lats</span><span class="p">),</span>
                <span class="n">north_shifts</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lats</span><span class="p">),</span>
                <span class="n">component</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span>
                <span class="n">odw</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">compounds</span></div>


<div class="viewcode-block" id="ResultReport"><a class="viewcode-back" href="../api.html#heart.ResultReport">[docs]</a><span class="k">class</span> <span class="nc">ResultReport</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>

    <span class="n">solution_point</span> <span class="o">=</span> <span class="n">Dict</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s1">&#39;result point&#39;</span><span class="p">)</span>
    <span class="n">post_llk</span> <span class="o">=</span> <span class="n">StringChoice</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">],</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Value of point of the likelihood distribution.&#39;</span><span class="p">)</span>
    <span class="n">mean_point</span> <span class="o">=</span> <span class="n">Dict</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;mean of distributions, used for model&#39;</span>
             <span class="s1">&#39; prediction covariance calculation.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="IFG"><a class="viewcode-back" href="../api.html#heart.IFG">[docs]</a><span class="k">class</span> <span class="nc">IFG</span><span class="p">(</span><span class="n">GeodeticDataset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interferogram class as a dataset in the optimization.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">master</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Acquisition time of master image YYYY-MM-DD&#39;</span><span class="p">)</span>
    <span class="n">slave</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Acquisition time of slave image YYYY-MM-DD&#39;</span><span class="p">)</span>
    <span class="n">amplitude</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">wrapped_phase</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">incidence</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">heading</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">los_vector</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">satellite</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;Envisat&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;IFG</span><span class="se">\n</span><span class="s1"> Acquisition Track: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  timerange: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slave</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;  number of pixels: </span><span class="si">%i</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">wavelength</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lambda_sensors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">satellite</span><span class="p">]</span>

<div class="viewcode-block" id="IFG.update_los_vector"><a class="viewcode-back" href="../api.html#heart.IFG.update_los_vector">[docs]</a>    <span class="k">def</span> <span class="nf">update_los_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate LOS vector for given attributes incidence and heading angles.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`numpy.ndarray` (n_points, 3)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">incidence</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                    <span class="s1">&#39;Incidence and Heading need to be provided!&#39;</span><span class="p">)</span>

            <span class="n">Su</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incidence</span><span class="p">))</span>
            <span class="n">Sn</span> <span class="o">=</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incidence</span><span class="p">))</span> <span class="o">*</span> \
                <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">-</span> <span class="mi">270</span><span class="p">))</span>
            <span class="n">Se</span> <span class="o">=</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incidence</span><span class="p">))</span> <span class="o">*</span> \
                <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">-</span> <span class="mi">270</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Sn</span><span class="p">,</span> <span class="n">Se</span><span class="p">,</span> <span class="n">Su</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;There are Nan values in LOS vector for dataset: </span><span class="si">%s</span><span class="s1">! &#39;</span>
                    <span class="s1">&#39;Please check source of imported data!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">los_vector</span></div></div>


<div class="viewcode-block" id="DiffIFG"><a class="viewcode-back" href="../api.html#heart.DiffIFG">[docs]</a><span class="k">class</span> <span class="nc">DiffIFG</span><span class="p">(</span><span class="n">IFG</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential Interferogram class as geodetic target for the calculation</span>
<span class="sd">    of synthetics and container for SAR data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">unwrapped_phase</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">coherence</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">reference_point</span> <span class="o">=</span> <span class="n">Tuple</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(),</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">reference_value</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">displacement</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">covariance</span> <span class="o">=</span> <span class="n">Covariance</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;:py:class:`Covariance` that holds data&#39;</span>
             <span class="s1">&#39;and model prediction covariance matrixes&#39;</span><span class="p">)</span>
    <span class="n">odw</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Overlapping data weights, additional weight factor to the&#39;</span>
             <span class="s1">&#39;dataset for overlaps with other datasets&#39;</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">bool</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Mask values for Euler pole region determination. &#39;</span>
             <span class="s1">&#39;Click polygon mask in kite!&#39;</span><span class="p">,</span>
        <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">export_to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exporting dataset as csv to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">displacement</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">displacement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="s1">&#39;lat[deg], lon[deg], incidence[deg], heading[deg], &#39;</span>
                <span class="s1">&#39;displacement[m]</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">inci</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">dis</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">incidence</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">heading</span><span class="p">,</span> <span class="n">displacement</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">inci</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">dis</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_kite_scene</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">scene</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Attempting to access the full covariance matrix of the kite&#39;</span>
            <span class="s1">&#39; scene </span><span class="si">%s</span><span class="s1">. If this is not precalculated it will be calculated &#39;</span>
            <span class="s1">&#39;now, which may take a significant amount of time...&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">covariance</span> <span class="o">=</span> <span class="n">Covariance</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">scene</span><span class="o">.</span><span class="n">covariance</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">isDegree</span><span class="p">():</span>
            <span class="n">lats</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">nleaves</span><span class="p">)</span>
            <span class="n">lons</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">nleaves</span><span class="p">)</span>
            <span class="n">lats</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">llLat</span><span class="p">)</span>
            <span class="n">lons</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">llLon</span><span class="p">)</span>
            <span class="n">lons</span> <span class="o">+=</span> <span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">leaf_eastings</span>
            <span class="n">lats</span> <span class="o">+=</span> <span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">leaf_northings</span>
        <span class="k">elif</span> <span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">isMeter</span><span class="p">():</span>
            <span class="n">loce</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">leaf_eastings</span>
            <span class="n">locn</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">leaf_northings</span>
            <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span> <span class="o">=</span> <span class="n">orthodrome</span><span class="o">.</span><span class="n">ne_to_latlon</span><span class="p">(</span>
                <span class="n">lat0</span><span class="o">=</span><span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">llLat</span><span class="p">,</span> <span class="n">lon0</span><span class="o">=</span><span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">llLon</span><span class="p">,</span>
                <span class="n">north_m</span><span class="o">=</span><span class="n">locn</span><span class="p">,</span> <span class="n">east_m</span><span class="o">=</span><span class="n">loce</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="s1">&#39;polygon_mask&#39;</span><span class="p">):</span>
            <span class="n">polygons</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">polygon_mask</span><span class="o">.</span><span class="n">polygons</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">polygons</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">lats</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">polygons</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found polygon mask in </span><span class="si">%s</span><span class="s1">! Importing for Euler Pole&#39;</span>
                        <span class="s1">&#39; correction ...&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">matplotlib.path</span> <span class="k">import</span> <span class="n">Path</span>

            <span class="n">leaf_idxs_rows</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">leaf_northings</span> <span class="o">/</span> <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">dN</span>
            <span class="n">leaf_idxs_cols</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">leaf_eastings</span> <span class="o">/</span> <span class="n">scene</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">dE</span>

            <span class="n">points</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">leaf_idxs_cols</span><span class="p">,</span> <span class="n">leaf_idxs_rows</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">for</span> <span class="n">vertices</span> <span class="ow">in</span> <span class="n">polygons</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>    <span class="c1"># vertexes [cols, rows]</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">|=</span> <span class="n">p</span><span class="o">.</span><span class="n">contains_points</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No polygon mask in </span><span class="si">%s</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">displacement</span><span class="o">=</span><span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">leaf_means</span><span class="p">,</span>
            <span class="n">lons</span><span class="o">=</span><span class="n">lons</span><span class="p">,</span>
            <span class="n">lats</span><span class="o">=</span><span class="n">lats</span><span class="p">,</span>
            <span class="n">covariance</span><span class="o">=</span><span class="n">covariance</span><span class="p">,</span>
            <span class="n">incidence</span><span class="o">=</span><span class="mi">90</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">leaf_thetas</span><span class="p">),</span>
            <span class="n">heading</span><span class="o">=-</span><span class="n">num</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">leaf_phis</span><span class="p">)</span> <span class="o">+</span> <span class="mi">180</span><span class="p">,</span>
            <span class="n">odw</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">quadtree</span><span class="o">.</span><span class="n">leaf_phis</span><span class="p">),</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>

<div class="viewcode-block" id="DiffIFG.get_blacklist"><a class="viewcode-back" href="../api.html#heart.DiffIFG.get_blacklist">[docs]</a>    <span class="k">def</span> <span class="nf">get_blacklist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corr_conf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts mask from kite scene and returns blacklist indexes-</span>
<span class="sd">        maybe during import?!!!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">corr_conf</span><span class="o">.</span><span class="n">feature</span> <span class="o">==</span> <span class="s1">&#39;Euler Pole&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Masking data for Euler Pole estimation!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="GeodeticResult"><a class="viewcode-back" href="../api.html#heart.GeodeticResult">[docs]</a><span class="k">class</span> <span class="nc">GeodeticResult</span><span class="p">(</span><span class="n">Object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Result object assembling different geodetic data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">ResultPoint</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">ResultPoint</span><span class="o">.</span><span class="n">D</span><span class="p">())</span>
    <span class="n">processed_obs</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">processed_syn</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">processed_res</span> <span class="o">=</span> <span class="n">Array</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">llk</span> <span class="o">=</span> <span class="n">Float</span><span class="o">.</span><span class="n">T</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="init_seismic_targets"><a class="viewcode-back" href="../api.html#heart.init_seismic_targets">[docs]</a><span class="k">def</span> <span class="nf">init_seismic_targets</span><span class="p">(</span>
        <span class="n">stations</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="o">=</span><span class="s1">&#39;ak135-f-average.m&#39;</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">],</span>
        <span class="n">sample_rate</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">crust_inds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;multilinear&#39;</span><span class="p">,</span>
        <span class="n">reference_location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initiate a list of target objects given a list of indexes to the</span>
<span class="sd">    respective GF store velocity model variation index (crust_inds).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stations : List of :class:`pyrocko.model.Station`</span>
<span class="sd">        List of station objects for which the targets are being initialised</span>
<span class="sd">    earth_model_name = str</span>
<span class="sd">        Name of the earth model that has been used for GF calculation.</span>
<span class="sd">    channels : List of str</span>
<span class="sd">        Components of the traces to be optimized for if rotated:</span>
<span class="sd">        T - transversal, Z - vertical, R - radial</span>
<span class="sd">        If not rotated:</span>
<span class="sd">        E - East, N- North, U - Up (Vertical)</span>
<span class="sd">    sample_rate : scalar, float</span>
<span class="sd">        sample rate [Hz] of the Greens Functions to use</span>
<span class="sd">    crust_inds : List of int</span>
<span class="sd">        Indexes of different velocity model realisations, 0 - reference model</span>
<span class="sd">    interpolation : str</span>
<span class="sd">        Method of interpolation for the Greens Functions, can be &#39;multilinear&#39;</span>
<span class="sd">        or &#39;nearest_neighbor&#39;</span>
<span class="sd">    reference_location : :class:`ReferenceLocation` or</span>
<span class="sd">        :class:`pyrocko.model.Station`</span>
<span class="sd">        if given, targets are initialised with this reference location</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List of :class:`DynamicTarget`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">reference_location</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">store_prefixes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">station</span><span class="p">)</span> <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">store_prefixes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">reference_location</span><span class="o">.</span><span class="n">station</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">]</span>

    <span class="n">em_name</span> <span class="o">=</span> <span class="n">get_earth_model_prefix</span><span class="p">(</span><span class="n">earth_model_name</span><span class="p">)</span>

    <span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sta_num</span><span class="p">,</span> <span class="n">station</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stations</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">crust_ind</span> <span class="ow">in</span> <span class="n">crust_inds</span><span class="p">:</span>
                <span class="n">cha</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;Channel &quot;</span><span class="si">%s</span><span class="s1">&quot; for station &quot;</span><span class="si">%s</span><span class="s1">&quot; does not exist!&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">station</span><span class="o">.</span><span class="n">station</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DynamicTarget</span><span class="p">(</span>
                        <span class="n">quantity</span><span class="o">=</span><span class="s1">&#39;displacement&#39;</span><span class="p">,</span>
                        <span class="n">codes</span><span class="o">=</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">network</span><span class="p">,</span>
                               <span class="n">station</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
                               <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">crust_ind</span><span class="p">,</span> <span class="n">channel</span><span class="p">),</span>  <span class="c1"># n, s, l, c</span>
                        <span class="n">lat</span><span class="o">=</span><span class="n">station</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
                        <span class="n">lon</span><span class="o">=</span><span class="n">station</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
                        <span class="n">azimuth</span><span class="o">=</span><span class="n">cha</span><span class="o">.</span><span class="n">azimuth</span><span class="p">,</span>
                        <span class="n">dip</span><span class="o">=</span><span class="n">cha</span><span class="o">.</span><span class="n">dip</span><span class="p">,</span>
                        <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
                        <span class="n">store_id</span><span class="o">=</span><span class="n">get_store_id</span><span class="p">(</span>
                            <span class="n">store_prefixes</span><span class="p">[</span><span class="n">sta_num</span><span class="p">],</span>
                            <span class="n">em_name</span><span class="p">,</span>
                            <span class="n">sample_rate</span><span class="p">,</span>
                            <span class="n">crust_ind</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">targets</span></div>


<span class="k">def</span> <span class="nf">get_store_id</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%.3f</span><span class="s1">Hz_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">crust_ind</span><span class="p">)</span>


<div class="viewcode-block" id="init_geodetic_targets"><a class="viewcode-back" href="../api.html#heart.init_geodetic_targets">[docs]</a><span class="k">def</span> <span class="nf">init_geodetic_targets</span><span class="p">(</span>
        <span class="n">datasets</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="o">=</span><span class="s1">&#39;ak135-f-average.m&#39;</span><span class="p">,</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest_neighbor&#39;</span><span class="p">,</span> <span class="n">crust_inds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">sample_rate</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initiate a list of Static target objects given a list of indexes to the</span>
<span class="sd">    respective GF store velocity model variation index (crust_inds).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datasets : list</span>
<span class="sd">        of :class:`heart.GeodeticDataset` for which the targets are being</span>
<span class="sd">        initialised</span>
<span class="sd">    earth_model_name = str</span>
<span class="sd">        Name of the earth model that has been used for GF calculation.</span>
<span class="sd">    sample_rate : scalar, float</span>
<span class="sd">        sample rate [Hz] of the Greens Functions to use</span>
<span class="sd">    crust_inds : List of int</span>
<span class="sd">        Indexes of different velocity model realisations, 0 - reference model</span>
<span class="sd">    interpolation : str</span>
<span class="sd">        Method of interpolation for the Greens Functions, can be &#39;multilinear&#39;</span>
<span class="sd">        or &#39;nearest_neighbor&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List of :class:`pyrocko.gf.targets.StaticTarget`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">em_name</span> <span class="o">=</span> <span class="n">get_earth_model_prefix</span><span class="p">(</span><span class="n">earth_model_name</span><span class="p">)</span>

    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">gf</span><span class="o">.</span><span class="n">StaticTarget</span><span class="p">(</span>
        <span class="n">lons</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">lons</span><span class="p">,</span>
        <span class="n">lats</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">lats</span><span class="p">,</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
        <span class="n">quantity</span><span class="o">=</span><span class="s1">&#39;displacement&#39;</span><span class="p">,</span>
        <span class="n">store_id</span><span class="o">=</span><span class="n">get_store_id</span><span class="p">(</span><span class="s1">&#39;statics&#39;</span><span class="p">,</span> <span class="n">em_name</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">crust_ind</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">crust_ind</span> <span class="ow">in</span> <span class="n">crust_inds</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">targets</span></div>


<div class="viewcode-block" id="vary_model"><a class="viewcode-back" href="../api.html#heart.vary_model">[docs]</a><span class="k">def</span> <span class="nf">vary_model</span><span class="p">(</span>
        <span class="n">earthmod</span><span class="p">,</span> <span class="n">error_depth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">error_velocities</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">depth_limit_variation</span><span class="o">=</span><span class="mi">600</span> <span class="o">*</span> <span class="n">km</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vary depths and velocities in the given source model by Gaussians with</span>
<span class="sd">    given 2-sigma errors [percent]. Ensures increasing velocity with depth.</span>
<span class="sd">    Stops variating the input model at the given depth_limit_variation [m].</span>
<span class="sd">    Mantle discontinuity uncertainties are hardcoded based on</span>
<span class="sd">    Mooney et al. 1981 and Woodward et al.1991</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    earthmod : :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">        Earthmodel defining layers, depth, velocities, densities</span>
<span class="sd">    error_depth : scalar, float</span>
<span class="sd">        2 sigma error in percent of the depth for the respective layers</span>
<span class="sd">    error_velocities : scalar, float</span>
<span class="sd">        2 sigma error in percent of the velocities for the respective layers</span>
<span class="sd">    depth_limit_variations : scalar, float</span>
<span class="sd">        depth threshold [m], layers with depth &gt; than this are not varied</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Varied Earthmodel : :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">    Cost : int</span>
<span class="sd">        Counts repetitions of cycles to ensure increasing layer velocity,</span>
<span class="sd">        unlikely velocities have high Cost</span>
<span class="sd">        Cost of up to 20 are ok for crustal profiles.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">new_earthmod</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">earthmod</span><span class="p">)</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="n">new_earthmod</span><span class="o">.</span><span class="n">layers</span><span class="p">()</span>

    <span class="n">last_l</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">deltaz</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># uncertainties in discontinuity depth after Shearer 1991</span>
    <span class="n">discont_unc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;410&#39;</span><span class="p">:</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="s1">&#39;520&#39;</span><span class="p">:</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="s1">&#39;660&#39;</span><span class="p">:</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">km</span><span class="p">}</span>

    <span class="c1"># uncertainties in velocity for upper and lower mantle from Woodward 1991</span>
    <span class="c1"># and Mooney 1989</span>
    <span class="n">mantle_vel_unc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;100&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>     <span class="c1"># above 100</span>
        <span class="s1">&#39;200&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">,</span>     <span class="c1"># above 200</span>
        <span class="s1">&#39;400&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}</span>     <span class="c1"># above 400</span>

    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
        <span class="c1"># stop if depth_limit_variation is reached</span>
        <span class="k">if</span> <span class="n">depth_limit_variation</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span> <span class="o">&gt;=</span> <span class="n">depth_limit_variation</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span> <span class="o">=</span> <span class="n">last_l</span><span class="o">.</span><span class="n">zbot</span>
                <span class="c1"># assign large cost if previous layer has higher velocity</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">&lt;</span> <span class="n">last_l</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="ow">or</span> \
                   <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">&gt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">:</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1000</span>
                <span class="c1"># assign large cost if layer bottom depth smaller than top</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">&lt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span><span class="p">:</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="mi">1000</span>
                <span class="k">break</span>
        <span class="n">repeat</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">repeat</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># vary layer velocity</span>
            <span class="c1"># check for layer depth and use hardcoded uncertainties</span>
            <span class="k">for</span> <span class="n">l_depth</span><span class="p">,</span> <span class="n">vel_unc</span> <span class="ow">in</span> <span class="n">mantle_vel_unc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">l_depth</span><span class="p">)</span> <span class="o">*</span> <span class="n">km</span> <span class="o">&lt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span><span class="p">:</span>
                    <span class="n">error_velocities</span> <span class="o">=</span> <span class="n">vel_unc</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Velocity error: </span><span class="si">%f</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">error_velocities</span><span class="p">)</span>

            <span class="n">deltavp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">*</span> <span class="n">error_velocities</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">+=</span> <span class="n">deltavp</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">deltavp</span> <span class="o">/</span> <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp_vs_ratio</span><span class="p">())</span>

            <span class="c1"># ensure increasing velocity with depth</span>
            <span class="k">if</span> <span class="n">last_l</span><span class="p">:</span>
                <span class="c1"># gradient layer without interface</span>
                <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">==</span> <span class="n">last_l</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span> <span class="o">+</span> <span class="n">deltavp</span> <span class="o">&lt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span><span class="p">:</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span> <span class="o">+=</span> <span class="n">deltavp</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="n">deltavp</span> <span class="o">/</span> <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp_vs_ratio</span><span class="p">())</span>
                        <span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">cost</span> <span class="o">+=</span> <span class="n">count</span>
                <span class="k">elif</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">+</span> <span class="n">deltavp</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">&lt;</span> <span class="n">last_l</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp</span> <span class="o">+=</span> <span class="n">deltavp</span>
                    <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">deltavp</span> <span class="o">/</span> <span class="n">layer</span><span class="o">.</span><span class="n">mtop</span><span class="o">.</span><span class="n">vp_vs_ratio</span><span class="p">())</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">GradientLayer</span><span class="p">):</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp</span> <span class="o">+=</span> <span class="n">deltavp</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vs</span> <span class="o">+=</span> <span class="p">(</span><span class="n">deltavp</span> <span class="o">/</span> <span class="n">layer</span><span class="o">.</span><span class="n">mbot</span><span class="o">.</span><span class="n">vp_vs_ratio</span><span class="p">())</span>
                    <span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">cost</span> <span class="o">+=</span> <span class="n">count</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># vary layer depth</span>
        <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span> <span class="o">+=</span> <span class="n">deltaz</span>
        <span class="n">repeat</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># use hard coded uncertainties for mantle discontinuities</span>
        <span class="k">if</span> <span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">/</span> <span class="n">km</span><span class="p">)</span> <span class="ow">in</span> <span class="n">discont_unc</span><span class="p">:</span>
            <span class="n">factor_d</span> <span class="o">=</span> <span class="n">discont_unc</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">/</span> <span class="n">km</span><span class="p">)]</span> <span class="o">/</span> <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">factor_d</span> <span class="o">=</span> <span class="n">error_depth</span>

        <span class="k">while</span> <span class="n">repeat</span><span class="p">:</span>
            <span class="c1"># ensure that bottom of layer is not shallower than the top</span>
            <span class="n">deltaz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">num</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span> <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">*</span> <span class="n">factor_d</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># 3 sigma</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">+=</span> <span class="n">deltaz</span>
            <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">&lt;</span> <span class="n">layer</span><span class="o">.</span><span class="n">ztop</span><span class="p">:</span>
                <span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">-=</span> <span class="n">deltaz</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">cost</span> <span class="o">+=</span> <span class="n">count</span>

        <span class="n">last_l</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_earthmod</span><span class="p">,</span> <span class="n">cost</span></div>


<div class="viewcode-block" id="ensemble_earthmodel"><a class="viewcode-back" href="../api.html#heart.ensemble_earthmodel">[docs]</a><span class="k">def</span> <span class="nf">ensemble_earthmodel</span><span class="p">(</span><span class="n">ref_earthmod</span><span class="p">,</span> <span class="n">num_vary</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">error_depth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                        <span class="n">error_velocities</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">depth_limit_variation</span><span class="o">=</span><span class="mi">600</span> <span class="o">*</span> <span class="n">km</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create ensemble of earthmodels that vary around a given input earth model</span>
<span class="sd">    by a Gaussian of 2 sigma (in Percent 0.1 = 10%) for the depth layers</span>
<span class="sd">    and for the p and s wave velocities. Vp / Vs is kept unchanged</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ref_earthmod : :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">        Reference earthmodel defining layers, depth, velocities, densities</span>
<span class="sd">    num_vary : scalar, int</span>
<span class="sd">        Number of variation realisations</span>
<span class="sd">    error_depth : scalar, float</span>
<span class="sd">        3 sigma error in percent of the depth for the respective layers</span>
<span class="sd">    error_velocities : scalar, float</span>
<span class="sd">        3 sigma error in percent of the velocities for the respective layers</span>
<span class="sd">    depth_limit_variation : scalar, float</span>
<span class="sd">        depth threshold [m], layers with depth &gt; than this are not varied</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    List of Varied Earthmodels :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">earthmods</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_vary</span><span class="p">:</span>
        <span class="n">new_model</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">vary_model</span><span class="p">(</span>
            <span class="n">ref_earthmod</span><span class="p">,</span>
            <span class="n">error_depth</span><span class="p">,</span>
            <span class="n">error_velocities</span><span class="p">,</span>
            <span class="n">depth_limit_variation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cost</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Skipped unlikely model </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cost</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">earthmods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_model</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">earthmods</span></div>


<div class="viewcode-block" id="get_velocity_model"><a class="viewcode-back" href="../api.html#heart.get_velocity_model">[docs]</a><span class="k">def</span> <span class="nf">get_velocity_model</span><span class="p">(</span>
        <span class="n">location</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">gf_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">custom_velocity_model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get velocity model at the specified location, combines given or crustal</span>
<span class="sd">    models with the global model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    location : :class:`pyrocko.meta.Location`</span>
<span class="sd">    earth_model_name : str</span>
<span class="sd">        Name of the base earth model to be used, check</span>
<span class="sd">        :func:`pyrocko.cake.builtin_models` for alternatives,</span>
<span class="sd">        default ak135 with medium resolution</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        Index to set to the Greens Function store, 0 is reference store</span>
<span class="sd">        indexes &gt; 0 use reference model and vary its parameters by a Gaussian</span>
<span class="sd">    gf_config : :class:`beat.config.GFConfig`</span>
<span class="sd">    custom_velocity_model : :class:`pyrocko.cake.LayeredModel`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gfc</span> <span class="o">=</span> <span class="n">gf_config</span>
    <span class="n">avail_models</span> <span class="o">=</span> <span class="n">cake</span><span class="o">.</span><span class="n">builtin_models</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">earth_model_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">avail_models</span> <span class="ow">and</span> <span class="n">earth_model_name</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Earthmodel name &quot;</span><span class="si">%s</span><span class="s1">&quot; not available!&#39;</span>
            <span class="s1">&#39; Implemented models: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">earth_model_name</span><span class="p">,</span> <span class="n">utility</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">avail_models</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">custom_velocity_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using custom model from config file&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">earth_model_name</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Using only custom velocity model, not pasting into &#39;</span>
                <span class="s1">&#39;global background model.&#39;</span><span class="p">)</span>
            <span class="n">source_model</span> <span class="o">=</span> <span class="n">custom_velocity_model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">global_model</span> <span class="o">=</span> <span class="n">cake</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">earth_model_name</span><span class="p">)</span>
            <span class="n">source_model</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">join_models</span><span class="p">(</span>
                <span class="n">global_model</span><span class="p">,</span> <span class="n">custom_velocity_model</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">gfc</span><span class="o">.</span><span class="n">use_crust2</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using crust2 profile&#39;</span><span class="p">)</span>
        <span class="c1"># load velocity profile from CRUST2x2 and check for water layer</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">crust2x2</span><span class="o">.</span><span class="n">get_profile</span><span class="p">(</span><span class="n">location</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">location</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">gfc</span><span class="o">.</span><span class="n">replace_water</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Replacing water layers! ...&#39;</span><span class="p">)</span>
            <span class="n">thickness_lwater</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LWATER</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">thickness_lwater</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Water layer </span><span class="si">%f</span><span class="s1"> in CRUST model!&#39;</span>
                    <span class="s1">&#39; Remove and add to lower crust&#39;</span> <span class="o">%</span> <span class="n">thickness_lwater</span><span class="p">)</span>
                <span class="n">thickness_llowercrust</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span>
                    <span class="n">crust2x2</span><span class="o">.</span><span class="n">LLOWERCRUST</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">thickness_lsoftsed</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span>
                    <span class="n">crust2x2</span><span class="o">.</span><span class="n">LSOFTSED</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">profile</span><span class="o">.</span><span class="n">set_layer_thickness</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LWATER</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">profile</span><span class="o">.</span><span class="n">set_layer_thickness</span><span class="p">(</span>
                    <span class="n">crust2x2</span><span class="o">.</span><span class="n">LSOFTSED</span><span class="p">,</span>
                    <span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">thickness_lsoftsed</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">profile</span><span class="o">.</span><span class="n">set_layer_thickness</span><span class="p">(</span>
                    <span class="n">crust2x2</span><span class="o">.</span><span class="n">LLOWERCRUST</span><span class="p">,</span>
                    <span class="n">thickness_llowercrust</span> <span class="o">+</span>
                    <span class="n">thickness_lwater</span> <span class="o">+</span>
                    <span class="p">(</span><span class="n">thickness_lsoftsed</span> <span class="o">-</span> <span class="n">num</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">thickness_lsoftsed</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)))</span>

                <span class="n">profile</span><span class="o">.</span><span class="n">_elevation</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;New Lower crust layer thickness </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="n">profile</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">crust2x2</span><span class="o">.</span><span class="n">LLOWERCRUST</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not replacing water layers&#39;</span><span class="p">)</span>

        <span class="n">source_model</span> <span class="o">=</span> <span class="n">cake</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span>
            <span class="n">earth_model_name</span><span class="p">,</span> <span class="n">crust2_profile</span><span class="o">=</span><span class="n">profile</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using global model ...&#39;</span><span class="p">)</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">cake</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="n">earth_model_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">crust_ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">ensemble_earthmodel</span><span class="p">(</span>
            <span class="n">source_model</span><span class="p">,</span>
            <span class="n">num_vary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">error_depth</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">error_depth</span><span class="p">,</span>
            <span class="n">error_velocities</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">error_velocities</span><span class="p">,</span>
            <span class="n">depth_limit_variation</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">depth_limit_variation</span> <span class="o">*</span> <span class="n">km</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">source_model</span></div>


<div class="viewcode-block" id="get_slowness_taper"><a class="viewcode-back" href="../api.html#heart.get_slowness_taper">[docs]</a><span class="k">def</span> <span class="nf">get_slowness_taper</span><span class="p">(</span><span class="n">fomosto_config</span><span class="p">,</span> <span class="n">velocity_model</span><span class="p">,</span> <span class="n">distances</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate slowness taper for backends that determine wavefield based</span>
<span class="sd">    on the velociy model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fomosto_config : :class:`pyrocko.meta.Config`</span>
<span class="sd">    velocity_model : :class:`pyrocko.cake.LayeredModel`</span>
<span class="sd">    distances : tuple</span>
<span class="sd">        minimum and maximum distance [deg]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple of slownesses</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fc</span> <span class="o">=</span> <span class="n">fomosto_config</span>

    <span class="n">phases</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase</span><span class="o">.</span><span class="n">phases</span> <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">fc</span><span class="o">.</span><span class="n">tabulated_phases</span><span class="p">]</span>

    <span class="n">all_phases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
        <span class="n">all_phases</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>

    <span class="n">mean_source_depth</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
        <span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">source_depth_min</span><span class="p">,</span> <span class="n">fc</span><span class="o">.</span><span class="n">source_depth_max</span><span class="p">))</span> <span class="o">/</span> <span class="n">km</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">distances</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">distances</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>

    <span class="n">arrivals</span> <span class="o">=</span> <span class="n">velocity_model</span><span class="o">.</span><span class="n">arrivals</span><span class="p">(</span>
        <span class="n">phases</span><span class="o">=</span><span class="n">all_phases</span><span class="p">,</span>
        <span class="n">distances</span><span class="o">=</span><span class="n">dists</span><span class="p">,</span>
        <span class="n">zstart</span><span class="o">=</span><span class="n">mean_source_depth</span><span class="p">)</span>

    <span class="n">ps</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">arrivals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">p</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arrivals</span><span class="p">))])</span>

    <span class="n">slownesses</span> <span class="o">=</span> <span class="n">ps</span> <span class="o">/</span> <span class="p">(</span><span class="n">cake</span><span class="o">.</span><span class="n">r2d</span> <span class="o">*</span> <span class="n">cake</span><span class="o">.</span><span class="n">d2m</span> <span class="o">/</span> <span class="n">km</span><span class="p">)</span>
    <span class="n">smax</span> <span class="o">=</span> <span class="n">slownesses</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">smax</span><span class="p">),</span> <span class="mf">1.3</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">smax</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">get_earth_model_prefix</span><span class="p">(</span><span class="n">earth_model_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">earth_model_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


<div class="viewcode-block" id="get_fomosto_baseconfig"><a class="viewcode-back" href="../api.html#heart.get_fomosto_baseconfig">[docs]</a><span class="k">def</span> <span class="nf">get_fomosto_baseconfig</span><span class="p">(</span>
        <span class="n">gfconfig</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">waveforms</span><span class="p">,</span> <span class="n">crust_ind</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialise fomosto config.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gfconfig : :class:`config.NonlinearGFConfig`</span>
<span class="sd">    event : :class:`pyrocko.model.Event`</span>
<span class="sd">        The event is used as a reference point for all the calculations</span>
<span class="sd">        According to the its location the earth model is being built</span>
<span class="sd">    station : :class:`pyrocko.model.Station` or</span>
<span class="sd">        :class:`heart.ReferenceLocation`</span>
<span class="sd">    waveforms : List of str</span>
<span class="sd">        Waveforms to calculate GFs for, determines the length of traces</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        Index to set to the Greens Function store</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sf</span> <span class="o">=</span> <span class="n">gfconfig</span>

    <span class="k">if</span> <span class="n">gfconfig</span><span class="o">.</span><span class="n">code</span> <span class="o">!=</span> <span class="s1">&#39;psgrn&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">waveforms</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;No waveforms specified! No GFs to be calculated!&#39;</span><span class="p">)</span>

    <span class="c1"># calculate event-station distance [m]</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">orthodrome</span><span class="o">.</span><span class="n">distance_accurate50m</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">station</span><span class="p">)</span>
    <span class="n">distance_min</span> <span class="o">=</span> <span class="n">distance</span> <span class="o">-</span> <span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">source_distance_radius</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">distance_min</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s1">&#39;Minimum grid distance is below zero. Setting it to zero!&#39;</span><span class="p">)</span>
        <span class="n">distance_min</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># define phases</span>
    <span class="n">tabulated_phases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s1">&#39;any_P&#39;</span> <span class="ow">in</span> <span class="n">waveforms</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">earth_model_name</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">definition</span> <span class="o">=</span> <span class="s1">&#39;p,P,p</span><span class="se">\\</span><span class="s1">,P</span><span class="se">\\</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">definition</span> <span class="o">=</span> <span class="s1">&#39;p,P,p</span><span class="se">\\</span><span class="s1">,P</span><span class="se">\\</span><span class="s1">,Pv_(cmb)p&#39;</span>

        <span class="n">tabulated_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">TPDef</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;any_P&#39;</span><span class="p">,</span>
            <span class="n">definition</span><span class="o">=</span><span class="n">definition</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;any_S&#39;</span> <span class="ow">in</span> <span class="n">waveforms</span><span class="p">:</span>
        <span class="n">tabulated_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">TPDef</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;any_S&#39;</span><span class="p">,</span>
            <span class="n">definition</span><span class="o">=</span><span class="s1">&#39;s,S,s</span><span class="se">\\</span><span class="s1">,S</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">))</span>

    <span class="c1"># surface waves</span>
    <span class="k">if</span> <span class="s1">&#39;slowest&#39;</span> <span class="ow">in</span> <span class="n">waveforms</span><span class="p">:</span>
        <span class="n">tabulated_phases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gf</span><span class="o">.</span><span class="n">TPDef</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;slowest&#39;</span><span class="p">,</span>
            <span class="n">definition</span><span class="o">=</span><span class="s1">&#39;0.8&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">gf</span><span class="o">.</span><span class="n">ConfigTypeA</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%.3f</span><span class="s1">Hz_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">station</span><span class="o">.</span><span class="n">station</span><span class="p">,</span>
            <span class="n">get_earth_model_prefix</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">earth_model_name</span><span class="p">),</span>
            <span class="n">sf</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">,</span>
            <span class="n">crust_ind</span><span class="p">),</span>
        <span class="n">ncomponents</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">,</span>
        <span class="n">receiver_depth</span><span class="o">=</span><span class="mf">0.</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">source_depth_min</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">source_depth_min</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">source_depth_max</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">source_depth_max</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">source_depth_delta</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">source_depth_spacing</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">distance_min</span><span class="o">=</span><span class="n">distance_min</span><span class="p">,</span>
        <span class="n">distance_max</span><span class="o">=</span><span class="n">distance</span> <span class="o">+</span> <span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">source_distance_radius</span> <span class="o">*</span> <span class="n">km</span><span class="p">),</span>
        <span class="n">distance_delta</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">source_distance_spacing</span> <span class="o">*</span> <span class="n">km</span><span class="p">,</span>
        <span class="n">tabulated_phases</span><span class="o">=</span><span class="n">tabulated_phases</span><span class="p">)</span></div>


<span class="n">backend_builders</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;qseis&#39;</span><span class="p">:</span> <span class="n">qseis</span><span class="o">.</span><span class="n">build</span><span class="p">,</span>
    <span class="s1">&#39;qssp&#39;</span><span class="p">:</span> <span class="n">qssp</span><span class="o">.</span><span class="n">build</span><span class="p">,</span>
    <span class="s1">&#39;qseis2d&#39;</span><span class="p">:</span> <span class="n">qseis2d</span><span class="o">.</span><span class="n">build</span><span class="p">}</span>


<div class="viewcode-block" id="choose_backend"><a class="viewcode-back" href="../api.html#heart.choose_backend">[docs]</a><span class="k">def</span> <span class="nf">choose_backend</span><span class="p">(</span>
        <span class="n">fomosto_config</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">source_model</span><span class="p">,</span> <span class="n">receiver_model</span><span class="p">,</span>
        <span class="n">gf_directory</span><span class="o">=</span><span class="s1">&#39;qseis2d_green&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get backend related config.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fc</span> <span class="o">=</span> <span class="n">fomosto_config</span>
    <span class="n">receiver_basement_depth</span> <span class="o">=</span> <span class="mi">150</span> <span class="o">*</span> <span class="n">km</span>

    <span class="n">distances</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fc</span><span class="o">.</span><span class="n">distance_min</span><span class="p">,</span> <span class="n">fc</span><span class="o">.</span><span class="n">distance_max</span><span class="p">])</span> <span class="o">*</span> <span class="n">cake</span><span class="o">.</span><span class="n">m2d</span>
    <span class="n">slowness_taper</span> <span class="o">=</span> <span class="n">get_slowness_taper</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">source_model</span><span class="p">,</span> <span class="n">distances</span><span class="p">)</span>

    <span class="n">waveforms</span> <span class="o">=</span> <span class="p">[</span><span class="n">phase</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">fc</span><span class="o">.</span><span class="n">tabulated_phases</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;slowest&#39;</span> <span class="ow">in</span> <span class="n">waveforms</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">!=</span> <span class="s1">&#39;qseis&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s1">&#39;For near-field phases the &quot;qseis&quot; backend has to be used!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;qseis&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;2006a&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;slowest&#39;</span> <span class="ow">in</span> <span class="n">waveforms</span> <span class="ow">or</span> <span class="n">distances</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Receiver and source&#39;</span>
                <span class="s1">&#39; site structures have to be identical as distance&#39;</span>
                <span class="s1">&#39; and ray depth not high enough for common receiver&#39;</span>
                <span class="s1">&#39; depth!&#39;</span><span class="p">)</span>
            <span class="n">receiver_model</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">slowness_taper</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="n">sw_algorithm</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sw_flat_earth_transform</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># find common basement layer</span>
            <span class="n">common_basement</span> <span class="o">=</span> <span class="n">source_model</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">receiver_basement_depth</span><span class="p">)</span>
            <span class="n">receiver_model</span> <span class="o">=</span> <span class="n">receiver_model</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
                <span class="n">depth_max</span><span class="o">=</span><span class="n">common_basement</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span>
            <span class="n">receiver_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">common_basement</span><span class="p">)</span>
            <span class="n">sw_algorithm</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">sw_flat_earth_transform</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">conf</span> <span class="o">=</span> <span class="n">qseis</span><span class="o">.</span><span class="n">QSeisConfig</span><span class="p">(</span>
            <span class="n">filter_shallow_paths</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">slowness_window</span><span class="o">=</span><span class="n">slowness_taper</span><span class="p">,</span>
            <span class="n">wavelet_duration_samples</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="n">sw_flat_earth_transform</span><span class="o">=</span><span class="n">sw_flat_earth_transform</span><span class="p">,</span>
            <span class="n">sw_algorithm</span><span class="o">=</span><span class="n">sw_algorithm</span><span class="p">,</span>
            <span class="n">qseis_version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;qssp&#39;</span><span class="p">:</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">receiver_model</span><span class="p">)</span>
        <span class="n">receiver_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;2010&#39;</span>

        <span class="n">conf</span> <span class="o">=</span> <span class="n">qssp</span><span class="o">.</span><span class="n">QSSPConfig</span><span class="p">(</span>
            <span class="n">qssp_version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
            <span class="n">slowness_max</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">slowness_taper</span><span class="p">)),</span>
            <span class="n">toroidal_modes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">spheroidal_modes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">source_patch_radius</span><span class="o">=</span><span class="p">(</span>
                <span class="n">fc</span><span class="o">.</span><span class="n">distance_delta</span> <span class="o">-</span> <span class="n">fc</span><span class="o">.</span><span class="n">distance_delta</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">/</span> <span class="n">km</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;qseis2d&#39;</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;2014&#39;</span>

        <span class="n">conf</span> <span class="o">=</span> <span class="n">qseis2d</span><span class="o">.</span><span class="n">QSeis2dConfig</span><span class="p">()</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">qseis_s_config</span><span class="o">.</span><span class="n">slowness_window</span> <span class="o">=</span> <span class="n">slowness_taper</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">qseis_s_config</span><span class="o">.</span><span class="n">calc_slowness_window</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">qseis_s_config</span><span class="o">.</span><span class="n">receiver_max_distance</span> <span class="o">=</span> \
            <span class="n">distances</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cake</span><span class="o">.</span><span class="n">d2m</span> <span class="o">/</span> <span class="n">km</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">qseis_s_config</span><span class="o">.</span><span class="n">sw_flat_earth_transform</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">gf_directory</span> <span class="o">=</span> <span class="n">gf_directory</span>

        <span class="c1"># find common basement layer</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="n">source_model</span><span class="o">.</span><span class="n">layer</span><span class="p">(</span><span class="n">receiver_basement_depth</span><span class="p">)</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">qseis_s_config</span><span class="o">.</span><span class="n">receiver_basement_depth</span> <span class="o">=</span> \
            <span class="nb">round</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">zbot</span> <span class="o">/</span> <span class="n">km</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">receiver_model</span> <span class="o">=</span> <span class="n">receiver_model</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
            <span class="n">depth_max</span><span class="o">=</span><span class="n">layer</span><span class="o">.</span><span class="n">ztop</span><span class="p">)</span>
        <span class="n">receiver_model</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Backend not supported: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>

    <span class="c1"># fill remaining fomosto params</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">earthmodel_1d</span> <span class="o">=</span> <span class="n">source_model</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">earthmodel_receiver_1d</span> <span class="o">=</span> <span class="n">receiver_model</span>
    <span class="n">fc</span><span class="o">.</span><span class="n">modelling_code_id</span> <span class="o">=</span> <span class="n">code</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">version</span>

    <span class="n">window_extension</span> <span class="o">=</span> <span class="mf">60.</span>   <span class="c1"># [s]</span>

    <span class="n">pids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;stored:&#39;</span> <span class="o">+</span> <span class="n">wave</span> <span class="k">for</span> <span class="n">wave</span> <span class="ow">in</span> <span class="n">waveforms</span><span class="p">]</span>

    <span class="n">conf</span><span class="o">.</span><span class="n">time_region</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span>
            <span class="n">phase_defs</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">),</span> <span class="n">select</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span>
            <span class="n">phase_defs</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mf">1.6</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">),</span> <span class="n">select</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">))</span>

    <span class="n">conf</span><span class="o">.</span><span class="n">cut</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span>
            <span class="n">phase_defs</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span> <span class="n">offset</span><span class="o">=-</span><span class="n">window_extension</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span>
            <span class="n">phase_defs</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">),</span> <span class="n">select</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">))</span>

    <span class="n">conf</span><span class="o">.</span><span class="n">relevel_with_fade_in</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">conf</span><span class="o">.</span><span class="n">fade</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span>
            <span class="n">phase_defs</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span> <span class="n">offset</span><span class="o">=-</span><span class="n">window_extension</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span>
            <span class="n">phase_defs</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">)</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span>
            <span class="n">phase_defs</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="n">window_extension</span><span class="p">),</span> <span class="n">select</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">),</span>
        <span class="n">gf</span><span class="o">.</span><span class="n">Timing</span><span class="p">(</span>
            <span class="n">phase_defs</span><span class="o">=</span><span class="n">pids</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mf">1.6</span> <span class="o">*</span> <span class="n">window_extension</span><span class="p">),</span> <span class="n">select</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">conf</span></div>


<div class="viewcode-block" id="seis_construct_gf"><a class="viewcode-back" href="../api.html#heart.seis_construct_gf">[docs]</a><span class="k">def</span> <span class="nf">seis_construct_gf</span><span class="p">(</span>
        <span class="n">stations</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">seismic_config</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">execute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate seismic Greens Functions (GFs) and create a repository &#39;store&#39;</span>
<span class="sd">    that is being used later on repeatetly to calculate the synthetic</span>
<span class="sd">    waveforms.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stations : list</span>
<span class="sd">        of :class:`pyrocko.model.Station`</span>
<span class="sd">        Station object that defines the distance from the event for which the</span>
<span class="sd">        GFs are being calculated</span>
<span class="sd">    event : :class:`pyrocko.model.Event`</span>
<span class="sd">        The event is used as a reference point for all the calculations</span>
<span class="sd">        According to the its location the earth model is being built</span>
<span class="sd">    seismic_config : :class:`config.SeismicConfig`</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        Index to set to the Greens Function store, 0 is reference store</span>
<span class="sd">        indexes &gt; 0 use reference model and vary its parameters by a Gaussian</span>
<span class="sd">    execute : boolean</span>
<span class="sd">        Flag to execute the calculation, if False just setup tested</span>
<span class="sd">    force : boolean</span>
<span class="sd">        Flag to overwrite existing GF stores</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sf</span> <span class="o">=</span> <span class="n">seismic_config</span><span class="o">.</span><span class="n">gf_config</span>

    <span class="n">source_model</span> <span class="o">=</span> <span class="n">get_velocity_model</span><span class="p">(</span>
        <span class="n">event</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">earth_model_name</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="n">crust_ind</span><span class="p">,</span>
        <span class="n">gf_config</span><span class="o">=</span><span class="n">sf</span><span class="p">,</span> <span class="n">custom_velocity_model</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">custom_velocity_model</span><span class="p">)</span>

    <span class="n">waveforms</span> <span class="o">=</span> <span class="n">seismic_config</span><span class="o">.</span><span class="n">get_waveform_names</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Station </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">station</span><span class="o">.</span><span class="n">station</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---------------------&#39;</span><span class="p">)</span>

        <span class="n">fomosto_config</span> <span class="o">=</span> <span class="n">get_fomosto_baseconfig</span><span class="p">(</span>
            <span class="n">sf</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">waveforms</span><span class="p">,</span> <span class="n">crust_ind</span><span class="p">)</span>

        <span class="n">store_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sf</span><span class="o">.</span><span class="n">store_superdir</span><span class="p">,</span> <span class="n">fomosto_config</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">store_dir</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating Store at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">store_dir</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">custom_velocity_model</span> <span class="o">=</span> <span class="n">sf</span><span class="o">.</span><span class="n">custom_velocity_model</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">custom_velocity_model</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">receiver_model</span> <span class="o">=</span> <span class="n">get_velocity_model</span><span class="p">(</span>
                <span class="n">station</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">earth_model_name</span><span class="p">,</span>
                <span class="n">crust_ind</span><span class="o">=</span><span class="n">crust_ind</span><span class="p">,</span> <span class="n">gf_config</span><span class="o">=</span><span class="n">sf</span><span class="p">,</span>
                <span class="n">custom_velocity_model</span><span class="o">=</span><span class="n">custom_velocity_model</span><span class="p">)</span>

            <span class="n">gf_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">sf</span><span class="o">.</span><span class="n">store_superdir</span><span class="p">,</span> <span class="s1">&#39;base_gfs_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">crust_ind</span><span class="p">)</span>

            <span class="n">conf</span> <span class="o">=</span> <span class="n">choose_backend</span><span class="p">(</span>
                <span class="n">fomosto_config</span><span class="p">,</span> <span class="n">sf</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">source_model</span><span class="p">,</span> <span class="n">receiver_model</span><span class="p">,</span>
                <span class="n">gf_directory</span><span class="p">)</span>

            <span class="n">fomosto_config</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

            <span class="n">gf</span><span class="o">.</span><span class="n">Store</span><span class="o">.</span><span class="n">create_editables</span><span class="p">(</span>
                <span class="n">store_dir</span><span class="p">,</span>
                <span class="n">config</span><span class="o">=</span><span class="n">fomosto_config</span><span class="p">,</span>
                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="n">sf</span><span class="o">.</span><span class="n">code</span><span class="p">:</span> <span class="n">conf</span><span class="p">},</span>
                <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;Store </span><span class="si">%s</span><span class="s1"> exists! Use force=True to overwrite!&#39;</span> <span class="o">%</span> <span class="n">store_dir</span><span class="p">)</span>

        <span class="n">traces_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="s1">&#39;traces&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">execute</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">traces_path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filling store ...&#39;</span><span class="p">)</span>
                <span class="n">store</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">store</span><span class="o">.</span><span class="n">make_ttt</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
                <span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">backend_builders</span><span class="p">[</span><span class="n">sf</span><span class="o">.</span><span class="n">code</span><span class="p">](</span>
                    <span class="n">store_dir</span><span class="p">,</span> <span class="n">nworkers</span><span class="o">=</span><span class="n">sf</span><span class="o">.</span><span class="n">nworkers</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">sf</span><span class="o">.</span><span class="n">rm_gfs</span> <span class="ow">and</span> <span class="n">sf</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;qssp&#39;</span><span class="p">:</span>
                    <span class="n">gf_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="s1">&#39;qssp_green&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing QSSP Greens Functions!&#39;</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">gf_dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Traces exist use force=True to overwrite!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="geo_construct_gf"><a class="viewcode-back" href="../api.html#heart.geo_construct_gf">[docs]</a><span class="k">def</span> <span class="nf">geo_construct_gf</span><span class="p">(</span>
        <span class="n">event</span><span class="p">,</span> <span class="n">geodetic_config</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">execute</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate geodetic Greens Functions (GFs) and create a fomosto &#39;GF store&#39;</span>
<span class="sd">    that is being used repeatetly later on to calculate the synthetic</span>
<span class="sd">    displacements. Enables various different source geometries.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    event : :class:`pyrocko.model.Event`</span>
<span class="sd">        The event is used as a reference point for all the calculations</span>
<span class="sd">        According to the its location the earth model is being built</span>
<span class="sd">    geodetic_config : :class:`config.GeodeticConfig`</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        Index to set to the Greens Function store</span>
<span class="sd">    execute : boolean</span>
<span class="sd">        Flag to execute the calculation, if False just setup tested</span>
<span class="sd">    force : boolean</span>
<span class="sd">        Flag to overwrite existing GF stores</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pyrocko.fomosto</span> <span class="k">import</span> <span class="n">psgrn_pscmp</span> <span class="k">as</span> <span class="n">ppp</span>

    <span class="n">version</span> <span class="o">=</span> <span class="s1">&#39;2008a&#39;</span>
    <span class="n">gfc</span> <span class="o">=</span> <span class="n">geodetic_config</span><span class="o">.</span><span class="n">gf_config</span>

    <span class="c1"># extract source crustal profile and check for water layer</span>
    <span class="n">source_model</span> <span class="o">=</span> <span class="n">get_velocity_model</span><span class="p">(</span>
        <span class="n">event</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">earth_model_name</span><span class="p">,</span>
        <span class="n">crust_ind</span><span class="o">=</span><span class="n">crust_ind</span><span class="p">,</span> <span class="n">gf_config</span><span class="o">=</span><span class="n">gfc</span><span class="p">,</span>
        <span class="n">custom_velocity_model</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">custom_velocity_model</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
            <span class="n">depth_max</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_depth_max</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">ppp</span><span class="o">.</span><span class="n">PsGrnPsCmpConfig</span><span class="p">()</span>

    <span class="n">c</span><span class="o">.</span><span class="n">pscmp_config</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>

    <span class="n">c</span><span class="o">.</span><span class="n">psgrn_config</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span>
    <span class="n">c</span><span class="o">.</span><span class="n">psgrn_config</span><span class="o">.</span><span class="n">sampling_interval</span> <span class="o">=</span> <span class="n">gfc</span><span class="o">.</span><span class="n">sampling_interval</span>
    <span class="n">c</span><span class="o">.</span><span class="n">psgrn_config</span><span class="o">.</span><span class="n">gf_depth_spacing</span> <span class="o">=</span> <span class="n">gfc</span><span class="o">.</span><span class="n">medium_depth_spacing</span>
    <span class="n">c</span><span class="o">.</span><span class="n">psgrn_config</span><span class="o">.</span><span class="n">gf_distance_spacing</span> <span class="o">=</span> <span class="n">gfc</span><span class="o">.</span><span class="n">medium_distance_spacing</span>

    <span class="n">station</span> <span class="o">=</span> <span class="n">ReferenceLocation</span><span class="p">(</span>
        <span class="n">station</span><span class="o">=</span><span class="s1">&#39;statics&#39;</span><span class="p">,</span>
        <span class="n">lat</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
        <span class="n">lon</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>

    <span class="n">fomosto_config</span> <span class="o">=</span> <span class="n">get_fomosto_baseconfig</span><span class="p">(</span>
        <span class="n">gfconfig</span><span class="o">=</span><span class="n">gfc</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span> <span class="n">station</span><span class="o">=</span><span class="n">station</span><span class="p">,</span>
        <span class="n">waveforms</span><span class="o">=</span><span class="p">[],</span> <span class="n">crust_ind</span><span class="o">=</span><span class="n">crust_ind</span><span class="p">)</span>

    <span class="n">store_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gfc</span><span class="o">.</span><span class="n">store_superdir</span><span class="p">,</span> <span class="n">fomosto_config</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">store_dir</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Create Store at: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">store_dir</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;---------------------------&#39;</span><span class="p">)</span>

        <span class="c1"># potentially vary source model</span>
        <span class="k">if</span> <span class="n">crust_ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">source_model</span> <span class="o">=</span> <span class="n">ensemble_earthmodel</span><span class="p">(</span>
                <span class="n">source_model</span><span class="p">,</span>
                <span class="n">num_vary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">error_depth</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">error_depth</span><span class="p">,</span>
                <span class="n">error_velocities</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">error_velocities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">fomosto_config</span><span class="o">.</span><span class="n">earthmodel_1d</span> <span class="o">=</span> <span class="n">source_model</span>
        <span class="n">fomosto_config</span><span class="o">.</span><span class="n">modelling_code_id</span> <span class="o">=</span> <span class="s1">&#39;psgrn_pscmp.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">version</span>

        <span class="n">c</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="n">fomosto_config</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="n">gf</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">Store</span><span class="o">.</span><span class="n">create_editables</span><span class="p">(</span>
            <span class="n">store_dir</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">fomosto_config</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;psgrn_pscmp&#39;</span><span class="p">:</span> <span class="n">c</span><span class="p">},</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Store </span><span class="si">%s</span><span class="s1"> exists! Use force=True to overwrite!&#39;</span> <span class="o">%</span> <span class="n">store_dir</span><span class="p">)</span>

    <span class="n">traces_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="s1">&#39;traces&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">execute</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">traces_path</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filling store ...&#39;</span><span class="p">)</span>

            <span class="n">store</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">store</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># build store</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ppp</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">store_dir</span><span class="p">,</span> <span class="n">nworkers</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">nworkers</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ppp</span><span class="o">.</span><span class="n">PsCmpError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;could not start psgrn/pscmp&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;psgrn/pscmp not installed&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Traces exist use force=True to overwrite!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="geo_construct_gf_psgrn"><a class="viewcode-back" href="../api.html#heart.geo_construct_gf_psgrn">[docs]</a><span class="k">def</span> <span class="nf">geo_construct_gf_psgrn</span><span class="p">(</span>
        <span class="n">event</span><span class="p">,</span> <span class="n">geodetic_config</span><span class="p">,</span> <span class="n">crust_ind</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">execute</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate geodetic Greens Functions (GFs) and create a repository &#39;store&#39;</span>
<span class="sd">    that is being used later on repeatetly to calculate the synthetic</span>
<span class="sd">    displacements.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    event : :class:`pyrocko.model.Event`</span>
<span class="sd">        The event is used as a reference point for all the calculations</span>
<span class="sd">        According to the its location the earth model is being built</span>
<span class="sd">    geodetic_config : :class:`config.GeodeticConfig`</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        Index to set to the Greens Function store</span>
<span class="sd">    execute : boolean</span>
<span class="sd">        Flag to execute the calculation, if False just setup tested</span>
<span class="sd">    force : boolean</span>
<span class="sd">        Flag to overwrite existing GF stores</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s1">&#39;This function is deprecated and might be removed in later versions!&#39;</span><span class="p">)</span>
    <span class="n">gfc</span> <span class="o">=</span> <span class="n">geodetic_config</span><span class="o">.</span><span class="n">gf_config</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">psgrn</span><span class="o">.</span><span class="n">PsGrnConfigFull</span><span class="p">()</span>

    <span class="n">n_steps_depth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="p">(</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_depth_max</span> <span class="o">-</span> <span class="n">gfc</span><span class="o">.</span><span class="n">source_depth_min</span><span class="p">)</span> <span class="o">/</span>
        <span class="n">gfc</span><span class="o">.</span><span class="n">source_depth_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">n_steps_distance</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
        <span class="p">(</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_distance_max</span> <span class="o">-</span> <span class="n">gfc</span><span class="o">.</span><span class="n">source_distance_min</span><span class="p">)</span> <span class="o">/</span>
        <span class="n">gfc</span><span class="o">.</span><span class="n">source_distance_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">c</span><span class="o">.</span><span class="n">distance_grid</span> <span class="o">=</span> <span class="n">psgrn</span><span class="o">.</span><span class="n">PsGrnSpatialSampling</span><span class="p">(</span>
        <span class="n">n_steps</span><span class="o">=</span><span class="n">n_steps_distance</span><span class="p">,</span>
        <span class="n">start_distance</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_distance_min</span><span class="p">,</span>
        <span class="n">end_distance</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_distance_max</span><span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">depth_grid</span> <span class="o">=</span> <span class="n">psgrn</span><span class="o">.</span><span class="n">PsGrnSpatialSampling</span><span class="p">(</span>
        <span class="n">n_steps</span><span class="o">=</span><span class="n">n_steps_depth</span><span class="p">,</span>
        <span class="n">start_distance</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_depth_min</span><span class="p">,</span>
        <span class="n">end_distance</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_depth_max</span><span class="p">)</span>

    <span class="n">c</span><span class="o">.</span><span class="n">sampling_interval</span> <span class="o">=</span> <span class="n">gfc</span><span class="o">.</span><span class="n">sampling_interval</span>

    <span class="c1"># extract source crustal profile and check for water layer</span>
    <span class="n">source_model</span> <span class="o">=</span> <span class="n">get_velocity_model</span><span class="p">(</span>
        <span class="n">event</span><span class="p">,</span> <span class="n">earth_model_name</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">earth_model_name</span><span class="p">,</span>
        <span class="n">crust_ind</span><span class="o">=</span><span class="n">crust_ind</span><span class="p">,</span> <span class="n">gf_config</span><span class="o">=</span><span class="n">gfc</span><span class="p">,</span>
        <span class="n">custom_velocity_model</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">custom_velocity_model</span><span class="p">)</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span>
            <span class="n">depth_max</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">source_depth_max</span> <span class="o">*</span> <span class="n">km</span><span class="p">)</span>

    <span class="c1"># potentially vary source model</span>
    <span class="k">if</span> <span class="n">crust_ind</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">source_model</span> <span class="o">=</span> <span class="n">ensemble_earthmodel</span><span class="p">(</span>
            <span class="n">source_model</span><span class="p">,</span>
            <span class="n">num_vary</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">error_depth</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">error_depth</span><span class="p">,</span>
            <span class="n">error_velocities</span><span class="o">=</span><span class="n">gfc</span><span class="o">.</span><span class="n">error_velocities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">c</span><span class="o">.</span><span class="n">earthmodel_1d</span> <span class="o">=</span> <span class="n">source_model</span>
    <span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">gfc</span><span class="o">.</span><span class="n">store_superdir</span><span class="p">,</span> <span class="s1">&#39;psgrn_green_</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crust_ind</span><span class="p">))</span>
    <span class="n">c</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

    <span class="n">util</span><span class="o">.</span><span class="n">ensuredir</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span><span class="p">)</span>

    <span class="n">runner</span> <span class="o">=</span> <span class="n">psgrn</span><span class="o">.</span><span class="n">PsGrnRunner</span><span class="p">(</span><span class="n">outdir</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">execute</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Geo GFs can be created in directory: </span><span class="si">%s</span><span class="s1"> ! &#39;</span>
                    <span class="s1">&#39;(execute=True necessary)! GF params: </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">execute</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating Geo GFs in directory: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span><span class="p">)</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span></div>


<div class="viewcode-block" id="geo_layer_synthetics_pscmp"><a class="viewcode-back" href="../api.html#heart.geo_layer_synthetics_pscmp">[docs]</a><span class="k">def</span> <span class="nf">geo_layer_synthetics_pscmp</span><span class="p">(</span>
        <span class="n">store_superdir</span><span class="p">,</span> <span class="n">crust_ind</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span>
        <span class="n">keep_tmp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate synthetic displacements for a given Greens Function database</span>
<span class="sd">    sources and observation points on the earths surface.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    store_superdir : str</span>
<span class="sd">        main path to directory containing the different Greensfunction stores</span>
<span class="sd">    crust_ind : int</span>
<span class="sd">        index of Greens Function store to use</span>
<span class="sd">    lons : List of floats</span>
<span class="sd">        Longitudes [decimal deg] of observation points</span>
<span class="sd">    lats : List of floats</span>
<span class="sd">        Latitudes [decimal deg] of observation points</span>
<span class="sd">    sources : List of :class:`pscmp.PsCmpRectangularSource`</span>
<span class="sd">        Sources to calculate synthetics for</span>
<span class="sd">    keep_tmp : boolean</span>
<span class="sd">        Flag to keep directories (in &#39;/tmp&#39;) where calculated synthetics are</span>
<span class="sd">        stored.</span>
<span class="sd">    outmode : str</span>
<span class="sd">        determines type of output</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`numpy.ndarray` (n_observations; ux-North, uy-East, uz-Down)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">pscmp</span><span class="o">.</span><span class="n">PsCmpConfigFull</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">observation</span> <span class="o">=</span> <span class="n">pscmp</span><span class="o">.</span><span class="n">PsCmpScatter</span><span class="p">(</span><span class="n">lats</span><span class="o">=</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="o">=</span><span class="n">lons</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">psgrn_outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">store_superdir</span><span class="p">,</span> <span class="s1">&#39;psgrn_green_</span><span class="si">%i</span><span class="s1">/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crust_ind</span><span class="p">))</span>

    <span class="c1"># only coseismic displacement</span>
    <span class="n">c</span><span class="o">.</span><span class="n">times_snapshots</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">c</span><span class="o">.</span><span class="n">rectangular_source_patches</span> <span class="o">=</span> <span class="n">sources</span>

    <span class="n">runner</span> <span class="o">=</span> <span class="n">pscmp</span><span class="o">.</span><span class="n">PsCmpRunner</span><span class="p">(</span><span class="n">keep_tmp</span><span class="o">=</span><span class="n">keep_tmp</span><span class="p">)</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c1"># returns list of displacements for each snapshot</span>
    <span class="k">return</span> <span class="n">runner</span><span class="o">.</span><span class="n">get_results</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;displ&#39;</span><span class="p">,</span> <span class="n">flip_z</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


<span class="k">class</span> <span class="nc">RayPathError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="get_phase_arrival_time"><a class="viewcode-back" href="../api.html#heart.get_phase_arrival_time">[docs]</a><span class="k">def</span> <span class="nf">get_phase_arrival_time</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">wavename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get arrival time from Greens Function store for respective</span>
<span class="sd">    :class:`pyrocko.gf.seismosizer.Target`,</span>
<span class="sd">    :class:`pyrocko.gf.meta.Location` pair.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    engine : :class:`pyrocko.gf.seismosizer.LocalEngine`</span>
<span class="sd">    source : :class:`pyrocko.gf.meta.Location`</span>
<span class="sd">        can be therefore :class:`pyrocko.gf.seismosizer.Source` or</span>
<span class="sd">        :class:`pyrocko.model.Event`</span>
<span class="sd">    target : :class:`pyrocko.gf.seismosizer.Target`</span>
<span class="sd">    wavename : string</span>
<span class="sd">        of the tabulated phase that determines the phase arrival</span>
<span class="sd">        needs to be the Id of a tabulated phase in the respective target.store</span>
<span class="sd">        if &quot;None&quot; uses first tabulated phase</span>
<span class="sd">    snap : if True</span>
<span class="sd">        force arrival time on discrete samples of the store</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    scalar, float of the arrival time of the wave</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">distance_to</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_store</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">store_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">gf</span><span class="o">.</span><span class="n">seismosizer</span><span class="o">.</span><span class="n">NoSuchStore</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">gf</span><span class="o">.</span><span class="n">seismosizer</span><span class="o">.</span><span class="n">NoSuchStore</span><span class="p">(</span>
            <span class="s1">&#39;No such store with ID </span><span class="si">%s</span><span class="s1"> found, distance [deg] to event: </span><span class="si">%f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">target</span><span class="o">.</span><span class="n">store_id</span><span class="p">,</span> <span class="n">cake</span><span class="o">.</span><span class="n">m2d</span> <span class="o">*</span> <span class="n">dist</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">wavename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wavename</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">tabulated_phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Wavename not specified using &#39;</span>
            <span class="s1">&#39;first tabulated phase! </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">wavename</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Arrival time for wavename &quot;</span><span class="si">%s</span><span class="s1">&quot; distance </span><span class="si">%f</span><span class="s1"> [deg]&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">wavename</span><span class="p">,</span> <span class="n">cake</span><span class="o">.</span><span class="n">m2d</span> <span class="o">*</span> <span class="n">dist</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">atime</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">wavename</span><span class="p">,</span> <span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="n">dist</span><span class="p">))</span> <span class="o">+</span> <span class="n">source</span><span class="o">.</span><span class="n">time</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">RayPathError</span><span class="p">(</span>
            <span class="s1">&#39;No wave-arrival for wavename &quot;</span><span class="si">%s</span><span class="s1">&quot; distance </span><span class="si">%f</span><span class="s1"> [deg]! &#39;</span>
            <span class="s1">&#39;Please adjust the distance range in the wavemap config!&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">wavename</span><span class="p">,</span> <span class="n">cake</span><span class="o">.</span><span class="n">m2d</span> <span class="o">*</span> <span class="n">dist</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">snap</span><span class="p">:</span>
        <span class="n">deltat</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">store</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sample_rate</span>
        <span class="n">atime</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">t2ind</span><span class="p">(</span><span class="n">atime</span><span class="p">,</span> <span class="n">deltat</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="nb">round</span><span class="p">)</span> <span class="o">*</span> <span class="n">deltat</span>
    <span class="k">return</span> <span class="n">atime</span></div>


<div class="viewcode-block" id="get_phase_taperer"><a class="viewcode-back" href="../api.html#heart.get_phase_taperer">[docs]</a><span class="k">def</span> <span class="nf">get_phase_taperer</span><span class="p">(</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">wavename</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">arrival_taper</span><span class="p">,</span> <span class="n">arrival_time</span><span class="o">=</span><span class="n">num</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create phase taperer according to synthetic travel times from</span>
<span class="sd">    source- target pair and taper return :class:`pyrocko.trace.CosTaper`</span>
<span class="sd">    according to defined arrival_taper times.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    engine : :class:`pyrocko.gf.seismosizer.LocalEngine`</span>
<span class="sd">    source : :class:`pyrocko.gf.meta.Location`</span>
<span class="sd">        can be therefore :class:`pyrocko.gf.seismosizer.Source` or</span>
<span class="sd">        :class:`pyrocko.model.Event`</span>
<span class="sd">    wavename : string</span>
<span class="sd">        of the tabulated phase that determines the phase arrival</span>
<span class="sd">    target : :class:`pyrocko.gf.seismosizer.Target`</span>
<span class="sd">    arrival_taper : :class:`ArrivalTaper`</span>
<span class="sd">    arrival_time : shift on arrival time (optional)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`pyrocko.trace.CosTaper`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">num</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arrival_time</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Using source reference for tapering!&#39;</span><span class="p">)</span>
        <span class="n">arrival_time</span> <span class="o">=</span> <span class="n">get_phase_arrival_time</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">wavename</span><span class="o">=</span><span class="n">wavename</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">get_pyrocko_taper</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">arrival_time</span><span class="p">))</span></div>


<div class="viewcode-block" id="WaveformMapping"><a class="viewcode-back" href="../api.html#heart.WaveformMapping">[docs]</a><span class="k">class</span> <span class="nc">WaveformMapping</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maps synthetic waveform parameters to targets, stations and data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        name of the waveform according to travel time tables</span>
<span class="sd">    stations : list</span>
<span class="sd">        of :class:`pyrocko.model.Station`</span>
<span class="sd">    weights : list</span>
<span class="sd">        of theano.shared variables</span>
<span class="sd">    channels : list</span>
<span class="sd">        of channel names valid for all the stations of this wavemap</span>
<span class="sd">    datasets : list</span>
<span class="sd">        of :class:`heart.Dataset` inherited from :class:`pyrocko.trace.Trace`</span>
<span class="sd">    targets : list</span>
<span class="sd">        of :class:`pyrocko.gf.target.Target`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span>
                 <span class="n">datasets</span><span class="o">=</span><span class="p">[],</span> <span class="n">targets</span><span class="o">=</span><span class="p">[],</span> <span class="n">deltat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">station_correction_idxs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prepared_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arrival_times</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target2index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_station2index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deltat</span> <span class="o">=</span> <span class="n">deltat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_trace_wavenames</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_station_corrections</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">target_index_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target2index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target2index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target2index</span>

    <span class="k">def</span> <span class="nf">station_index_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station2index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_station2index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">station</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station2index</span>

    <span class="k">def</span> <span class="nf">add_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">n_w</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_w</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_t</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CollectionError</span><span class="p">(</span>
                <span class="s1">&#39;Number of Weights </span><span class="si">%i</span><span class="s1"> inconsistent with targets </span><span class="si">%i</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">n_w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_t</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>

    <span class="k">def</span> <span class="nf">_update_station_corrections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update station_correction_idx</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s2i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">station_index_mapping</span><span class="p">()</span>
        <span class="n">station_idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span>
            <span class="n">station_idxs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span><span class="n">s2i</span><span class="p">[</span><span class="n">station</span><span class="p">]</span> <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">station_correction_idxs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">station_idxs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int16&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="WaveformMapping.station_weeding"><a class="viewcode-back" href="../api.html#heart.WaveformMapping.station_weeding">[docs]</a>    <span class="k">def</span> <span class="nf">station_weeding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">blacklist</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Weed stations and related objects based on distances and blacklist.</span>
<span class="sd">        Works only a single time after init!</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">empty_stations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_station_names_without_data</span><span class="p">()</span>
        <span class="n">blacklist</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">empty_stations</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">apply_station_blacklist</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">,</span> <span class="n">blacklist</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">weed_stations</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">distances</span><span class="o">=</span><span class="n">distances</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">weed_data_traces</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">weed_targets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">)</span>

        <span class="c1"># reset mappings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target2index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_station2index</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_station_corrections</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_consistency</span><span class="p">()</span></div>

<div class="viewcode-block" id="WaveformMapping.get_station_names"><a class="viewcode-back" href="../api.html#heart.WaveformMapping.get_station_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_station_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns list of strings of station names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">station</span> <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">get_station_names_without_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">blacklist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">station_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_station_names</span><span class="p">()</span>
        <span class="n">dataset_station_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">tr</span><span class="o">.</span><span class="n">station</span> <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">station_name</span> <span class="ow">in</span> <span class="n">station_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">station_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset_station_names</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Found no data for station &quot;</span><span class="si">%s</span><span class="s1">&quot; &#39;</span>
                    <span class="s1">&#39;- removing it from setup.&#39;</span> <span class="o">%</span> <span class="n">station_name</span><span class="p">)</span>
                <span class="n">blacklist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">station_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">blacklist</span>

    <span class="k">def</span> <span class="nf">check_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_t</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CollectionError</span><span class="p">(</span>
                <span class="s1">&#39;Inconsistent number of datasets and targets!&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CollectionError</span><span class="p">(</span>
                <span class="s1">&#39;No data left in wavemap &quot;</span><span class="si">%s</span><span class="s1">&quot; after applying the distance &#39;</span>
                <span class="s1">&#39;filter! Either (1) Adjust distance range (set &quot;distances&quot; &#39;</span>
                <span class="s1">&#39; parameter in beat.WaveformFitConfig, given in degrees &#39;</span>
                <span class="s1">&#39; epicentral distance) or (2) deactivate the wavemap &#39;</span>
                <span class="s1">&#39;completely by setting include=False!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Consistent number of &#39;</span>
                        <span class="s1">&#39;datasets and targets in </span><span class="si">%s</span><span class="s1"> wavemap!&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapid</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">update_interpolation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="n">method</span>

    <span class="k">def</span> <span class="nf">_update_trace_wavenames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">wavename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wavename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="k">for</span> <span class="n">dtrace</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
            <span class="n">dtrace</span><span class="o">.</span><span class="n">set_wavename</span><span class="p">(</span><span class="n">wavename</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_mapid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;mapnumber&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapnumber</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_shifts_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;time_shifts_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hypersize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the size of the related hyperparameters as an integer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nhyp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_t</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nhyp</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">nhyp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;hyperparameter size is not integer &#39;</span>
                <span class="s1">&#39;for wavemap </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapid</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_target_idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]):</span>

        <span class="n">t2i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_index_mapping</span><span class="p">()</span>
        <span class="n">dtargets</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="n">tidxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cha</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="n">tidxs</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">t2i</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">dtargets</span><span class="p">[</span><span class="n">cha</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">tidxs</span>

<div class="viewcode-block" id="WaveformMapping.prepare_data"><a class="viewcode-back" href="../api.html#heart.WaveformMapping.prepare_data">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Taper, filter data traces according to given reference event.</span>
<span class="sd">        Traces are concatenated to one single array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepared_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Overwriting observed data windows in &quot;</span><span class="si">%s</span><span class="s1">&quot;!&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapnumber</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">):</span>
            <span class="n">arrival_times</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_t</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">):</span>
                <span class="n">arrival_times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_phase_arrival_time</span><span class="p">(</span>
                    <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">wavename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">preprocess_data</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Pre-processing data ...&#39;</span><span class="p">)</span>
                <span class="n">filterer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">filterer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Not pre-processing data ...&#39;</span><span class="p">)</span>
                <span class="n">filterer</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_prepared_data</span> <span class="o">=</span> <span class="n">taper_filter_traces</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">,</span>
                <span class="n">arrival_taper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">arrival_taper</span><span class="p">,</span>
                <span class="n">filterer</span><span class="o">=</span><span class="n">filterer</span><span class="p">,</span>
                <span class="n">arrival_times</span><span class="o">=</span><span class="n">arrival_times</span><span class="p">,</span>
                <span class="n">outmode</span><span class="o">=</span><span class="n">outmode</span><span class="p">,</span>
                <span class="n">chop_bounds</span><span class="o">=</span><span class="n">chop_bounds</span><span class="p">,</span>
                <span class="n">deltat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deltat</span><span class="p">,</span>
                <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_arrival_times</span> <span class="o">=</span> <span class="n">arrival_times</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Wavemap needs configuration!&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="WaveformMapping.get_highest_frequency"><a class="viewcode-back" href="../api.html#heart.WaveformMapping.get_highest_frequency">[docs]</a>    <span class="k">def</span> <span class="nf">get_highest_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loop over filterers and return highest frequency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">highest_fs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">filterer</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="n">Filter</span><span class="p">):</span>
                <span class="n">highest_fs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filt</span><span class="o">.</span><span class="n">upper_corner</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">highest_fs</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shared_data_array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepared_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data array is not initialized&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prepared_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Data got initialized as pyrocko traces, need array!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">shared</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prepared_data</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_data&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">borrow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">CollectionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="DataWaveformCollection"><a class="viewcode-back" href="../api.html#heart.DataWaveformCollection">[docs]</a><span class="k">class</span> <span class="nc">DataWaveformCollection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collection of available datasets, data-weights, waveforms and</span>
<span class="sd">    DynamicTargets used to create synthetics.</span>

<span class="sd">    Is used to return Mappings of the waveforms of interest to fit to the</span>
<span class="sd">    involved data, weights and synthetics generating objects.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stations : List of :class:`pyrocko.model.Station`</span>
<span class="sd">        List of station objects that are contained in the dataset</span>
<span class="sd">    waveforms : list</span>
<span class="sd">        of strings of tabulated phases that are to be used for misfit</span>
<span class="sd">        calculation</span>
<span class="sd">    target_deltat : float</span>
<span class="sd">        sampling interval the data is going to be downsampled to</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">waveforms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_deltat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="n">stations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveforms</span> <span class="o">=</span> <span class="n">waveforms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deltat</span> <span class="o">=</span> <span class="n">target_deltat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_targets</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_datasets</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_responses</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target2index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_station2index</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">adjust_sampling_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deltat</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_datasets</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">nslc_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">[</span><span class="n">tr</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">utility</span><span class="o">.</span><span class="n">downsample_trace</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">deltat</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="n">snap</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CollectionError</span><span class="p">(</span>
                    <span class="s1">&#39;Downsampled trace </span><span class="si">%s</span><span class="s1"> already in&#39;</span>
                    <span class="s1">&#39; collection!&#39;</span> <span class="o">%</span> <span class="n">utility</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">nslc_id</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_deltat</span> <span class="o">=</span> <span class="n">deltat</span>

    <span class="k">def</span> <span class="nf">_check_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waveform</span><span class="p">,</span> <span class="n">errormode</span><span class="o">=</span><span class="s1">&#39;not_in&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">errormode</span> <span class="o">==</span> <span class="s1">&#39;not_in&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">waveform</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waveforms</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CollectionError</span><span class="p">(</span>
                    <span class="s1">&#39;Waveform is not contained in collection!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">elif</span> <span class="n">errormode</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">waveform</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">waveforms</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CollectionError</span><span class="p">(</span><span class="s1">&#39;Wavefom already in collection!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_targets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">add_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waveform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datasets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_waveform</span><span class="p">(</span><span class="n">waveform</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_targets</span><span class="p">(</span><span class="n">waveform</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_datasets</span><span class="p">(</span><span class="n">waveform</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_waveforms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">waveforms</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">target_index_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target2index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target2index</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_targets</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target2index</span>

    <span class="k">def</span> <span class="nf">get_waveform_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">waveforms</span>

    <span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nslc</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raw</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="p">[</span><span class="n">nslc</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_datasets</span><span class="p">[</span><span class="n">nslc</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">add_waveforms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waveforms</span><span class="o">=</span><span class="p">[],</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">waveform</span> <span class="ow">in</span> <span class="n">waveforms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_collection</span><span class="p">(</span><span class="n">waveform</span><span class="p">,</span> <span class="n">errormode</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waveforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">waveform</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_responses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">responses</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_responses</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">responses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
                <span class="n">k</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_responses</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">add_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_targets</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="n">current_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_targets</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_targets</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_targets</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">codes</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s1">&#39;Target </span><span class="si">%s</span><span class="s1"> already in collection!&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">codes</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">add_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_datasets</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">set_location</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">location</span><span class="p">))</span>

            <span class="n">nslc_id</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">nslc_id</span>
            <span class="k">if</span> <span class="n">nslc_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entries</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw_datasets</span><span class="p">[</span><span class="n">nslc_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s1">&#39;Dataset </span><span class="si">%s</span><span class="s1"> already in collection!&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">nslc_id</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datasets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">get_waveform_mapping</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">waveform</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">],</span> <span class="n">quantity</span><span class="o">=</span><span class="s1">&#39;displacement&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_collection</span><span class="p">(</span><span class="n">waveform</span><span class="p">,</span> <span class="n">errormode</span><span class="o">=</span><span class="s1">&#39;not_in&#39;</span><span class="p">)</span>

        <span class="n">dtargets</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_targets</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">codes</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cha</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
            <span class="n">targets</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dtargets</span><span class="p">[</span><span class="n">cha</span><span class="p">])</span>

        <span class="n">datasets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">discard_targets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="n">target</span><span class="o">.</span><span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span>
            <span class="n">nslc_id</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">codes</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dtrace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_datasets</span><span class="p">[</span><span class="n">nslc_id</span><span class="p">]</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dtrace</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s1">&#39;No data trace for target </span><span class="si">%s</span><span class="s1"> in &#39;</span>
                    <span class="s1">&#39;the collection! Removing target!&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">nslc_id</span><span class="p">))</span>
                <span class="n">discard_targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_responses</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">update_response</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_responses</span><span class="p">[</span><span class="n">nslc_id</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s1">&#39;No response for target </span><span class="si">%s</span><span class="s1"> in &#39;</span>
                        <span class="s1">&#39;the collection!&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">nslc_id</span><span class="p">))</span>

        <span class="n">targets</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">weed_targets</span><span class="p">(</span>
            <span class="n">targets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">,</span> <span class="n">discard_targets</span><span class="o">=</span><span class="n">discard_targets</span><span class="p">)</span>

        <span class="n">ndata</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span>
        <span class="n">n_t</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ndata</span> <span class="o">!=</span> <span class="n">n_t</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;Inconsistent number of targets </span><span class="si">%i</span><span class="s1"> &#39;</span>
                <span class="s1">&#39;and datasets </span><span class="si">%i</span><span class="s1">! in wavemap </span><span class="si">%s</span><span class="s1"> init&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n_t</span><span class="p">,</span> <span class="n">ndata</span><span class="p">,</span> <span class="n">waveform</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">WaveformMapping</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">waveform</span><span class="p">,</span>
            <span class="n">stations</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stations</span><span class="p">),</span>
            <span class="n">datasets</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">datasets</span><span class="p">),</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">targets</span><span class="p">),</span>
            <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
            <span class="n">deltat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_deltat</span><span class="p">)</span></div>


<div class="viewcode-block" id="concatenate_datasets"><a class="viewcode-back" href="../api.html#heart.concatenate_datasets">[docs]</a><span class="k">def</span> <span class="nf">concatenate_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenate datasets to single arrays</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datasets : list</span>
<span class="sd">        of :class:`GeodeticDataset`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    datasets : 1d :class:numpy.NdArray` n x 1</span>
<span class="sd">    los_vectors : 2d :class:numpy.NdArray` n x 3</span>
<span class="sd">    odws : 1d :class:numpy.NdArray` n x 1</span>
<span class="sd">    Bij : :class:`utility.ListToArrayBijection`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_disp_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">displacement</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
    <span class="n">_odws_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">odw</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>
    <span class="n">_lv_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">update_los_vector</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datasets</span><span class="p">]</span>

    <span class="c1"># merge geodetic data to calculate residuals on single array</span>
    <span class="n">ordering</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">ListArrayOrdering</span><span class="p">(</span><span class="n">_disp_list</span><span class="p">,</span> <span class="n">intype</span><span class="o">=</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
    <span class="n">Bij</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">ListToArrayBijection</span><span class="p">(</span><span class="n">ordering</span><span class="p">,</span> <span class="n">_disp_list</span><span class="p">)</span>

    <span class="n">odws</span> <span class="o">=</span> <span class="n">Bij</span><span class="o">.</span><span class="n">l2a</span><span class="p">(</span><span class="n">_odws_list</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
    <span class="n">datasets</span> <span class="o">=</span> <span class="n">Bij</span><span class="o">.</span><span class="n">l2a</span><span class="p">(</span><span class="n">_disp_list</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
    <span class="n">los_vectors</span> <span class="o">=</span> <span class="n">Bij</span><span class="o">.</span><span class="n">f3map</span><span class="p">(</span><span class="n">_lv_list</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">los_vectors</span><span class="p">,</span> <span class="n">odws</span><span class="p">,</span> <span class="n">Bij</span></div>


<div class="viewcode-block" id="init_datahandler"><a class="viewcode-back" href="../api.html#heart.init_datahandler">[docs]</a><span class="k">def</span> <span class="nf">init_datahandler</span><span class="p">(</span>
        <span class="n">seismic_config</span><span class="p">,</span> <span class="n">seismic_data_path</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">responses_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialise datahandler.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    seismic_config : :class:`config.SeismicConfig`</span>
<span class="sd">    seismic_data_path : str</span>
<span class="sd">        absolute path to the directory of the seismic data</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    datahandler : :class:`DataWaveformCollection`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sc</span> <span class="o">=</span> <span class="n">seismic_config</span>

    <span class="n">stations</span><span class="p">,</span> <span class="n">data_traces</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">load_objects</span><span class="p">(</span><span class="n">seismic_data_path</span><span class="p">)</span>

    <span class="n">wavenames</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_waveform_names</span><span class="p">()</span>

    <span class="n">targets</span> <span class="o">=</span> <span class="n">init_seismic_targets</span><span class="p">(</span>
        <span class="n">stations</span><span class="p">,</span>
        <span class="n">earth_model_name</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">earth_model_name</span><span class="p">,</span>
        <span class="n">channels</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">get_unique_channels</span><span class="p">(),</span>
        <span class="n">sample_rate</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">sample_rate</span><span class="p">,</span>
        <span class="n">crust_inds</span><span class="o">=</span><span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">reference_model_idx</span><span class="p">],</span>
        <span class="n">reference_location</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">reference_location</span><span class="p">)</span>

    <span class="n">target_deltat</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">sc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">sample_rate</span>

    <span class="n">datahandler</span> <span class="o">=</span> <span class="n">DataWaveformCollection</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">wavenames</span><span class="p">,</span> <span class="n">target_deltat</span><span class="p">)</span>
    <span class="n">datahandler</span><span class="o">.</span><span class="n">add_datasets</span><span class="p">(</span>
        <span class="n">data_traces</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">reference_model_idx</span><span class="p">)</span>

    <span class="c1"># decimation needs to come after filtering</span>
    <span class="c1"># datahandler.adjust_sampling_datasets(target_deltat, snap=True)</span>
    <span class="n">datahandler</span><span class="o">.</span><span class="n">add_targets</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">responses_path</span><span class="p">:</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">load_objects</span><span class="p">(</span><span class="n">responses_path</span><span class="p">)</span>
        <span class="n">datahandler</span><span class="o">.</span><span class="n">add_responses</span><span class="p">(</span>
            <span class="n">responses</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">gf_config</span><span class="o">.</span><span class="n">reference_model_idx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">datahandler</span></div>


<div class="viewcode-block" id="init_wavemap"><a class="viewcode-back" href="../api.html#heart.init_wavemap">[docs]</a><span class="k">def</span> <span class="nf">init_wavemap</span><span class="p">(</span>
        <span class="n">waveformfit_config</span><span class="p">,</span> <span class="n">datahandler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mapnumber</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialise wavemap, which sets targets, datasets and stations into</span>
<span class="sd">    relation to the seismic Phase of interest and allows individual</span>
<span class="sd">    specificiations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    waveformfit_config : :class:`config.WaveformFitConfig`</span>
<span class="sd">    datahandler : :class:`DataWaveformCollection`</span>
<span class="sd">    event : :class:`pyrocko.model.Event`</span>
<span class="sd">    mapnumber : int</span>
<span class="sd">        number of wavemap in list of wavemaps</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wmap : :class:`WaveformMapping`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wc</span> <span class="o">=</span> <span class="n">waveformfit_config</span>
    <span class="n">wmap</span> <span class="o">=</span> <span class="n">datahandler</span><span class="o">.</span><span class="n">get_waveform_mapping</span><span class="p">(</span>
        <span class="n">wc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">wc</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="n">wc</span><span class="o">.</span><span class="n">quantity</span><span class="p">)</span>
    <span class="n">wmap</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">wc</span>
    <span class="n">wmap</span><span class="o">.</span><span class="n">mapnumber</span> <span class="o">=</span> <span class="n">mapnumber</span>

    <span class="n">wmap</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">arrival_taper</span><span class="o">.</span><span class="n">check_sample_rate_consistency</span><span class="p">(</span>
        <span class="n">datahandler</span><span class="o">.</span><span class="n">_deltat</span><span class="p">)</span>

    <span class="n">wmap</span><span class="o">.</span><span class="n">station_weeding</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">wc</span><span class="o">.</span><span class="n">distances</span><span class="p">,</span> <span class="n">blacklist</span><span class="o">=</span><span class="n">wc</span><span class="o">.</span><span class="n">blacklist</span><span class="p">)</span>

    <span class="n">wmap</span><span class="o">.</span><span class="n">update_interpolation</span><span class="p">(</span><span class="n">wc</span><span class="o">.</span><span class="n">interpolation</span><span class="p">)</span>
    <span class="n">wmap</span><span class="o">.</span><span class="n">_update_trace_wavenames</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">wc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">wmap</span><span class="o">.</span><span class="n">mapnumber</span><span class="p">)]))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Number of seismic datasets for wavemap: </span><span class="si">%s</span><span class="s1">: </span><span class="si">%i</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">wmap</span><span class="o">.</span><span class="n">_mapid</span><span class="p">,</span> <span class="n">wmap</span><span class="o">.</span><span class="n">n_data</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">wmap</span></div>


<div class="viewcode-block" id="post_process_trace"><a class="viewcode-back" href="../api.html#heart.post_process_trace">[docs]</a><span class="k">def</span> <span class="nf">post_process_trace</span><span class="p">(</span>
        <span class="n">trace</span><span class="p">,</span> <span class="n">taper</span><span class="p">,</span> <span class="n">filterer</span><span class="p">,</span> <span class="n">taper_tolerance_factor</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">deltat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">outmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">],</span> <span class="n">transfer_function</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Taper, filter and then chop one trace in place.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    trace : :class:`SeismicDataset`</span>
<span class="sd">    arrival_taper : :class:`pyrocko.trace.Taper`</span>
<span class="sd">    filterer : list</span>
<span class="sd">        of :class:`Filterer`</span>
<span class="sd">    taper_tolerance_factor : float</span>
<span class="sd">        default: 0 , cut exactly at the taper edges</span>
<span class="sd">        taper.fadein times this factor determines added tolerance</span>
<span class="sd">    chop_bounds : str</span>
<span class="sd">        determines where to chop the trace on the taper attributes</span>
<span class="sd">        may be combination of [a, b, c, d]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">transfer_function</span><span class="p">:</span>
        <span class="c1"># convolve invert False deconvolve invert True</span>
        <span class="n">dummy_filterer</span> <span class="o">=</span> <span class="n">FrequencyFilter</span><span class="p">()</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">transfer</span><span class="p">(</span>
            <span class="n">dummy_filterer</span><span class="o">.</span><span class="n">tfade</span><span class="p">,</span> <span class="n">dummy_filterer</span><span class="o">.</span><span class="n">freqlimits</span><span class="p">,</span>
            <span class="n">transfer_function</span><span class="o">=</span><span class="n">transfer_function</span><span class="p">,</span>
            <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cut_off_fading</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;transfer trace: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">filterer</span><span class="p">:</span>
        <span class="c1"># apply all the filters</span>
        <span class="k">for</span> <span class="n">filt</span> <span class="ow">in</span> <span class="n">filterer</span><span class="p">:</span>
            <span class="n">filt</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">deltat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">utility</span><span class="o">.</span><span class="n">downsample_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">deltat</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">taper</span> <span class="ow">and</span> <span class="n">outmode</span> <span class="o">!=</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
        <span class="n">tolerance</span> <span class="o">=</span> <span class="p">(</span><span class="n">taper</span><span class="o">.</span><span class="n">b</span> <span class="o">-</span> <span class="n">taper</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">taper_tolerance_factor</span>
        <span class="n">lower_cut</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">taper</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">tolerance</span>
        <span class="n">upper_cut</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">taper</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">tolerance</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;taper times: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">taper</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;trace: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>

        <span class="n">trace</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lower_cut</span><span class="p">,</span> <span class="n">upper_cut</span><span class="p">,</span> <span class="n">fillmethod</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">)</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">taper</span><span class="p">(</span><span class="n">taper</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">chop</span><span class="p">(</span><span class="n">tmin</span><span class="o">=</span><span class="n">lower_cut</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="n">upper_cut</span><span class="p">,</span> <span class="n">snap</span><span class="o">=</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">floor</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">floor</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;chopped trace: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">trace</span></div>


<span class="k">class</span> <span class="nc">StackingError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">nzeros</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;displacement&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;velocity&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="proto2zpk"><a class="viewcode-back" href="../api.html#heart.proto2zpk">[docs]</a><span class="k">def</span> <span class="nf">proto2zpk</span><span class="p">(</span><span class="n">magnification</span><span class="p">,</span> <span class="n">damping</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">quantity</span><span class="o">=</span><span class="s1">&#39;displacement&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert magnification, damping and period of a station to poles and zeros.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    magnification : float</span>
<span class="sd">        gain of station</span>
<span class="sd">    damping : float</span>
<span class="sd">        in []</span>
<span class="sd">    period : float</span>
<span class="sd">        in [s]</span>
<span class="sd">    quantity : string</span>
<span class="sd">        in which related data are recorded</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lists of zeros, poles and gain</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">cmath</span>

    <span class="n">zeros</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nzeros</span><span class="p">[</span><span class="n">quantity</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">omega0</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">period</span>
    <span class="n">preal</span> <span class="o">=</span> <span class="o">-</span> <span class="n">damping</span> <span class="o">*</span> <span class="n">omega0</span>
    <span class="n">pimag</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">J</span> <span class="o">*</span> <span class="n">omega0</span> <span class="o">*</span> <span class="n">cmath</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">damping</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">poles</span> <span class="o">=</span> <span class="p">[</span><span class="n">preal</span> <span class="o">+</span> <span class="n">pimag</span><span class="p">,</span> <span class="n">preal</span> <span class="o">-</span> <span class="n">pimag</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">poles</span><span class="p">,</span> <span class="n">magnification</span></div>


<div class="viewcode-block" id="seis_synthetics"><a class="viewcode-back" href="../api.html#heart.seis_synthetics">[docs]</a><span class="k">def</span> <span class="nf">seis_synthetics</span><span class="p">(</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">arrival_taper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wavename</span><span class="o">=</span><span class="s1">&#39;any_P&#39;</span><span class="p">,</span> <span class="n">filterer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reference_taperer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nprocs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;array&#39;</span><span class="p">,</span>
        <span class="n">pre_stack_cut</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">taper_tolerance_factor</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
        <span class="n">arrival_times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate synthetic seismograms of combination of targets and sources,</span>
<span class="sd">    filtering and tapering afterwards (filterer)</span>
<span class="sd">    tapering according to arrival_taper around P -or S wave.</span>
<span class="sd">    If reference_taper the given taper is always used.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    engine : :class:`pyrocko.gf.seismosizer.LocalEngine`</span>
<span class="sd">    sources : list</span>
<span class="sd">        containing :class:`pyrocko.gf.seismosizer.Source` Objects</span>
<span class="sd">        reference source is the first in the list!!!</span>
<span class="sd">    targets : list</span>
<span class="sd">        containing :class:`pyrocko.gf.seismosizer.Target` Objects</span>
<span class="sd">    arrival_taper : :class:`ArrivalTaper`</span>
<span class="sd">    wavename : string</span>
<span class="sd">        of the tabulated phase that determines the phase arrival</span>
<span class="sd">    filterer : :class:`Filterer`</span>
<span class="sd">    plot : boolean</span>
<span class="sd">        flag for looking at traces</span>
<span class="sd">    nprocs : int</span>
<span class="sd">        number of processors to use for synthetics calculation</span>
<span class="sd">        --&gt; currently no effect !!!</span>
<span class="sd">    outmode : string</span>
<span class="sd">        output format of synthetics can be &#39;array&#39;, &#39;stacked_traces&#39;,</span>
<span class="sd">        &#39;data&#39; returns traces unstacked including post-processing,</span>
<span class="sd">        &#39;tapered_data&#39; returns unstacked but tapered traces</span>
<span class="sd">    pre_stack_cut : boolean</span>
<span class="sd">        flag to decide wheather prior to stacking the GreensFunction traces</span>
<span class="sd">        should be cutted according to the phase arival time and the defined</span>
<span class="sd">        taper</span>
<span class="sd">    taper_tolerance_factor : float</span>
<span class="sd">        tolerance to chop traces around taper.a and taper.d</span>
<span class="sd">    arrival_times : None or :class:`numpy.NdArray`</span>
<span class="sd">        of phase to apply taper, if None theoretic arrival of ray tracing used</span>
<span class="sd">    chop_bounds : list  of str</span>
<span class="sd">        determines where to chop the trace on the taper attributes</span>
<span class="sd">        may be combination of [a, b, c, d]</span>
<span class="sd">    transfer_functions : list</span>
<span class="sd">        of transfer functions to convolve the synthetics with</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`numpy.ndarray` or List of :class:`pyrocko.trace.Trace`</span>
<span class="sd">         with data each row-one target</span>
<span class="sd">    :class:`numpy.ndarray` of tmins for traces</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stackmodes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;stacked_traces&#39;</span><span class="p">,</span> <span class="s1">&#39;tapered_data&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">outmode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stackmodes</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">StackingError</span><span class="p">(</span>
            <span class="s1">&#39;Outmode &quot;</span><span class="si">%s</span><span class="s1">&quot; not available! Available: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">outmode</span><span class="p">,</span> <span class="n">utility</span><span class="o">.</span><span class="n">list2string</span><span class="p">(</span><span class="n">stackmodes</span><span class="p">)))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">arrival_times</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">arrival_times</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tconfig</span><span class="o">.</span><span class="n">floatX</span><span class="p">)</span>
        <span class="n">arrival_times</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">taperers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tapp</span> <span class="o">=</span> <span class="n">taperers</span><span class="o">.</span><span class="n">append</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arrival_taper</span><span class="p">:</span>
            <span class="n">tapp</span><span class="p">(</span><span class="n">get_phase_taperer</span><span class="p">(</span>
                <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">wavename</span><span class="o">=</span><span class="n">wavename</span><span class="p">,</span>
                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
                <span class="n">arrival_taper</span><span class="o">=</span><span class="n">arrival_taper</span><span class="p">,</span>
                <span class="n">arrival_time</span><span class="o">=</span><span class="n">arrival_times</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">pre_stack_cut</span> <span class="ow">and</span> <span class="n">arrival_taper</span> <span class="ow">and</span> <span class="n">outmode</span> <span class="o">!=</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">taperer</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">taperers</span><span class="p">):</span>
            <span class="n">t</span><span class="o">.</span><span class="n">update_target_times</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">taperer</span><span class="p">)</span>

    <span class="n">t_2</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
            <span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span>
            <span class="n">targets</span><span class="o">=</span><span class="n">targets</span><span class="p">,</span> <span class="n">nprocs</span><span class="o">=</span><span class="n">nprocs</span><span class="p">)</span>
        <span class="n">t_1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The GF store returned an empty trace!&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Synthetics generation time: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t_1</span> <span class="o">-</span> <span class="n">t_2</span><span class="p">))</span>
    <span class="c1"># logger.debug(&#39;Details: %s \n&#39; % response.stats)</span>

    <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">synt_trcs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sapp</span> <span class="o">=</span> <span class="n">synt_trcs</span><span class="o">.</span><span class="n">append</span>
    <span class="n">taper_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">iter_results</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">arrival_taper</span><span class="p">:</span>
            <span class="n">taper</span> <span class="o">=</span> <span class="n">taperers</span><span class="p">[</span><span class="n">taper_index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">taper</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">tr</span> <span class="o">=</span> <span class="n">post_process_trace</span><span class="p">(</span>
            <span class="n">trace</span><span class="o">=</span><span class="n">tr</span><span class="p">,</span>
            <span class="n">taper</span><span class="o">=</span><span class="n">taper</span><span class="p">,</span>
            <span class="n">filterer</span><span class="o">=</span><span class="n">filterer</span><span class="p">,</span>
            <span class="n">taper_tolerance_factor</span><span class="o">=</span><span class="n">taper_tolerance_factor</span><span class="p">,</span>
            <span class="n">outmode</span><span class="o">=</span><span class="n">outmode</span><span class="p">,</span>
            <span class="n">chop_bounds</span><span class="o">=</span><span class="n">chop_bounds</span><span class="p">,</span>
            <span class="n">transfer_function</span><span class="o">=</span><span class="n">target</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>

        <span class="n">sapp</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Post-process time </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">snuffle</span><span class="p">(</span><span class="n">synt_trcs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">arrival_taper</span> <span class="ow">and</span> <span class="n">outmode</span> <span class="o">!=</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">synths</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">trc</span><span class="o">.</span><span class="n">ydata</span> <span class="k">for</span> <span class="n">trc</span> <span class="ow">in</span> <span class="n">synt_trcs</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">trc</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">trc</span> <span class="ow">in</span> <span class="n">synt_trcs</span><span class="p">]</span>
            <span class="n">tmins</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">trc</span><span class="o">.</span><span class="n">tmin</span> <span class="k">for</span> <span class="n">trc</span> <span class="ow">in</span> <span class="n">synt_trcs</span><span class="p">])</span>
            <span class="n">tmaxs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">trc</span><span class="o">.</span><span class="n">tmax</span> <span class="k">for</span> <span class="n">trc</span> <span class="ow">in</span> <span class="n">synt_trcs</span><span class="p">])</span>
            <span class="n">tmins</span> <span class="o">-=</span> <span class="n">tmins</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;lengths&#39;</span><span class="p">,</span> <span class="n">lengths</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tmins&#39;</span><span class="p">,</span> <span class="n">tmins</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tmaxs&#39;</span><span class="p">,</span> <span class="n">tmins</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">,</span> <span class="n">tmaxs</span> <span class="o">-</span> <span class="n">tmins</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;arrival_times&#39;</span><span class="p">,</span> <span class="n">arrival_times</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;arrival_times norm&#39;</span><span class="p">,</span> <span class="n">arrival_times</span> <span class="o">-</span> <span class="n">arrival_times</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">snuffle</span><span class="p">(</span><span class="n">synt_trcs</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Stacking error, traces different lengths!&#39;</span><span class="p">)</span>

        <span class="c1"># stack traces for all sources</span>
        <span class="n">t6</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ns</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">outstack</span> <span class="o">=</span> <span class="n">synths</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outstack</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nt</span><span class="p">,</span> <span class="n">synths</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
                <span class="n">outstack</span> <span class="o">+=</span> <span class="n">synths</span><span class="p">[(</span><span class="n">k</span> <span class="o">*</span> <span class="n">nt</span><span class="p">):(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">nt</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">t7</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Stack traces time </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t7</span> <span class="o">-</span> <span class="n">t6</span><span class="p">))</span>

        <span class="c1"># get taper times for tapering data as well</span>
        <span class="n">tmins</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">taperers</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># no taper defined so return trace tmins</span>
        <span class="n">tmins</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">trc</span><span class="o">.</span><span class="n">tmin</span> <span class="k">for</span> <span class="n">trc</span> <span class="ow">in</span> <span class="n">synt_trcs</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;stacked_traces&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arrival_taper</span><span class="p">:</span>
            <span class="n">outtraces</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">oapp</span> <span class="o">=</span> <span class="n">outtraces</span><span class="o">.</span><span class="n">append</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
                <span class="n">synt_trcs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ydata</span> <span class="o">=</span> <span class="n">outstack</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">oapp</span><span class="p">(</span><span class="n">synt_trcs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">outtraces</span><span class="p">,</span> <span class="n">tmins</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;arrival taper has to be defined for </span><span class="si">%s</span><span class="s1"> type!&#39;</span> <span class="o">%</span> <span class="n">outmode</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">synt_trcs</span><span class="p">,</span> <span class="n">tmins</span>

    <span class="k">elif</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;tapered_data&#39;</span><span class="p">:</span>
        <span class="n">outlist</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">synt_trcs</span><span class="p">):</span>
            <span class="n">outlist</span><span class="p">[</span><span class="n">taper_index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outlist</span><span class="p">,</span> <span class="n">tmins</span>

    <span class="k">elif</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Returning...&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outstack</span><span class="p">,</span> <span class="n">tmins</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Outmode </span><span class="si">%s</span><span class="s1"> not supported!&#39;</span> <span class="o">%</span> <span class="n">outmode</span><span class="p">)</span></div>


<div class="viewcode-block" id="geo_synthetics"><a class="viewcode-back" href="../api.html#heart.geo_synthetics">[docs]</a><span class="k">def</span> <span class="nf">geo_synthetics</span><span class="p">(</span>
        <span class="n">engine</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;stacked_array&#39;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">nprocs</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate synthetic displacements for a given static fomosto Greens</span>
<span class="sd">    Function database for sources and targets on the earths surface.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    engine : :class:`pyrocko.gf.seismosizer.LocalEngine`</span>
<span class="sd">    sources : list</span>
<span class="sd">        containing :class:`pyrocko.gf.seismosizer.Source` Objects</span>
<span class="sd">        reference source is the first in the list!!!</span>
<span class="sd">    targets : list</span>
<span class="sd">        containing :class:`pyrocko.gf.seismosizer.Target` Objects</span>
<span class="sd">    plot : boolean</span>
<span class="sd">        flag for looking at synthetics - not implemented yet</span>
<span class="sd">    nprocs : int</span>
<span class="sd">        number of processors to use for synthetics calculation</span>
<span class="sd">        --&gt; currently no effect !!!</span>
<span class="sd">    outmode : string</span>
<span class="sd">        output format of synthetics can be: &#39;array&#39;, &#39;arrays&#39;,</span>
<span class="sd">        &#39;stacked_array&#39;,&#39;stacked_arrays&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    depends on outmode:</span>
<span class="sd">    &#39;stacked_array&#39;</span>
<span class="sd">    :class:`numpy.ndarray` (n_observations; ux-North, uy-East, uz-Down)</span>
<span class="sd">    &#39;stacked_arrays&#39;</span>
<span class="sd">    or list of</span>
<span class="sd">    :class:`numpy.ndarray` (target.samples; ux-North, uy-East, uz-Down)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stack_arrays</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">disp_arrays</span><span class="p">):</span>
        <span class="n">stacked_arrays</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sapp</span> <span class="o">=</span> <span class="n">stacked_arrays</span><span class="o">.</span><span class="n">append</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="n">sapp</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">target</span><span class="o">.</span><span class="n">lons</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">3</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ns</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">nt</span><span class="p">)</span>
                <span class="n">stacked_arrays</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="n">disp_arrays</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">stacked_arrays</span>

    <span class="n">disp_arrays</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dapp</span> <span class="o">=</span> <span class="n">disp_arrays</span><span class="o">.</span><span class="n">append</span>
    <span class="k">for</span> <span class="n">sresult</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">static_results</span><span class="p">():</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">sresult</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;displacement.n&#39;</span><span class="p">]</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">sresult</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;displacement.e&#39;</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="o">-</span><span class="n">sresult</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;displacement.d&#39;</span><span class="p">]</span>
        <span class="n">dapp</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">u</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;arrays&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">disp_arrays</span>

    <span class="k">elif</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">disp_arrays</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;stacked_arrays&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">stack_arrays</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">disp_arrays</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;stacked_array&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">stack_arrays</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">disp_arrays</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Outmode </span><span class="si">%s</span><span class="s1"> not available&#39;</span> <span class="o">%</span> <span class="n">outmode</span><span class="p">)</span></div>


<div class="viewcode-block" id="taper_filter_traces"><a class="viewcode-back" href="../api.html#heart.taper_filter_traces">[docs]</a><span class="k">def</span> <span class="nf">taper_filter_traces</span><span class="p">(</span>
        <span class="n">traces</span><span class="p">,</span> <span class="n">arrival_taper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filterer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deltat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">arrival_times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outmode</span><span class="o">=</span><span class="s1">&#39;array&#39;</span><span class="p">,</span>
        <span class="n">taper_tolerance_factor</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">chop_bounds</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Taper and filter data_traces according to given taper and filterers.</span>
<span class="sd">    Tapering will start at the given tmin.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    traces : List</span>
<span class="sd">        containing :class:`pyrocko.trace.Trace` objects</span>
<span class="sd">    arrival_taper : :class:`ArrivalTaper`</span>
<span class="sd">    filterer : list</span>
<span class="sd">        of :class:`Filterer`</span>
<span class="sd">    deltat : float</span>
<span class="sd">        if set data is downsampled to that sampling interval</span>
<span class="sd">    arrival_times : list or:class:`numpy.ndarray`</span>
<span class="sd">        containing the start times [s] since 1st.January 1970 to start</span>
<span class="sd">        tapering</span>
<span class="sd">    outmode : str</span>
<span class="sd">        defines the output structure, options: &quot;stacked_traces&quot;, &quot;array&quot;,</span>
<span class="sd">        &quot;data&quot;</span>
<span class="sd">    taper_tolerance_factor : float</span>
<span class="sd">        tolerance to chop traces around taper.a and taper.d</span>
<span class="sd">    chop_bounds : list of len 2</span>
<span class="sd">        of taper attributes a, b, c, or d</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`numpy.ndarray`</span>
<span class="sd">        with tapered and filtered data traces, rows different traces,</span>
<span class="sd">        columns temporal values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cut_traces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ctpp</span> <span class="o">=</span> <span class="n">cut_traces</span><span class="o">.</span><span class="n">append</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">traces</span><span class="p">):</span>
        <span class="n">cut_trace</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cut_trace</span><span class="o">.</span><span class="n">set_location</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">arrival_taper</span><span class="p">:</span>
            <span class="n">taper</span> <span class="o">=</span> <span class="n">arrival_taper</span><span class="o">.</span><span class="n">get_pyrocko_taper</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">arrival_times</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">taper</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Filtering, tapering, chopping ... &#39;</span>
            <span class="s1">&#39;trace_samples: </span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cut_trace</span><span class="o">.</span><span class="n">ydata</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="n">cut_trace</span> <span class="o">=</span> <span class="n">post_process_trace</span><span class="p">(</span>
            <span class="n">trace</span><span class="o">=</span><span class="n">cut_trace</span><span class="p">,</span>
            <span class="n">taper</span><span class="o">=</span><span class="n">taper</span><span class="p">,</span>
            <span class="n">filterer</span><span class="o">=</span><span class="n">filterer</span><span class="p">,</span>
            <span class="n">deltat</span><span class="o">=</span><span class="n">deltat</span><span class="p">,</span>
            <span class="n">taper_tolerance_factor</span><span class="o">=</span><span class="n">taper_tolerance_factor</span><span class="p">,</span>
            <span class="n">outmode</span><span class="o">=</span><span class="n">outmode</span><span class="p">,</span>
            <span class="n">chop_bounds</span><span class="o">=</span><span class="n">chop_bounds</span><span class="p">)</span>

        <span class="n">ctpp</span><span class="p">(</span><span class="n">cut_trace</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">snuffle</span><span class="p">(</span><span class="n">cut_traces</span> <span class="o">+</span> <span class="n">traces</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">outmode</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arrival_taper</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Returning chopped traces ...&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">ctr</span><span class="o">.</span><span class="n">ydata</span> <span class="k">for</span> <span class="n">ctr</span> <span class="ow">in</span> <span class="n">cut_traces</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Traces have different length, cannot return array!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;Cannot return array without tapering!&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cut_traces</span></div>


<div class="viewcode-block" id="velocities_from_pole"><a class="viewcode-back" href="../api.html#heart.velocities_from_pole">[docs]</a><span class="k">def</span> <span class="nf">velocities_from_pole</span><span class="p">(</span>
        <span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">plat</span><span class="p">,</span> <span class="n">plon</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">earth_shape</span><span class="o">=</span><span class="s1">&#39;ellipsoid&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return horizontal velocities at input locations for rotation around</span>
<span class="sd">    given Euler pole</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lats: :class:`numpy.NdArray`</span>
<span class="sd">        of geographic latitudes [deg] of points to calculate velocities for</span>
<span class="sd">    lons: :class:`numpy.NdArray`</span>
<span class="sd">        of geographic longitudes [deg] of points to calculate velocities for</span>
<span class="sd">    plat: float</span>
<span class="sd">        Euler pole latitude [deg]</span>
<span class="sd">    plon: float</span>
<span class="sd">        Euler pole longitude [deg]</span>
<span class="sd">    omega: float</span>
<span class="sd">        angle of rotation around Euler pole [deg / million yrs]</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`numpy.NdArray` of velocities [m / yrs] npoints x 3 (NEU)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r_earth</span> <span class="o">=</span> <span class="n">orthodrome</span><span class="o">.</span><span class="n">earthradius</span>

    <span class="k">def</span> <span class="nf">cartesian_to_local</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">):</span>
        <span class="n">rlat</span> <span class="o">=</span> <span class="n">lat</span> <span class="o">*</span> <span class="n">d2r</span>
        <span class="n">rlon</span> <span class="o">=</span> <span class="n">lon</span> <span class="o">*</span> <span class="n">d2r</span>
        <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">[</span><span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rlat</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rlon</span><span class="p">),</span> <span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rlat</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rlon</span><span class="p">),</span>
             <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rlat</span><span class="p">)],</span>
            <span class="p">[</span><span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rlon</span><span class="p">),</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rlon</span><span class="p">),</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rlat</span><span class="p">)],</span>
            <span class="p">[</span><span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rlat</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rlon</span><span class="p">),</span> <span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">rlat</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rlon</span><span class="p">),</span>
             <span class="o">-</span><span class="n">num</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">rlat</span><span class="p">)]])</span>

    <span class="n">npoints</span> <span class="o">=</span> <span class="n">lats</span><span class="o">.</span><span class="n">size</span>
    <span class="k">if</span> <span class="n">earth_shape</span> <span class="o">==</span> <span class="s1">&#39;sphere&#39;</span><span class="p">:</span>
        <span class="n">latlons</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">platlons</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">plat</span><span class="p">,</span> <span class="n">plon</span><span class="p">])</span>
        <span class="n">xyz_points</span> <span class="o">=</span> <span class="n">orthodrome</span><span class="o">.</span><span class="n">latlon_to_xyz</span><span class="p">(</span><span class="n">latlons</span><span class="p">)</span>
        <span class="n">xyz_pole</span> <span class="o">=</span> <span class="n">orthodrome</span><span class="o">.</span><span class="n">latlon_to_xyz</span><span class="p">(</span><span class="n">platlons</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">earth_shape</span> <span class="o">==</span> <span class="s1">&#39;ellipsoid&#39;</span><span class="p">:</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">orthodrome</span><span class="o">.</span><span class="n">geodetic_to_ecef</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lats</span><span class="p">))</span>
        <span class="n">xyz_points</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">num</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="n">r_earth</span>
        <span class="n">xyz_pole</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
            <span class="n">orthodrome</span><span class="o">.</span><span class="n">geodetic_to_ecef</span><span class="p">(</span><span class="n">plat</span><span class="p">,</span> <span class="n">plon</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span> <span class="o">/</span> <span class="n">r_earth</span>

    <span class="n">omega_rad_yr</span> <span class="o">=</span> <span class="n">omega</span> <span class="o">*</span> <span class="mf">1e-6</span> <span class="o">*</span> <span class="n">d2r</span> <span class="o">*</span> <span class="n">r_earth</span>
    <span class="n">xyz_poles</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">xyz_pole</span><span class="p">,</span> <span class="n">npoints</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">npoints</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">v_vecs</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">xyz_poles</span><span class="p">,</span> <span class="n">xyz_points</span><span class="p">)</span>
    <span class="n">vels_cartesian</span> <span class="o">=</span> <span class="n">omega_rad_yr</span> <span class="o">*</span> <span class="n">v_vecs</span>

    <span class="n">T</span> <span class="o">=</span> <span class="n">cartesian_to_local</span><span class="p">(</span><span class="n">lats</span><span class="p">,</span> <span class="n">lons</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk-&gt;ik&#39;</span><span class="p">,</span> <span class="n">T</span> <span class="o">*</span> <span class="n">vels_cartesian</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></div>


<div class="viewcode-block" id="get_ramp_displacement"><a class="viewcode-back" href="../api.html#heart.get_ramp_displacement">[docs]</a><span class="k">def</span> <span class="nf">get_ramp_displacement</span><span class="p">(</span><span class="n">locx</span><span class="p">,</span> <span class="n">locy</span><span class="p">,</span> <span class="n">azimuth_ramp</span><span class="p">,</span> <span class="n">range_ramp</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get synthetic residual plane in azimuth and range direction of the</span>
<span class="sd">    satellite.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    locx : shared array-like :class:`numpy.ndarray`</span>
<span class="sd">        local coordinates [km] in east direction</span>
<span class="sd">    locy : shared array-like :class:`numpy.ndarray`</span>
<span class="sd">        local coordinates [km] in north direction</span>
<span class="sd">    azimuth_ramp : :class:`theano.tensor.Tensor` or :class:`numpy.ndarray`</span>
<span class="sd">        vector with ramp parameter in azimuth</span>
<span class="sd">    range_ramp : :class:`theano.tensor.Tensor` or :class:`numpy.ndarray`</span>
<span class="sd">        vector with ramp parameter in range</span>
<span class="sd">    offset : :class:`theano.tensor.Tensor` or :class:`numpy.ndarray`</span>
<span class="sd">        scalar of offset in [m]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">locy</span> <span class="o">*</span> <span class="n">azimuth_ramp</span> <span class="o">+</span> <span class="n">locx</span> <span class="o">*</span> <span class="n">range_ramp</span> <span class="o">+</span> <span class="n">offset</span></div>


<div class="viewcode-block" id="check_problem_stores"><a class="viewcode-back" href="../api.html#heart.check_problem_stores">[docs]</a><span class="k">def</span> <span class="nf">check_problem_stores</span><span class="p">(</span><span class="n">problem</span><span class="p">,</span> <span class="n">datatypes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check GF stores for empty traces.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Checking stores for empty traces ...&#39;</span><span class="p">)</span>
    <span class="n">corrupted_stores</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="n">datatypes</span><span class="p">:</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">problem</span><span class="o">.</span><span class="n">composites</span><span class="p">[</span><span class="n">datatype</span><span class="p">]</span><span class="o">.</span><span class="n">engine</span>
        <span class="n">storeids</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_store_ids</span><span class="p">()</span>

        <span class="n">cstores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">store_id</span> <span class="ow">in</span> <span class="n">storeids</span><span class="p">:</span>
            <span class="n">store</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">get_store</span><span class="p">(</span><span class="n">store_id</span><span class="p">)</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;empty&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cstores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">store_id</span><span class="p">)</span>

            <span class="n">engine</span><span class="o">.</span><span class="n">close_cashed_stores</span><span class="p">()</span>

        <span class="n">corrupted_stores</span><span class="p">[</span><span class="n">datatype</span><span class="p">]</span> <span class="o">=</span> <span class="n">cstores</span>

    <span class="k">return</span> <span class="n">corrupted_stores</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    
<h3><a href="../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../short_installation.html">Short Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../anaconda_installation.html">Anaconda Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Detailed Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../updating.html">Updating beat</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">Getting started with BEAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
    &nbsp;
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Hannes Vasyura-Bathke.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.7.
    </div>
  </body>
</html>